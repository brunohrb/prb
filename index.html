	<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<title>PRB ‚Ä¢ Pr√≥-Labore</title>


<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
 --azul:#1f3c88;
 --bg:#f3f5f9;
 --card:#ffffff;
 --texto:#333;
 --borda:#ddd;
}
.dark{
 --bg:#0f172a;
 --card:#020617;
 --texto:#e5e7eb;
 --borda:#334155;
}
*{box-sizing:border-box}
body{
 margin:0;
 background:var(--bg);
 color:var(--texto);
 font-family:Segoe UI,Arial,sans-serif;
}
.hidden{display:none!important}
.container{
 max-width:1200px;
 margin:24px auto;
 background:var(--card);
 padding:28px;
 border-radius:22px;
 box-shadow:0 12px 30px rgba(0,0,0,.08);
}
header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:22px;
}
.brand{display:flex;align-items:center;gap:14px}
.logo{
 width:56px;height:56px;border-radius:14px;
 background:linear-gradient(135deg,var(--azul),#4f6bdc);
 color:#fff;
 display:flex;align-items:center;justify-content:center;
 font-weight:700;font-size:22px;
}
.grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:22px;
}
@media(max-width:900px){
 .grid{grid-template-columns:1fr}
}

.card{
 background:var(--card);
 border:1px solid var(--borda);
 border-radius:20px;
 padding:22px;
}
.socio{text-align:center;font-weight:700;margin-bottom:12px}
.socio span{
 border:2px solid var(--azul);
 border-radius:50px;
 padding:6px 18px;
}

input,select,button{
 padding:10px;
 font-size:14px;
 border-radius:10px;
 border:1px solid var(--borda);
 width:100%;
 background:transparent;
 color:var(--texto);
}
button{border:none;cursor:pointer}
.primary{background:var(--azul);color:#fff}
.secondary{background:#64748b;color:#fff}
.danger{background:#c0392b;color:#fff}

.linha{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:8px 0;
 border-bottom:1px dashed var(--borda);
 font-size:14px;
}
.acoes span{cursor:pointer;margin-left:10px}

.pos{color:#16a34a}
.neg{color:#dc2626}
.small{font-size:13px;color:#94a3b8}

.tabs{
 display:flex;
 gap:6px;
}
.tabs button{
 padding:8px 14px;
 border-radius:10px;
 background:#eee;
}
.tabs .active{
 background:var(--azul);
 color:#fff;
}

.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.45);
 display:flex;
 align-items:center;
 justify-content:center;
 z-index:1000;
}
.modal-box{
 background:var(--card);
 width:340px;
 padding:24px;
 border-radius:20px;
}
.toggle{cursor:pointer;font-size:18px}

/* =========================
   VISUAL MODERNO ‚Äì PRB UI
   (PATCH SEGURO)
========================= */

body{
 font-family: Inter, Segoe UI, system-ui, -apple-system, Arial, sans-serif;
}

/* Cards flutuantes */
.card{
 border:none;
 box-shadow:0 10px 30px rgba(0,0,0,.08);
 transition:transform .2s ease, box-shadow .2s ease;
}
.card:hover{
 transform:translateY(-3px);
 box-shadow:0 16px 40px rgba(0,0,0,.12);
}

/* Header mais clean */
header{
 padding-bottom:10px;
 border-bottom:1px solid rgba(0,0,0,.05);
}

/* Logo mais premium */
.logo{
 box-shadow:0 6px 16px rgba(0,0,0,.25);
}

/* Abas estilo ‚Äúpill‚Äù */
.tabs{
 background:rgba(0,0,0,.03);
 padding:6px;
 border-radius:14px;
}
.tabs button{
 background:transparent;
 border:none;
 font-weight:600;
 color:#64748b;
}
.tabs button.active{
 background:var(--azul);
 color:#fff;
 box-shadow:0 4px 12px rgba(0,0,0,.2);
}

/* Inputs mais modernos */
input,select{
 background:rgba(0,0,0,.02);
 border:none;
 border-radius:12px;
}
input:focus,select:focus{
 outline:none;
 box-shadow:0 0 0 2px rgba(31,60,136,.25);
 background:#fff;
}

/* MOBILE */
@media(max-width:700px){
 header{
  flex-direction:column;
  gap:12px;
 }
 .tabs{
  width:100%;
  overflow-x:auto;
 }
 .tabs button{
  white-space:nowrap;
 }
}

/* üëÜ O CSS NOVO TERMINA AQUI */

	button.primary,
button.secondary,
button.danger{
  background: inherit;
  color: #fff;
}

button.primary{ background: var(--azul); }
button.secondary{ background: #64748b; }
button.danger{ background: #c0392b; }

	
</style>

</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginTela">
<header class="brand">
 <div class="logo">PRB</div>
 <h2>Controle de Pr√≥-Labore</h2>
</header>
<input id="user" placeholder="Usu√°rio">
<input id="pass" type="password" placeholder="Senha">
<button class="primary" onclick="login()">Entrar</button>
</div>

<!-- APP -->
<div class="container hidden" id="app">
<header>
 <div class="brand">
  <div class="logo">PRB</div>
  <select id="mes"></select>
  <select id="ano"></select>
 </div>
 <div class="tabs">
  <button id="tabLanc" class="active" onclick="abrirAba('lanc')">Lan√ßamentos</button>
  <button id="tabInd" onclick="abrirAba('ind')">Indicadores</button>
  <button id="tabConf" onclick="abrirAba('conf')">Configura√ß√µes</button>
  <span class="toggle" onclick="toggleTema()">üåô</span>
<button id="tabLog" onclick="abrirAba('log')">Logs</button>

	 </div>

</header>

<!-- LAN√áAMENTOS -->
<div id="abaLanc">
 <div id="statusMes" class="small"></div>
 <div class="grid" id="cards"></div>
 <button class="secondary" onclick="alternarFechamento()">Fechar / Reabrir m√™s</button>
</div>

<!-- INDICADORES -->
<div id="abaInd" class="hidden">
 <h3>Indicadores por ano</h3>
 <select id="anoIndicador"></select>
 <div class="grid" id="indicadores"></div>
</div>

<!-- LOGS -->
<div id="abaLog" class="hidden">
 <h3>Log de atividades</h3>

 <div style="margin-bottom:10px" class="small">
  Mostra todas as a√ß√µes realizadas no sistema
 </div>

 <div class="card">
  <div id="listaLogs"></div>
 </div>
</div>


<!-- CONFIG -->
<div id="abaConf" class="hidden">
 <h3>Configura√ß√µes</h3>

 <label>Sal√°rio padr√£o (compet√™ncia atual)</label>
 <input id="salPadrao" oninput="mask(this)">


 <div class="grid">
  <input id="sal_paulo" placeholder="Paulo (opcional)" oninput="mask(this)">
  <input id="sal_rafael" placeholder="Rafael (opcional)" oninput="mask(this)">
  <input id="sal_bruno" placeholder="Bruno (opcional)" oninput="mask(this)">
 </div>

 <button class="primary" onclick="salvarSalarios()">Salvar sal√°rios</button>
 <hr>
<h4>Alterar minha senha</h4>
<input id="novaSenha" type="password" placeholder="Nova senha">
<button class="primary" onclick="alterarSenha()">Alterar senha</button>


<button class="secondary" onclick="gerarBackupExcel()">
  üì§ Exportar Excel
</button>

	<hr>

<button class="danger" onclick="abrirRestoreExcel()">
  ‚ôªÔ∏è Restaurar backup Excel
</button>

<input
  type="file"
  id="inputRestoreExcel"
  accept=".xlsx"
  style="display:none"
  onchange="processarRestoreExcel(event)"
>

	
</div>

<!-- MODAL -->
<div class="modal hidden" id="modal">
 <div class="modal-box">
  <h3>Editar lan√ßamento</h3>
  <input id="mdDesc">
  <input id="mdValor" oninput="mask(this)">
  <button class="primary" onclick="salvarEdicao()">Salvar</button>
  <button class="secondary" onclick="fecharModal()">Cancelar</button>
 </div>
</div>




<script>
const SUPABASE_URL = "https://xuwwgprchhfshrqdhuqn.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_HnqNNHIYrLbexVdrr-9DVA_gmprLLqe";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

	// ===== ELEMENTOS DOM (OBRIGAT√ìRIO) =====
const cards = document.getElementById("cards");
const statusMes = document.getElementById("statusMes");

const mes = document.getElementById("mes");
const ano = document.getElementById("ano");

const indicadores = document.getElementById("indicadores");
const anoIndicador = document.getElementById("anoIndicador");

const modal = document.getElementById("modal");
const mdDesc = document.getElementById("mdDesc");
const mdValor = document.getElementById("mdValor");


/* ===== DADOS ===== */
let usuarios = JSON.parse(localStorage.getItem("usuarios_prb")) || {
 admin:"admin123",
 paulo:"1234",
 rafael:"1234",
 bruno:"1234"
};

const socios=["paulo","rafael","bruno"];
	const gruposExtras = ["obras","familia"];
	const entidades = [...socios, ...gruposExtras];


const meses=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const baseInicial={mes:11,ano:2025};
let edicao=null;

let lancamentosSupabase = {};


/* ===== LOGIN ===== */
let usuarioLogado = localStorage.getItem("usuario_logado") || null;

async function login() {
  const email = document.getElementById("user").value;
  const password = document.getElementById("pass").value;

  if (!email || !password) {
    alert("Informe email e senha");
    return;
  }

  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert("Erro no login: " + error.message);
    return;
  }

  usuarioLogado = data.user.id;
  localStorage.setItem("usuario_logado", usuarioLogado);

  document.getElementById("loginTela").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  init();
}

/* ===== INIT ===== */
function init(){
  mes.innerHTML="";
  ano.innerHTML="";
  anoIndicador.innerHTML="";

  meses.forEach((m,i)=>{
    mes.innerHTML += `<option value="${i}">${m}</option>`;
  });

  let y = new Date().getFullYear();
  for(let a = 2025; a <= y + 3; a++){
    ano.innerHTML += `<option>${a}</option>`;
    anoIndicador.innerHTML += `<option>${a}</option>`;
  }

  mes.value = new Date().getMonth();
  ano.value = y;
  anoIndicador.value = y;

  mes.onchange = ano.onchange = () => {
    carregarLancamentosSupabaseSeguro().then(render);
  };

  anoIndicador.onchange = renderIndicadores;

  aplicarTema();

  // ‚¨áÔ∏è AQUI EST√Å A CHAVE
  carregarLancamentosSupabaseSeguro().then(() => {
    render();
    renderIndicadores();
  });
}


/* ===== ABAS ===== */
function abrirAba(a){
  const abas = {
    lanc: document.getElementById("abaLanc"),
    ind:  document.getElementById("abaInd"),
    conf: document.getElementById("abaConf"),
    log:  document.getElementById("abaLog")
  };

  const tabs = {
    lanc: document.getElementById("tabLanc"),
    ind:  document.getElementById("tabInd"),
    conf: document.getElementById("tabConf"),
    log:  document.getElementById("tabLog")
  };

  // esconde todas
  Object.values(abas).forEach(el => el.classList.add("hidden"));
  Object.values(tabs).forEach(el => el.classList.remove("active"));

  // mostra s√≥ a clicada
  abas[a].classList.remove("hidden");
  tabs[a].classList.add("active");

  // atualiza√ß√µes espec√≠ficas
  if(a === "ind") renderIndicadores();
  if(a === "log") renderLogs();
}


/* ===== FECHAMENTO ===== */
function chaveFechamento(){return "fechado_"+mes.value+"-"+ano.value}
function mesFechado(){return localStorage.getItem(chaveFechamento())==="1"}
function alternarFechamento(){
 if(mesFechado()) localStorage.removeItem(chaveFechamento());
 else localStorage.setItem(chaveFechamento(),"1");
 render();
}

/* ===== SAL√ÅRIO POR COMPET√äNCIA ===== */
function chaveSal(s){return "sal_"+mes.value+"-"+ano.value+"_"+s}
function salvarSalarios(){
 localStorage.setItem(chaveSal("padrao"),parseMoeda(salPadrao.value));
 socios.forEach(s=>{
  let v=document.getElementById("sal_"+s).value;
  if(v) localStorage.setItem(chaveSal(s),parseMoeda(v));
 });
 alert("Sal√°rios salvos para esta compet√™ncia");
}
function salarioBase(s){
 let m=+mes.value,a=+ano.value;
 while(a>=baseInicial.ano){
  let ks="sal_"+m+"-"+a+"_"+s;
  if(localStorage.getItem(ks)) return +localStorage.getItem(ks);
  let kp="sal_"+m+"-"+a+"_padrao";
  if(localStorage.getItem(kp)) return +localStorage.getItem(kp);
  m--; if(m<0){m=11;a--}
 }
 return 0;
}

/* ===== SALDO ===== */
function chaveSaldo(m,a,s){return "saldo_"+m+"-"+a+"_"+s}
function saldoAnterior(m,a,s){
 if(a<baseInicial.ano || (a===baseInicial.ano && m<baseInicial.mes)) return 0;
 let pm=m-1,pa=a;
 if(pm<0){pm=11;pa--}
 return Number(localStorage.getItem(chaveSaldo(pm,pa,s)))||0;
}





/* ===== RENDER ===== */
async function render(){
  cards.innerHTML="";
  let m = +mes.value, a = +ano.value;
  statusMes.innerHTML = mesFechado() ? "üîí M√™s fechado" : "üîì M√™s aberto";

  /* ===== CARDS DOS S√ìCIOS (COMPLETO, COMO J√Å ERA) ===== */
  for (const s of socios) {
    let arr = lancamentosSupabase[s] || [];
let total = arr
  .filter(l => !(l.parcelado === true && l.id_parcelamento === null))
  .reduce((x, y) => x + y.valor, 0);
    let base = salarioBase(s);

    let prev = await calcularSaldoAnteriorOnline(s, m, a);
    let saldo = base + prev - total;

    cards.innerHTML += `
    <div class="card">
      <div class="socio"><span>${s.toUpperCase()}</span></div>
      <div class="small">Sal√°rio: ${fmt(base)}</div>
      <div class="small">Saldo anterior:
        <b class="${prev>=0?'pos':'neg'}">${fmt(prev)}</b>
      </div>

${(!mesFechado() && podeLancar())?`
  <input id="d_${s}" placeholder="Descri√ß√£o">
  <input id="v_${s}" placeholder="R$ 0,00 (valor TOTAL se parcelado)" oninput="mask(this)">

  <label class="small">
    <input type="checkbox" id="p_${s}" onchange="toggleParcelado('${s}')">
    Parcelado
  </label>

  <div id="parc_${s}" class="small hidden">
    <input
      id="n_${s}"
      type="number"
      min="2"
      step="1"
      value="2"
      placeholder="N¬∫ parcelas (m√≠n. 2)"
      oninput="this.value = Math.max(2, Math.abs(parseInt(this.value) || 2))"
    >
    <input id="m_${s}" type="month">
  </div>

  <button class="primary" onclick="add('${s}')">OK</button>
`:`<div class="small">Lan√ßamentos bloqueados</div>`}

      ${arr.map((r,i)=>`
        <div class="linha">
          <div>${r.data} ‚Ä¢ ${r.desc}</div>
          <div class="${r.valor<0?'pos':'neg'}">${fmt(r.valor)}</div>
          ${(!mesFechado() && podeLancar())?`
            <div class="acoes">
              <span onclick="editar('${s}',${i})">‚úèÔ∏è</span>
              <span onclick="excluir('${s}',${i})">üóëÔ∏è</span>
            </div>`:""}
        </div>
      `).join("")}

      <div class="small">
        Total m√™s: ${fmt(total)}<br>
        Saldo final:
        <b class="${saldo>=0?'pos':'neg'}">${fmt(saldo)}</b>
      </div>
    </div>`;
  }

 /* ===== CARDS OBRAS / FAM√çLIA (COM INPUTS ‚Äì SEM SALVAR AINDA) ===== */
for (const g of gruposExtras) {

  let arr = lancamentosSupabase[g] || [];
  let total = arr.reduce((x,y)=>x+y.valor,0);

  cards.innerHTML += `
    <div class="card">
      <div class="socio"><span>${g.toUpperCase()}</span></div>

      <input id="d_${g}" placeholder="Descri√ß√£o">
      <input id="v_${g}" placeholder="R$ 0,00" oninput="mask(this)">

    <button class="primary" onclick="addGrupo('${g}')">
  OK
</button>


 ${arr.map((r,i)=>`
  <div class="linha">
    <div>${r.data} ‚Ä¢ ${r.desc}</div>

    <div style="display:flex;align-items:center;gap:10px">
      <div class="neg">${fmt(r.valor)}</div>

      ${(!mesFechado() && podeLancar()) ? `
        <div class="acoes">
          <span onclick="editar('${g}',${i})">‚úèÔ∏è</span>
          <span onclick="excluir('${g}',${i})">üóëÔ∏è</span>
        </div>
      ` : ""}
    </div>
  </div>
`).join("")}


      <div class="small">
        Total do m√™s:<br>
        <b class="neg">${fmt(total)}</b>
      </div>
    </div>
  `;
}

}


/* ===== INDICADORES ===== */
async function renderIndicadores(){
  indicadores.innerHTML = "";

  const anoSel = +anoIndicador.value;

  let totalGeral = 0;

for (const s of entidades) {

    const inicio = `${anoSel}-01-01`;
    const fim = `${anoSel}-12-31`;

    const { data, error } = await supabaseClient
      .from("lancamentos")
      .select("valor")
      .eq("socio", s)
      .gte("data", inicio)
      .lte("data", fim);

    if(error){
      console.error("Erro indicadores:", error);
      continue;
    }

const soma = data.reduce(
  (acc, l) => acc + Math.abs(Number(l.valor)),
  0
);

    totalGeral += soma;

    indicadores.innerHTML += `
      <div class="card">
        <div class="socio"><span>${s.toUpperCase()}</span></div>
        <b>Total no ano</b><br>
        ${fmt(soma)}
      </div>
    `;
  }

  indicadores.innerHTML += `
    <div class="card">
      <div class="socio"><span>TOTAL</span></div>
<b>Total geral</b><br>
      ${fmt(totalGeral)}
    </div>
  `;
}


/* ===== CRUD ===== */
function podeLancar(){
  return !mesFechado();
}

async function add(s) {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    alert("Usu√°rio n√£o autenticado");
    return;
  }

  const desc = document.getElementById("d_" + s).value;
  const valorTotal = parseMoeda(document.getElementById("v_" + s).value);
  const parcelado = document.getElementById("p_" + s)?.checked;

  if (!desc || !valorTotal) {
    alert("Preencha descri√ß√£o e valor");
    return;
  }

  // ===== N√ÉO PARCELADO =====
  if (!parcelado) {
    // Garante que a data seja salva como YYYY-MM-DD (ex: 2026-01-01)
    const dataLancamento = `${ano.value}-${String(+mes.value + 1).padStart(2, "0")}-01`;
    
    const { error } = await supabaseClient
      .from("lancamentos")
      .insert([{
        socio: s,
        descricao: desc,
        valor: valorTotal,
        data: dataLancamento,
        criado_por: user.id
      }]);

    if (error) {
      alert("Erro ao salvar lan√ßamento");
      console.error(error);
      return;
    }

    document.getElementById("d_" + s).value = "";
    document.getElementById("v_" + s).value = "";

    await carregarLancamentosSupabaseSeguro();
    render();
    renderIndicadores();
    return;
  }

  // ===== PARCELADO =====
  const parcelas = Number(document.getElementById("n_" + s).value);
  const mesIni = document.getElementById("m_" + s).value;

  if (!parcelas || parcelas < 2 || !mesIni) {
    alert("Informe n√∫mero de parcelas (m√≠n. 2) e m√™s inicial");
    return;
  }

  const [anoIni, mesIniNum] = mesIni.split("-").map(Number);
  const valorParcela = +(valorTotal / parcelas).toFixed(2);
  const idParcelamento = crypto.randomUUID();

  for (let i = 0; i < parcelas; i++) {
    // Calcula a data correta para cada parcela
    const dataObjeto = new Date(anoIni, (mesIniNum - 1) + i, 1);
    
    // Formata manualmente para evitar problemas de fuso hor√°rio do toISOString
    const y = dataObjeto.getFullYear();
    const m = String(dataObjeto.getMonth() + 1).padStart(2, "0");
    const d = "01";
    const dataFormatada = `${y}-${m}-${d}`;

    await supabaseClient
      .from("lancamentos")
      .insert([{
        socio: s,
        descricao: `${desc} (${i + 1}/${parcelas})`,
        valor: valorParcela,
        data: dataFormatada,
        parcelado: true,
        id_parcelamento: idParcelamento,
        parcela_numero: i + 1,
        criado_por: user.id
      }]);
  }

  document.getElementById("d_" + s).value = "";
  document.getElementById("v_" + s).value = "";
  document.getElementById("p_" + s).checked = false;
  document.getElementById("parc_" + s).classList.add("hidden");

  await carregarLancamentosSupabaseSeguro();
  render();
  renderIndicadores();
  alert("Parcelas geradas com sucesso!");
}
	// ===== SALVAR OBRAS / FAM√çLIA =====
async function addGrupo(grupo){

  const desc = document.getElementById("d_"+grupo).value;
  const valor = parseMoeda(document.getElementById("v_"+grupo).value);

  if(!desc || !valor){
    alert("Preencha descri√ß√£o e valor");
    return;
  }

  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user){
    alert("Usu√°rio n√£o autenticado");
    return;
  }

  const { error } = await supabaseClient
    .from("lancamentos")
    .insert([{
      socio: grupo,
      descricao: desc,
      valor: valor,
data: `${ano.value}-${String(+mes.value + 1).padStart(2,"0")}-01`,
      criado_por: user.id
    }]);

  if(error){
  alert("Erro Supabase:\n" + error.message);
  console.error("ERRO SUPABASE:", error);
  return;
}

  await registrarLog(
    "ADICIONOU",
    `${grupo.toUpperCase()} ‚Ä¢ ${desc} ‚Ä¢ ${fmt(valor)}`
  );

  document.getElementById("d_"+grupo).value = "";
  document.getElementById("v_"+grupo).value = "";

  await carregarLancamentosSupabaseSeguro();
  render();
  renderIndicadores();
}


function editar(s, i){
  const item = lancamentosSupabase[s][i];

  if(!item){
    alert("Lan√ßamento n√£o encontrado");
    return;
  }

  edicao = {
    socio: s,
    index: i,
    id: item.id,
    descAntes: item.desc,
    valorAntes: item.valor
  };

  mdDesc.value = item.desc;
  mdValor.value = fmt(item.valor);

  modal.classList.remove("hidden");
}

async function salvarEdicao(){
  const novaDesc = mdDesc.value;
  const novoValor = parseMoeda(mdValor.value);

  if(!novaDesc || !novoValor){
    alert("Preencha descri√ß√£o e valor");
    return;
  }

  // 1Ô∏è‚É£ Atualiza no Supabase
  const { error } = await supabaseClient
    .from("lancamentos")
    .update({
      descricao: novaDesc,
      valor: novoValor
    })
    .eq("id", edicao.id);

  if(error){
    alert("Erro ao atualizar lan√ßamento");
    console.error(error);
    return;
  }

  // 2Ô∏è‚É£ REGISTRA LOG DE EDI√á√ÉO (ANTES ‚Üí DEPOIS)
  await registrarLog(
    "EDITOU",
    `${edicao.socio} ‚Ä¢ ${edicao.descAntes} (${fmt(edicao.valorAntes)}) ‚Üí ${novaDesc} (${fmt(novoValor)})`
  );

  fecharModal();

  // 3Ô∏è‚É£ Recarrega tudo
  await carregarLancamentosSupabaseSeguro();
  render();
  renderIndicadores();
}

async function excluir(s, i){
  const item = lancamentosSupabase[s][i];
  if(!item) return;

  if(!confirm("Excluir lan√ßamento?")) return;

  await registrarLog(
    "EXCLUIU",
    `${s} ‚Ä¢ ${fmt(item.valor)}`
  );

  let error;

  if(item.id_parcelamento){
    ({ error } = await supabaseClient
      .from("lancamentos")
      .delete()
      .eq("id_parcelamento", item.id_parcelamento));
  } else {
    ({ error } = await supabaseClient
      .from("lancamentos")
      .delete()
      .eq("id", item.id));
  }

  if(error){
    alert("Erro ao excluir no servidor");
    console.error(error);
    return;
  }

  await carregarLancamentosSupabaseSeguro();
  render();
  renderIndicadores();
}


/* ===== MODAL ===== */
function fecharModal(){modal.classList.add("hidden")}


window.gerarBackupExcel = async function () {
  console.log("‚ñ∂ Backup Excel iniciado");

  try {
    if (typeof XLSX === "undefined") {
      alert("Biblioteca XLSX n√£o carregada");
      return;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      alert("Usu√°rio n√£o autenticado");
      return;
    }

    const { data, error } = await supabaseClient
      .from("lancamentos")
.select("id, socio, data, descricao, valor, parcelado, id_parcelamento")
      .order("data", { ascending: true });

    if (error) {
      console.error(error);
      alert("Erro ao buscar dados");
      return;
    }

    const dadosExcel = data.map(l => ({
      ID: l.id,
      Socio: l.socio,
Data: new Date(l.data).toISOString().slice(0,10),
      Descricao: l.descricao,
      Valor: l.valor
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(dadosExcel);
    XLSX.utils.book_append_sheet(wb, ws, "Lancamentos");

    const nome = `PRB_Backup_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, nome);

    alert("Backup Excel gerado com sucesso!");

  } catch (err) {
    console.error("Erro no backup Excel:", err);
    alert("Erro ao gerar backup (veja o console)");
  }
};


/* ===== TEMA ===== */
function toggleTema(){
 document.body.classList.toggle("dark");
 localStorage.setItem("tema",document.body.classList.contains("dark")?"dark":"light");
}
function aplicarTema(){
 if(localStorage.getItem("tema")==="dark") document.body.classList.add("dark");
}

/* ===== UTIL ===== */
function parseMoeda(v){
 let neg=v.includes("-");
 let n=Number(v.replace(/[^\d]/g,""))/100||0;
 return neg?-n:n;
}
function fmt(v){return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
function mask(el){el.value=fmt(parseMoeda(el.value))}

async function registrarLog(acao, detalhes){
  const user = (await supabaseClient.auth.getUser()).data.user;

  if(!user) return;

  const { error } = await supabaseClient
    .from("logs")
    .insert([{
      usuario: user.id,
      usuario_nome: user.email,
      acao,
      detalhes
    }]);

  if(error){
    console.error("Erro ao salvar log:", error);
  }
}

async function alterarSenha(){
  const nova = document.getElementById("novaSenha").value;

  if(!nova || nova.length < 6){
    alert("A nova senha deve ter pelo menos 6 caracteres");
    return;
  }

  const { error } = await supabaseClient.auth.updateUser({
    password: nova
  });

  if(error){
    alert("Erro ao alterar senha: " + error.message);
    console.error(error);
    return;
  }

  await registrarLog(
    "ALTEROU SENHA",
    "Usu√°rio alterou a pr√≥pria senha"
  );

  alert("Senha alterada com sucesso!");
  document.getElementById("novaSenha").value = "";
}


async function renderLogs(){
  const lista = document.getElementById("listaLogs");
  lista.innerHTML = "";

  const { data, error } = await supabaseClient
    .from("logs")
    .select("*")
    .order("criado_em", { ascending: false })
    .limit(100);

  if(error){
    lista.innerHTML = "<div class='small'>Erro ao carregar logs.</div>";
    console.error(error);
    return;
  }

  if(data.length === 0){
    lista.innerHTML = "<div class='small'>Nenhuma a√ß√£o registrada.</div>";
    return;
  }

  data.forEach(l => {
    lista.innerHTML += `
      <div class="linha">
        <div>
          <b>${l.usuario_nome || l.usuario}</b> ‚Ä¢ ${l.acao}<br>
          <span class="small">${l.detalhes}</span>
        </div>
        <div class="small">
          ${new Date(l.criado_em).toLocaleString("pt-BR")}
        </div>
      </div>
    `;
  });
}



async function salvarLancamentoSupabase(lancamento){
  const { error } = await supabaseClient
    .from("lancamentos")
    .insert([lancamento]);

  if(error){
    console.error("Erro Supabase:", error);
    alert("Erro ao salvar no servidor");
    return false;
  }
  return true;
}

async function carregarLancamentosSupabaseSeguro() {
  let m = +mes.value;
  let a = +ano.value;

  // Define o intervalo exato do m√™s selecionado (YYYY-MM-DD)
  const inicio = `${a}-${String(m + 1).padStart(2, "0")}-01`;
  
  // Calcula o √∫ltimo dia do m√™s
  const ultimoDia = new Date(a, m + 1, 0).getDate();
  const fim = `${a}-${String(m + 1).padStart(2, "0")}-${ultimoDia}`;

  const { data, error } = await supabaseClient
    .from("lancamentos")
    .select("id, socio, data, descricao, valor, parcelado, id_parcelamento")
    .gte("data", inicio)
    .lte("data", fim);

  if (error) {
    console.error("Erro ao ler Supabase:", error);
    lancamentosSupabase = {};
    return;
  }

  lancamentosSupabase = {};
  entidades.forEach(e => lancamentosSupabase[e] = []);

  data.forEach(l => {
    // Ignora lan√ßamento pai se houver
    if (l.parcelado === true && l.id_parcelamento === null) return;

    // IMPORTANTE: Tratar a data vinda do banco para evitar deslocamento de fuso hor√°rio
    // Como salvamos YYYY-MM-DD, pegamos apenas os primeiros 10 caracteres
    const dataString = l.data.substring(0, 10);
    const [anoDb, mesDb, diaDb] = dataString.split("-");

    lancamentosSupabase[l.socio].push({
      id: l.id,
      id_parcelamento: l.id_parcelamento || null,
      data: `${diaDb}/${mesDb}`, // Exibe apenas Dia/M√™s
      desc: l.descricao,
      valor: Number(l.valor)
    });
  });

  console.log("Dados filtrados para o m√™s:", lancamentosSupabase);
}

async function saldoAnteriorOnline(socio, mes, ano){
  // soma todas as retiradas ANTES deste m√™s
  const fim = `${ano}-${String(mes+1).padStart(2,"0")}-01`;

  const { data, error } = await supabaseClient
    .from("lancamentos")
    .select("valor")
    .eq("socio", socio)
    .lt("data", fim);

  if(error){
    console.error("Erro saldo anterior:", error);
    return 0;
  }

  const totalRetirado = data.reduce((soma, l) => soma + Number(l.valor), 0);

  // sal√°rio mensal * n√∫mero de meses trabalhados
  // por enquanto usamos sal√°rioBase
  const salarioMes = salarioBase(socio);

  // conta quantos meses j√° passaram desde o in√≠cio
  const mesesTrabalhados =
    (ano - baseInicial.ano) * 12 + (mes - baseInicial.mes);

  const salarioAcumulado = salarioMes * mesesTrabalhados;

  return salarioAcumulado - totalRetirado;
}

async function calcularSaldoAnteriorOnline(socio, mes, ano){
  // limite = primeiro dia do m√™s atual
  const limite = `${ano}-${String(mes+1).padStart(2,"0")}-01`;

  // 1Ô∏è‚É£ soma TODAS as retiradas at√© o m√™s anterior
  const { data, error } = await supabaseClient
    .from("lancamentos")
    .select("valor")
    .eq("socio", socio)
    .lt("data", limite);

  if (error) {
    console.error("Erro saldo anterior:", error);
    return 0;
  }

  const totalRetirado = data.reduce(
    (soma, l) => soma + Number(l.valor),
    0
  );

  // 2Ô∏è‚É£ sal√°rio mensal fixo
  const salarioMensal = salarioBase(socio);

  // 3Ô∏è‚É£ c√°lculo CORRETO de meses decorridos (m√™s absoluto)
  const mesAtualAbs = ano * 12 + mes;
  const mesInicialAbs = baseInicial.ano * 12 + baseInicial.mes;

  const mesesDecorridos = mesAtualAbs - mesInicialAbs;

  const totalSalarios = salarioMensal * mesesDecorridos;

  return totalSalarios - totalRetirado;
}



	async function testeLog(){
  const { error } = await supabaseClient
    .from("logs")
    .insert([{
      usuario: usuarioLogado,
      acao: "TESTE",
      detalhes: "Log manual de teste"
    }]);

  if(error){
    alert("Erro log: " + error.message);
    console.error(error);
  } else {
    alert("LOG INSERIDO COM SUCESSO");
  }
}


	function abrirRestoreExcel(){
  if(!confirm("ATEN√á√ÉO: isso ir√° importar dados do Excel para o sistema.\n\nDeseja continuar?")){
    return;
  }
  document.getElementById("inputRestoreExcel").click();
}

	async function processarRestoreExcel(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = async function(e){
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });

      const sheetName = "Lancamentos";
      if(!workbook.Sheets[sheetName]){
        alert("A planilha precisa ter uma aba chamada 'Lancamentos'");
        return;
      }

      const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

      if(rows.length === 0){
        alert("A planilha n√£o possui lan√ßamentos");
        return;
      }

      // valida colunas m√≠nimas
      const colunasObrigatorias = ["Socio", "Data", "Descricao", "Valor"];
      const colunasArquivo = Object.keys(rows[0]);

      const faltando = colunasObrigatorias.filter(
        c => !colunasArquivo.includes(c)
      );

      if(faltando.length){
        alert("Colunas ausentes: " + faltando.join(", "));
        return;
      }

      if(!confirm(`Foram encontrados ${rows.length} lan√ßamentos.\n\nDeseja importar agora?`)){
        return;
      }

      await importarLancamentosExcel(rows);

    } catch(err){
      console.error(err);
      alert("Erro ao ler o arquivo Excel");
    }
  };

  reader.readAsArrayBuffer(file);
}

	async function importarLancamentosExcel(rows){
  let inseridos = 0;
  let erros = 0;

  for(const r of rows){

    const socio = String(r.Socio).trim().toLowerCase();

if(!entidades.includes(socio)){
      console.warn("S√≥cio inv√°lido:", r.Socio);
      erros++;
      continue;
    }

    const dataISO = String(r.Data).trim();

    if(!/^\d{4}-\d{2}-\d{2}$/.test(dataISO)){
      console.warn("Data inv√°lida:", r.Data);
      erros++;
      continue;
    }

    const lancamento = {
      socio,
      descricao: String(r.Descricao).trim(),
      valor: Number(r.Valor),
      data: dataISO
    };

    const { error } = await supabaseClient
      .from("lancamentos")
      .insert([lancamento]);

    if(error){
      console.error("Erro ao importar:", error, lancamento);
      erros++;
      continue;
    }

    inseridos++;
  }

  alert(
    `Importa√ß√£o finalizada.\n\n` +
    `Inseridos: ${inseridos}\n` +
    `Ignorados: ${erros}`
  );

  await registrarLog(
    "RESTAURACAO",
    `Importados ${inseridos} lan√ßamentos via Excel`
  );

  await carregarLancamentosSupabaseSeguro();
  render();
  renderIndicadores();
}


	function toggleParcelado(s) {
  const chk = document.getElementById("p_" + s);
  const box = document.getElementById("parc_" + s);
  if (chk && box) {
    box.classList.toggle("hidden", !chk.checked);
  }
}


	function somarMes(ano, mes, qtd) {
  const d = new Date(ano, mes + qtd, 1);
  return {
    ano: d.getFullYear(),
    mes: d.getMonth()
  };
}

	
	
</script>

</body>
</html>



























