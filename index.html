
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandeira Stay Manager</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

 
    <style>:root{--primary-color:#2d7a7a;--primary-dark:#1a4d4d;--accent-color:#d4a574;--text-dark:#333;--text-light:#666;--bg-light:#f5f5f5;--bg-white:#fff;--border-color:#e0e0e0;--red:#dc3545;--green:#28a745}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--bg-light);color:var(--text-dark)}.container{display:flex;min-height:100vh}.sidebar{width:260px;background:linear-gradient(180deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:white;padding:24px 0;position:fixed;height:100vh;overflow-y:auto;z-index:100}.logo{display:flex;align-items:center;gap:12px;padding:0 24px 24px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:24px}.menu-item{padding:12px 24px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;font-size:14px}.menu-item:hover{background:rgba(255,255,255,.1)}.menu-item.active{background:rgba(255,255,255,.15);border-left:3px solid var(--accent-color)}.main{margin-left:260px;flex:1;padding:32px;width:calc(100% - 260px)}.page{display:none}.page.active{display:block}.page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}.page-header h2{font-size:28px;color:var(--primary-dark);font-weight:700}.card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:24px}.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary-dark);color:white}.btn-primary:hover{background:var(--primary-color)}.btn-secondary{background:var(--accent-color);color:white}.btn-link{background:none;color:var(--text-light);font-weight:500}.upload-area{border:2px dashed var(--primary-color);border-radius:12px;padding:48px;text-align:center;cursor:pointer}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}.form-input,.form-select{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px}.flex{display:flex}.gap-16{gap:16px}.flex-1{flex:1}.filter-bar{display:flex;flex-wrap:wrap;gap:16px;align-items:center}.select2-container{width:100%!important}.select2-container .select2-selection--multiple{border:1px solid var(--border-color)!important;padding:6px!important;border-radius:8px!important;min-height:48px}.indicadores-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* üëà for√ßa 5 cards na mesma linha */
    gap: 12px;
    margin-bottom: 24px;
}
.indicador-card {
    background: var(--bg-white);
    border-radius: 10px;
    padding: 14px 16px;   /* üëà menor */
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
}
.indicador-card.clickable{cursor:pointer;transition:transform .2s,box-shadow .2s}.indicador-card.clickable:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.08)}.indicador-label{font-size:13px;color:var(--text-light);margin-bottom:4px;text-transform:uppercase;font-weight:600}.indicador-valor{font-size:26px;font-weight:700;color:var(--primary-dark)}.indicador-valor.red{color:var(--red)}.indicador-valor.green{color:var(--green)}.indicador-chart{height:200px;margin-top:16px}.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse;font-size:14px}th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;   /* üëà ISSO resolve */
}
th{background-color:#f8f9fa;font-weight:600;text-transform:uppercase;font-size:12px}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}.modal-overlay.active{display:flex}.modal-content{background:var(--bg-white);padding:32px;border-radius:12px;width:90%;max-width:500px}.unidade-grupo{border-top:3px solid var(--primary-dark);margin-top:16px;padding-top:0}.unidade-header{background:rgba(45,122,122,0.08);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;transition:background 0.2s;border-radius:8px 8px 0 0}.unidade-header:hover{background:rgba(45,122,122,0.12)}.unidade-nome{font-weight:700;color:var(--primary-dark);font-size:15px;display:flex;align-items:center;gap:10px}.unidade-toggle{font-size:18px;transition:transform 0.2s}.unidade-toggle.collapsed{transform:rotate(-90deg)}.unidade-conteudo{display:block}.unidade-conteudo.collapsed{display:none}.unidade-conteudo table{margin-top:0;border-radius:0 0 8px 8px}.filter-ano-pequeno{display:flex;gap:8px;align-items:center;margin-bottom:16px}.filter-ano-pequeno select{width:150px;padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px}.analitica-filtros{display:flex;gap:16px;align-items:center;margin-bottom:24px;flex-wrap:wrap}.analitica-filtros select{padding:10px 12px;border:1px solid var(--border-color);border-radius:6px;font-size:14px}.analitica-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}.analitica-card{background:var(--bg-white);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.analitica-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.analitica-card-icon{font-size:32px}.analitica-card-title{font-size:14px;color:var(--text-light);text-transform:uppercase;font-weight:600}.analitica-card-value{font-size:28px;font-weight:700;color:var(--primary-dark);margin-top:8px}.analitica-card-value.green{color:var(--green)}.analitica-card-value.red{color:var(--red)}.analitica-card-chart{height:150px;margin-top:16px}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 24px;
}

.logo-mark {
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-title {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.logo-sub {
    font-size: 12px;
    opacity: 0.7;
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* üì± MOBILE FIRST ‚Äî at√© tablets */
@media (max-width: 768px) {

    /* layout geral */
    .container {
        flex-direction: column;
    }

    .main {
        margin-left: 0;
        width: 100%;
        padding: 16px;
    }

    /* sidebar vira topo */
    .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        padding: 12px 0;
    }

    .menu-item {
        padding: 14px 20px;
        font-size: 16px;
    }

    /* cards */
    .indicadores-grid,
    .analitica-cards {
        grid-template-columns: 1fr;
    }

    /* bot√µes grandes para toque */
    .btn {
        width: 100%;
        justify-content: center;
    }

    .flex.gap-16 {
        flex-direction: column;
    }

    /* modais */
    .modal-content {
        width: 95%;
        padding: 20px;
    }

    /* tabelas */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        font-size: 13px;
    }

    th, td {
        padding: 10px;
    }
}

.menu-toggle {
    display: none;
    font-size: 24px;
    padding: 0 24px 12px;
    cursor: pointer;
}

@media (max-width: 768px) {
    .menu-toggle {
        display: block;
    }

    .sidebar .menu-item {
        display: none;
    }

    .sidebar.open .menu-item {
        display: flex;
    }
}

@media (max-width: 768px) {
    table th:first-child,
    table td:first-child {
        position: sticky;
        left: 0;
        background: white;
        z-index: 2;
        font-weight: 600;
    }
}

.btn-outline {
    background: white;
    color: var(--primary-dark);
    border: 1px solid var(--border-color);
}

.btn-outline:hover {
    background: #f8f9fa;
}

.btn-outline-secondary {
    background: white;
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
}

.btn-outline-secondary:hover {
    background: rgba(212,165,116,0.1);
}

.btn-outline-secondary:hover {
    background: rgba(212,165,116,0.1);
}

/* Anima√ß√µes para notifica√ß√µes */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 4px 12px rgba(45, 122, 122, 0.3);
    }
    50% {
        box-shadow: 0 4px 24px rgba(45, 122, 122, 0.6);
    }
}

</style>

</style>
</head>
<body>
<body>
    <!-- üîê TELA DE LOGIN -->
    <div id="telaLogin" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #2d7a7a 0%, #1a4d4d 100%);">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); width: 100%; max-width: 400px;">
            <h2 style="text-align: center; color: #2d7a7a; margin-bottom: 10px;">üè† Bandeira Stay</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 14px;">Sistema de Gest√£o</p>
            
            <div style="margin-bottom: 30px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Senha de Acesso</label>
                <input type="password" id="loginSenha" placeholder="Digite a senha"
                       style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;"
                       onkeypress="if(event.key==='Enter') fazerLogin()">
            </div>
            
            <button onclick="fazerLogin()" 
                    style="width: 100%; padding: 14px; background: #2d7a7a; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s;"
                    onmouseover="this.style.background='#1a4d4d'" 
                    onmouseout="this.style.background='#2d7a7a'">
                Entrar
            </button>
            
            <div id="loginErro" style="margin-top: 15px; padding: 12px; background: #fee; border-left: 3px solid #dc3545; color: #dc3545; border-radius: 4px; display: none; font-size: 14px;"></div>
        </div>
    </div>

    <div class="container" id="sistemaCompleto" style="display: none;">
        <div class="sidebar">
   <!-- ‚ò∞ BOT√ÉO MOBILE -->
    <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
<div class="logo">
    <div class="logo-mark">
        <svg width="48" height="48" viewBox="0 0 64 64" fill="none"
             xmlns="http://www.w3.org/2000/svg">
            <!-- Casa -->
            <path d="M16 30L32 18L48 30V48H16V30Z"
                  stroke="white" stroke-width="3" fill="none"/>
            <path d="M28 48V36H36V48"
                  stroke="white" stroke-width="3"/>

            <!-- Coqueiro -->
            <path d="M22 18C18 10 12 8 10 8"
                  stroke="white" stroke-width="3"
                  stroke-linecap="round"/>
            <path d="M22 18C16 16 12 18 10 20"
                  stroke="white" stroke-width="3"
                  stroke-linecap="round"/>
        </svg>
    </div>

    <div class="logo-text">
        <div class="logo-title">Bandeira</div>
        <div class="logo-sub">Beach House</div>
    </div>
</div>
            <div class="menu-item active" onclick="showPage('financeiro', this)">üí∞ Financeiro</div>
            <div class="menu-item" onclick="showPage('analitica', this)">üìä Anal√≠tica</div>
            <div class="menu-item" onclick="showPage('despesas', this)">üí∏ Despesas</div>
            <div class="menu-item" onclick="showPage('reservas', this)">üßπ Reservas Futuras</div>
            <div class="menu-item" onclick="showPage('proprietarios', this)">üë§ Propriet√°rios</div>
            <div class="menu-item" onclick="showPage('configuracoes', this)">‚öôÔ∏è Configura√ß√µes</div>
            <div class="menu-item" onclick="showPage('upload', this)">üì§ Upload de Dados</div>
            <div class="menu-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">üö™ Sair</div>
        </div>



        <div class="main">
          <div id="financeiro" class="page">
    <div class="page-header">
        <h2>Financeiro</h2>
        <div style="display:flex;gap:12px;">
            <button class="btn btn-link" onclick="fazerBackupExcel()">üíæ Backup</button>
            <button class="btn btn-link" onclick="document.getElementById('restaurarBackupInput').click()">üì• Restaurar</button>
            <input type="file" id="restaurarBackupInput" accept=".xlsx,.xls" style="display:none" onchange="restaurarBackupExcel(this.files[0])">
        </div>
    </div>
    
    <div class="card filter-bar">
        <div class="form-group flex-1"><select id="filtroAnos" class="form-select" multiple="multiple"></select></div>
        <div class="form-group flex-1"><select id="filtroMeses" class="form-select" multiple="multiple"></select></div>
        <div class="form-group flex-1"><select id="filtroUnidades" class="form-select" multiple="multiple"></select></div>
        <button class="btn btn-primary" onclick="renderViews()">Aplicar</button>
    </div>
    
    <div class="flex gap-16" style="margin-bottom: 24px;">
        <button class="btn btn-primary" id="btn-view-cards" onclick="setViewMode('cards')">üìä Cards</button>
        <button class="btn btn-secondary" id="btn-view-lista" onclick="setViewMode('lista')">üìÑ Lista</button>
        <button class="btn btn-outline" onclick="atualizarDoSmoobuViaDownload()">üîÑ Smoobu</button>
        <button class="btn btn-outline-secondary" onclick="openUploadManualModal()">Movi</button>
    </div>
    
    <div id="view-cards"><div id="indicadores-gerais" class="indicadores-grid"></div></div>
    <div id="view-lista" style="display: none;">
        <div id="indicadores-lista" class="indicadores-grid"></div>
        <div class="card"><div id="tabela-lista-financeira"></div></div>
    </div>
</div>


            <div id="analitica" class="page">
                <div class="page-header"><h2>Anal√≠tica</h2></div>
                <div class="card filter-bar">
                    <div class="form-group flex-1"><select id="filtroAnaliticaAnos" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaMeses" class="form-select" multiple="multiple"></select></div>
                    <div class="form-group flex-1"><select id="filtroAnaliticaUnidades" class="form-select" multiple="multiple"></select></div>
                    <button class="btn btn-primary" onclick="renderAnalitica()">Aplicar</button>
                </div>
                <div class="analitica-cards">
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí∞</div>
                            <div class="analitica-card-title">Receita</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-receita">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-receita"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üì¶</div>
                            <div class="analitica-card-title">Reservas</div>
                        </div>
                        <div class="analitica-card-value" id="analitica-reservas">0</div>
                        <div class="analitica-card-chart"><canvas id="chart-reservas"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí≥</div>
                            <div class="analitica-card-title">Comiss√£o</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-comissao">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-comissao-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üí∏</div>
                            <div class="analitica-card-title">Despesas</div>
                        </div>
                        <div class="analitica-card-value red" id="analitica-despesas">-R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-despesas-card"></canvas></div>
                    </div>
                    <div class="analitica-card">
                        <div class="analitica-card-header">
                            <div class="analitica-card-icon">üìà</div>
                            <div class="analitica-card-title">Lucro L√≠quido</div>
                        </div>
                        <div class="analitica-card-value green" id="analitica-lucro">R$ 0,00</div>
                        <div class="analitica-card-chart"><canvas id="chart-lucro"></canvas></div>
                    </div>

<div class="analitica-card">
    <div class="analitica-card-header">
        <div class="analitica-card-icon">üé´</div>
        <div class="analitica-card-title">Ticket M√©dio</div>
    </div>
    <div class="analitica-card-value green" id="analitica-ticket">R$ 0,00</div>
</div>

                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Receita por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-receita-unidade"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Comiss√£o Portais por Unidade</h3>
                    <div style="height:300px;"><canvas id="chart-comissao"></canvas></div>
                </div>
            </div>


            <div id="despesas" class="page">
    <div class="page-header">
        <h2>Detalhes das Despesas</h2>
        <button class="btn btn-primary" onclick="openDespesaModal()">+ Nova Despesa</button>
    </div>

    <!-- üîé FILTRO DAS DESPESAS -->
    <div class="card filter-bar">
        <div class="form-group flex-1">
            <select id="filtroDespesasAnos" class="form-select" multiple></select>
        </div>

        <div class="form-group flex-1">
            <select id="filtroDespesasMeses" class="form-select" multiple></select>
        </div>

        <div class="form-group flex-1">
            <select id="filtroDespesasUnidades" class="form-select" multiple></select>
        </div>

        <button class="btn btn-primary" onclick="renderTabelaDespesasDetalhada()">
            Aplicar
        </button>
    </div>

    <div class="card">
        <div class="table-container">
            <table id="tabela-despesas-detalhada"></table>
        </div>
    </div>
</div>

            <div id="reservas" class="page">
                <div class="page-header"><h2>Gerador de Mensagem para Limpeza</h2></div>
                <div class="card"><div class="upload-area" onclick="document.getElementById('reservasFileInput').click()"><input type="file" id="reservasFileInput" accept=".xlsx,.xls" onchange="processarReservasFuturas(this.files[0])"><div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div><h3>Selecione o arquivo de reservas futuras</h3></div></div>
                <div id="reservasPreview" style="display:none;"><div class="card"><div class="form-group"><label class="form-label">N√∫mero WhatsApp (com DDD)</label><input type="tel" id="whatsappLimpeza" class="form-input" placeholder="5585999999999"></div></div><div class="card"><h3>Preview da Mensagem</h3><pre id="mensagemPreview" style="background: #f5f5f5; padding: 20px; border-radius: 8px;"></pre><button class="btn btn-primary" style="margin-top: 16px;" onclick="enviarWhatsApp()">üì± Enviar via WhatsApp</button></div></div>
            </div>
            <div id="proprietarios" class="page">
                <div class="page-header"><h2>Gest√£o de Propriet√°rios</h2></div>
                <div class="card"><div id="proprietarios-list"></div><button class="btn btn-primary" style="margin-top: 16px;" onclick="salvarProprietarios()">Salvar Altera√ß√µes</button></div>
            </div>
<div id="configuracoes" class="page">
                <div class="page-header"><h2>‚öôÔ∏è Configura√ß√µes</h2></div>
                
                <div class="card">
                    <h3 style="margin-bottom: 20px;">üîê Alterar Senha de Acesso</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Senha Atual</label>
                        <input type="password" id="senhaAtual" class="form-input" placeholder="Digite a senha atual">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nova Senha</label>
                        <input type="password" id="senhaNova" class="form-input" placeholder="Digite a nova senha">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirmar Nova Senha</label>
                        <input type="password" id="senhaConfirma" class="form-input" placeholder="Confirme a nova senha">
                    </div>
                    
                    <button class="btn btn-primary" onclick="alterarSenha()">Salvar Nova Senha</button>
                </div>
                
            </div>
<div id="upload" class="page">
    <div class="page-header"><h2>Upload de Dados</h2></div>
    
    <div class="card">
        <h3 style="margin-bottom:16px;">üìÑ Importar Reservas (Smoobu)</h3>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="processarEAdicionarDados(this.files[0])" style="display:none">
            <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
            <h3>Selecione o arquivo de RESERVAS</h3>
            <p>A receita ser√° contabilizada pela data de CHEGADA.</p>
        </div>
    </div>
    
    <div class="card">
        <h3 style="margin-bottom:16px;">üìä Importar Financeiro (Movi)</h3>
        <div class="upload-area" onclick="document.getElementById('uploadManualFile2').click()">
            <input type="file" id="uploadManualFile2" accept=".xlsx,.xls,image/*" style="display:none" onchange="processarUploadManual(this.files[0])">
            <div style="font-size: 48px; margin-bottom: 16px;">üí∞</div>
            <h3>Selecione o arquivo financeiro</h3>
            <p>Arquivo mensal com Valor, Taxa App e Taxa Short Stay</p>
        </div>
    </div>
</div>
    <div id="despesaModal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-header"><h3>Adicionar Nova Despesa</h3><button style="background:none; border:none; font-size: 24px; cursor:pointer;" onclick="closeDespesaModal()">&times;</button></div>
            <div class="form-group"><label class="form-label">Unidade</label><select id="despesaUnidade" class="form-select"></select></div>
            <div class="form-group"><label class="form-label">Descri√ß√£o</label><input type="text" id="despesaDescricao" class="form-input"></div>
            <div class="form-group">
    <label class="form-label" style="display:flex;justify-content:space-between;align-items:center;">
        Categoria
        <button type="button" class="btn btn-link" onclick="openCategoriaModal()">‚öôÔ∏è</button>
    </label>
    <select id="despesaCategoria" class="form-select"></select>
</div>

            <div class="form-group"><label class="form-label">Data</label><input type="date" id="despesaData" class="form-input"></div>
            <div class="form-group">
    <label class="form-label">Valor</label>
    <input
    type="text"
    id="despesaValor"
    class="form-input"
    placeholder="R$ 0,00"
    oninput="formatarValorBR(this)">

</div>

            <button class="btn btn-primary" style="width: 100%;" onclick="salvarDespesa()">Salvar Despesa</button>
        </div>
    </div>

<!-- MODAL DE CATEGORIAS -->
<div id="categoriaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="page-header">
            <h3>Categorias de Despesa</h3>
            <button style="background:none;border:none;font-size:24px;cursor:pointer;"
                    onclick="closeCategoriaModal()">&times;</button>
        </div>

        <div class="form-group">
            <input type="text" id="novaCategoria" class="form-input" placeholder="Nova categoria">
            <button class="btn btn-primary"
                    style="margin-top:10px;width:100%;"
                    onclick="addCategoria()">Adicionar</button>
        </div>

        <div id="listaCategorias"></div>
    </div>
</div>

<!-- MODAL UPLOAD MANUAL -->
<div id="uploadManualModal" class="modal-overlay">
    <div class="modal-content">

        <div class="page-header">
            <h3>Upload Manual ‚Äì Movi</h3>
            <button style="background:none;border:none;font-size:24px;cursor:pointer;"
                    onclick="closeUploadManualModal()">&times;</button>
        </div>

        <!-- ‚ö†Ô∏è AVISO IMPORTANTE -->
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <div style="display: flex; align-items: start; gap: 12px;">
                <div style="font-size: 24px;">‚ö†Ô∏è</div>
                <div>
                    <strong style="color: #856404; display: block; margin-bottom: 5px;">Aten√ß√£o:</strong>
                    <p style="color: #856404; margin: 0; font-size: 14px;">
                        Fa√ßa apenas o upload do ano <strong><span id="anoAtualMovi">2026</span></strong> completo.
                        <br>Os dados deste ano ser√£o substitu√≠dos pelos novos.
                    </p>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Unidade</label>
            <input type="text"
                   class="form-input"
                   value="Movi"
                   disabled>
        </div>

        <div class="form-group">
            <label class="form-label">Arquivo financeiro</label>
            <div class="upload-area"
                 onclick="document.getElementById('uploadManualFile').click()">

                <input type="file"
                       id="uploadManualFile"
                       accept=".xlsx,.xls,image/*"
                       style="display:none"
                       onchange="processarUploadManual(this.files[0])">

                <div style="font-size:48px;margin-bottom:16px;">üìÑ</div>
                <h3>Selecionar arquivo</h3>
                <p>Arquivo mensal com Valor, Taxa App e Taxa Short Stay</p>
            </div>
        </div>

    </div>
</div>
<script>
// ========================================
// üîê AUTENTICA√á√ÉO
// ========================================

// Verifica se j√° est√° logado
window.addEventListener('load', () => {
    const logado = sessionStorage.getItem('autenticado');
    if (logado === 'true') {
        mostrarSistema();
    }
});

async function fazerLogin() {
    const senha = document.getElementById('loginSenha').value;
    
    if (!senha) {
        mostrarErro('Digite a senha');
        return;
    }
    
    try {
        // Busca senha do banco
        const { data, error } = await db
            .from('configuracao')
            .select('senha_hash')
            .eq('id', 1)
            .single();
        
        if (error) {
            console.error('Erro ao buscar senha:', error);
            mostrarErro('Erro ao verificar senha');
            return;
        }
        
        // Compara senha
        if (senha === data.senha_hash) {
            sessionStorage.setItem('autenticado', 'true');
            mostrarSistema();
        } else {
            mostrarErro('Senha incorreta');
            document.getElementById('loginSenha').value = '';
            document.getElementById('loginSenha').focus();
        }
        
    } catch (err) {
        console.error('Erro no login:', err);
        mostrarErro('Erro ao fazer login');
    }
}

function mostrarErro(msg) {
    const erroDiv = document.getElementById('loginErro');
    erroDiv.textContent = '‚ùå ' + msg;
    erroDiv.style.display = 'block';
    setTimeout(() => {
        erroDiv.style.display = 'none';
    }, 3000);
}

function mostrarSistema() {
    document.getElementById('telaLogin').style.display = 'none';
    document.getElementById('sistemaCompleto').style.display = 'flex';
    
    // Carrega sistema normalmente
    carregarReservasSupabase().then(() => {
        showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
        setViewMode("cards");
        
        // üîÑ VERIFICA SE PRECISA ATUALIZAR DO SMOOBU
        verificarAtualizacaoAutomatica();
    });
}
function logout() {
    sessionStorage.removeItem('autenticado');
    location.reload();
}

// ========================================
// ===== 1Ô∏è‚É£ CONFIGURA√á√ÉO SUPABASE =====
const db = window.supabase.createClient(
    "https://vzdxhxbevewmbdnmetrj.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6ZHhoeGJldmV3bWJkbm1ldHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTI4MTgsImV4cCI6MjA4MzY2ODgxOH0.XRWZ66NkqYFM8qWPwBQD5D1veokAuNaWMSwjbG1a5RE"
);

// ===== 2Ô∏è‚É£ VARI√ÅVEIS GLOBAIS =====
let CACHE_RESERVAS = null;
let chartsAnalitica = {};
let currentViewMode = "cards";
let CACHE_DESPESAS = null;
const DB_RESERVAS = "DB_RESERVAS";
const DB_DESPESAS = "DB_DESPESAS";
const DB_PROPRIETARIOS = "DB_PROPRIETARIOS";
const DB_CATEGORIAS = "DB_CATEGORIAS";
let despesaEmEdicao = null;

// ===== 3Ô∏è‚É£ FUN√á√ïES B√ÅSICAS =====
function getDb(key) {
    try {
        return JSON.parse(localStorage.getItem(key)) || [];
    } catch (e) {
        console.error("Erro ao ler DB:", key, e);
        return [];
    }
}

function saveDb(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

function formatCurrency(valor) {
    const numero = Number(valor) || 0;
    const abs = Math.abs(numero);
    const formatado = abs.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
    });
    return numero < 0 ? `-${formatado}` : formatado;
}


// ===== 4Ô∏è‚É£ FUN√á√ïES SUPABASE =====

async function salvarDespesaSupabase(despesa) {
    try {
        console.log("üíæ Salvando despesa no Supabase...", despesa);

        // 1Ô∏è‚É£ Buscar unidade_id
        const { data: unidade, error: errUn } = await db
            .from("unidades")
            .select("id")
            .eq("nome", despesa.unidade)
            .single();

        if (errUn || !unidade) {
            throw new Error("Unidade n√£o encontrada: " + despesa.unidade);
        }

        // 2Ô∏è‚É£ Buscar categoria_id
        const { data: categoria, error: errCat } = await db
            .from("categorias_despesas")
            .select("id")
            .eq("nome", despesa.categoria)
            .single();

        if (errCat || !categoria) {
            throw new Error("Categoria n√£o encontrada: " + despesa.categoria);
        }

        // 3Ô∏è‚É£ Inserir despesa
        const { error: errInsert } = await db
            .from("despesas")
            .insert({
                unidade_id: unidade.id,
                categoria_id: categoria.id,
                descricao: despesa.descricao,
                data: despesa.data,
                valor: despesa.valor
            });

        if (errInsert) {
            throw errInsert;
        }

        console.log("‚úÖ Despesa salva no Supabase com sucesso");
        return true;

    } catch (err) {
        console.error("‚ùå Erro ao salvar despesa no Supabase:", err);
        return false;
    }
}


async function carregarReservasSupabase() {
    try {
        console.log("üîÑ Carregando do Supabase...");
        
        let todasReservas = [];
        let inicio = 0;
        const limite = 1000;
        let temMais = true;

        while (temMais) {
            const { data, error } = await db
                .from("reservas")
.select(`
                    id_reserva,
                    ano,
                    mes,
                    mes_ano,
                    receita,
                    comissao_portais,
                    comissao_short_stay,
                    status,
                    unidades!inner (nome)
                `)
                .range(inicio, inicio + limite - 1);

            if (error) {
                console.error("‚ùå Erro Supabase:", error);
                console.log("üíæ Usando localStorage");
                CACHE_RESERVAS = getDb(DB_RESERVAS);
                return;
            }

            if (!data || data.length === 0) {
                temMais = false;
            } else {
                todasReservas.push(...data);
                inicio += limite;
                
                if (data.length < limite) {
                    temMais = false;
                }
            }
        }

        console.log(`üåê ${todasReservas.length} reservas carregadas do Supabase`);
        
CACHE_RESERVAS = todasReservas.map(r => ({
            idReserva: r.id_reserva,
            unidade: r.unidades.nome,
            ano: r.ano,
            mes: r.mes,
            mesAno: r.mes_ano,
            receita: r.receita,
            comissao: r.comissao_portais,
            comissaoShortStay: r.comissao_short_stay,
            comissaoPortais: r.comissao_portais,
            status: r.status || 'ativa'  // üî• NOVO
        }));

    } catch (err) {
        console.error("üí• Erro:", err);
        console.log("üíæ Usando localStorage");
        CACHE_RESERVAS = getDb(DB_RESERVAS);
    }
}
async function salvarReservasNoSupabase(reservas) {
    try {
        console.log("üîÑ Salvando no Supabase...");

        const unidadesUnicas = [...new Set(reservas.map(r => r.unidade))];

        // 1Ô∏è‚É£ Cria/atualiza unidades
        for (const nome of unidadesUnicas) {
            await db.from("unidades").upsert({ nome }, { onConflict: 'nome' });
        }

        // 2Ô∏è‚É£ Busca IDs das unidades
        const { data: unidades, error: errUn } = await db
            .from("unidades")
            .select("id, nome");

        if (errUn) throw new Error("Erro ao buscar unidades: " + errUn.message);

        const mapaUnidades = {};
        unidades.forEach(u => { mapaUnidades[u.nome] = u.id; });

        // 3Ô∏è‚É£ **CR√çTICO**: Apaga TODAS as reservas dessas unidades + meses
        console.log("üóëÔ∏è Apagando reservas existentes...");
        
        // Agrupa por unidade + m√™s
        const unidadesMeses = {};
        reservas.forEach(r => {
            const chave = `${r.unidade}|${r.mesAno}`;
            if (!unidadesMeses[chave]) {
                unidadesMeses[chave] = {
                    unidade_id: mapaUnidades[r.unidade],
                    mes_ano: r.mesAno
                };
            }
        });
        
        // Apaga cada combina√ß√£o unidade+m√™s
        for (const chave in unidadesMeses) {
            const { unidade_id, mes_ano } = unidadesMeses[chave];
            
            const { error: delErr } = await db
                .from("reservas")
                .delete()
                .eq('unidade_id', unidade_id)
                .eq('mes_ano', mes_ano);
            
            if (delErr) {
                console.error(`Erro ao apagar ${chave}:`, delErr);
            } else {
                console.log(`‚úÖ Apagadas reservas de ${chave}`);
            }
        }

        // 4Ô∏è‚É£ Prepara dados para inser√ß√£o
        const paraInserir = reservas.map(r => ({
            id_reserva: r.idReserva,
            unidade_id: mapaUnidades[r.unidade],
            ano: r.ano,
            mes: r.mes,
            mes_ano: r.mesAno,
            receita: r.receita,
            comissao_portais: r.comissao ?? 0,
            comissao_short_stay: r.comissaoShortStay ?? 0,
            status: r.status || 'ativa'
        })).filter(r => r.unidade_id);

        if (paraInserir.length === 0) {
            console.log("‚ö†Ô∏è Nenhuma reserva v√°lida para inserir");
            return;
        }

        // 5Ô∏è‚É£ Insere novas reservas
        const { error: insertErr } = await db
            .from("reservas")
            .insert(paraInserir);

        if (insertErr) {
            throw new Error("Erro ao inserir: " + insertErr.message);
        }

        console.log(`‚úÖ ${paraInserir.length} reservas processadas com sucesso`);

    } catch (err) {
        console.error("‚ùå Erro ao salvar no Supabase:", err);
        throw err;
    }
}

function parseNumeroBR(valor) {
    if (valor === null || valor === undefined) return 0;
    if (typeof valor === "number") return valor;
    if (typeof valor === "string") {
        return parseFloat(
            valor.replace(/\./g, "")
                 .replace(",", ".")
                 .replace(/[^\d.-]/g, "")
        ) || 0;
    }
    return 0;
}


// ===== 5Ô∏è‚É£ FUN√á√ïES DE PARSING =====
function parseDataBR(valor) {
    if (!valor) return null;
    
    // üü¢ Se vier como Date do Excel
    if (valor instanceof Date && !isNaN(valor)) {
        const ano = valor.getFullYear();
        const mes = String(valor.getMonth() + 1).padStart(2, "0");
        return { 
            ano: String(ano), 
            mes: mes, 
            mesAno: `${ano}-${mes}` 
        };
    }
    
    // üü° Se vier como texto "dd/mm/yy" ou "dd/mm/yyyy"
    if (typeof valor === "string") {
        const partes = valor.split("/");
        if (partes.length !== 3) return null;
        
        let dia = partes[0].padStart(2, "0");
        let mes = partes[1].padStart(2, "0");
        let ano = partes[2];
        
        // üî• CORRE√á√ÉO: converte ano de 2 d√≠gitos corretamente
        if (ano.length === 2) {
            const anoNum = parseInt(ano, 10);
            // Se for 00-49, considera 2000-2049
            // Se for 50-99, considera 1950-1999
            ano = anoNum < 50 ? `20${ano}` : `19${ano}`;
        }
        
        return { 
            ano: ano, 
            mes: mes, 
            mesAno: `${ano}-${mes}` 
        };
    }
    
    return null;
}


        function showPage(e,a){
            document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),
            document.querySelectorAll(".menu-item").forEach(e=>e.classList.remove("active")),
            document.getElementById(e).classList.add("active"),
            a&&a.classList.add("active"),
        "analitica"===e&&(setupAnaliticaFilters(),renderAnalitica()),
            "despesas"===e && (setupFiltrosDespesas(), renderTabelaDespesasDetalhada())
,

            "proprietarios"===e&&renderProprietarios()
        }

        function setViewMode(e){
            currentViewMode=e,
            document.getElementById("view-cards").style.display="cards"===e?"block":"none",
            document.getElementById("view-lista").style.display="lista"===e?"block":"none",
            document.getElementById("btn-view-cards").classList.toggle("btn-primary","cards"===e),
            document.getElementById("btn-view-cards").classList.toggle("btn-secondary","cards"!==e),
            document.getElementById("btn-view-lista").classList.toggle("btn-primary","lista"===e),
            document.getElementById("btn-view-lista").classList.toggle("btn-secondary","lista"!==e),
            renderViews()
        }
        

// üÜï Processa formato Bruno (planilha personalizada)
function processarFormatoBruno(workbook) {
    const reservas = [];
    for (const sheetName of workbook.SheetNames) {
        const sheet = workbook.Sheets[sheetName];
        const linhas = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
        
        let unidadeNome = sheetName.match(/Lista de reservas\s+(.+)/i)?.[1]?.trim() || sheetName;
        let mesAnoAtual = null;
        let contador = 0;
        
        for (const linha of linhas) {
            if (!linha || !linha[0]) continue;
            if (linha[0] === 'Per√≠odo' || linha[0] === 'Periodo') continue;
            
            // Detecta data do m√™s
            let data = linha[0] instanceof Date ? linha[0] : 
                      typeof linha[0] === 'string' && linha[0].match(/^\d{4}-\d{2}-\d{2}/) ? new Date(linha[0]) : null;
            
            if (data && !isNaN(data)) {
                mesAnoAtual = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                contador = 0;
                continue;
            }
            
            if (!mesAnoAtual || typeof linha[1] !== 'number' || linha[1] <= 0) continue;
            
            contador++;
            const taxaApp = typeof linha[2] === 'number' ? linha[2] : 0;
            const taxaShort = typeof linha[3] === 'string' ? linha[1] * 0.10 : (typeof linha[3] === 'number' ? linha[3] : 0);
            
            reservas.push({
                idReserva: `${unidadeNome.replace(/\s+/g, '_')}_${mesAnoAtual}_${contador}`,
                unidade: unidadeNome,
                ano: mesAnoAtual.substring(0, 4),
                mes: mesAnoAtual.substring(5, 7),
                mesAno: mesAnoAtual,
                receita: linha[1],
                comissao: taxaApp,
                comissaoPortais: taxaApp,
                comissaoShortStay: taxaShort,
                status: 'ativa'
            });
        }
    }
    return reservas;
}

 async function processarEAdicionarDados(e) {
    if (!e) return;

    // üîÑ Mostra tela de loading
    mostrarLoading("Lendo arquivo...");

    const reader = new FileReader();

    reader.onload = async function (evt) {
        try {
            atualizarLoading("Processando dados do Excel...", 20);

            const workbook = XLSX.read(
                new Uint8Array(evt.target.result),
                { type: "array" }
            );

     // üîç Detecta formato da planilha
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const linhasExcel = XLSX.utils.sheet_to_json(sheet);
            
            const primeiraLinha = linhasExcel[0] || {};
            const colunas = Object.keys(primeiraLinha);
            const isFormatoBruno = colunas.includes('Per√≠odo') || colunas.includes('Periodo') || colunas.includes('Valor ') || colunas.includes('Valor');

            atualizarLoading("Analisando reservas...", 40);

            let reservasNovas = [];
            
            if (isFormatoBruno) {
                console.log("üîµ Formato Bruno detectado!");
                reservasNovas = processarFormatoBruno(workbook);
            } else {
                console.log("üü¢ Formato Smoobu detectado!");
                reservasNovas = linhasExcel.map(linha => {
                    const idReserva = linha["Posi√ß√£o"];
                    if (!idReserva) return null;
                    const data = parseDataBR(linha.Chegada || linha["Check-in"]);
                    if (!data) return null;
                    const preco = parseFloat(linha.Pre√ßo || linha.Price || 0);
                    const comissao = parseFloat(linha["Comiss√£o inclu√≠da"] || 0);
                    const estado = String(linha["Estado"] || linha["Status"] || "").toLowerCase();
                    const cancelada = estado.includes("cancelad");
                    if (cancelada) console.log(`üî¥ Cancelada: ${idReserva} - ${linha.Alojamento}`);
                    const nomeUnidade = (linha.Alojamento || linha.Accommodation || "N/A").trim();
                    return {
                        idReserva: String(idReserva).trim(),
                        unidade: nomeUnidade,
                        ano: data.ano,
                        mes: data.mes,
                        mesAno: data.mesAno,
                        receita: preco,
                        comissao: comissao,
                        comissaoPortais: comissao,
                        comissaoShortStay: 0,
                        status: cancelada ? "cancelada" : "ativa"
                    };
                }).filter(Boolean);
            }
            if (reservasNovas.length === 0) {
                esconderLoading();
                alert("‚ö†Ô∏è Nenhuma reserva v√°lida encontrada.");
                return;
            }

            atualizarLoading("Verificando reservas existentes...", 60);

            // üîç Busca reservas existentes no Supabase
            const { data: existentes, error } = await db
                .from("reservas")
                .select("id, id_reserva, status");

            if (error) throw error;

            // üìä Monta mapa de reservas existentes
            const mapaExistentes = {};
            existentes.forEach(r => {
                mapaExistentes[r.id_reserva] = {
                    id: r.id,
                    status: r.status || 'ativa'
                };
            });

            atualizarLoading("Aplicando regras de neg√≥cio...", 80);

            // üìà Estat√≠sticas
            const stats = {
                novas: 0,
                repetidas: 0,
                canceladas: 0,
                atualizadas: 0
            };

            const paraInserir = [];
            const paraAtualizar = [];
            const detalhes = [];

            // üî• APLICAR REGRAS
            for (const reserva of reservasNovas) {
                const existe = mapaExistentes[reserva.idReserva];

                if (!existe) {
                    // ‚úÖ NOVA RESERVA - insere normalmente
                    paraInserir.push(reserva);
                    stats.novas++;
                    
                    if (reserva.status === 'cancelada') {
                        stats.canceladas++;
                        detalhes.push(`üî¥ Nova cancelada: ${reserva.idReserva} (${reserva.unidade})`);
                    } else {
                        detalhes.push(`‚úÖ Nova ativa: ${reserva.idReserva} (${reserva.unidade})`);
                    }

                } else {
                    // üîç J√Å EXISTE NO SISTEMA
                    const statusAtual = existe.status;
                    const statusNovo = reserva.status;

                    if (statusAtual === 'ativa' && statusNovo === 'ativa') {
                        // üìã ATIVA ‚Üí ATIVA: n√£o faz nada
                        stats.repetidas++;
                        detalhes.push(`‚ö™ J√° existe (mantida): ${reserva.idReserva}`);

                    } else if (statusAtual === 'ativa' && statusNovo === 'cancelada') {
                        // ‚ùå ATIVA ‚Üí CANCELADA: atualiza status
                        paraAtualizar.push({
                            id: existe.id,
                            status: 'cancelada'
                        });
                        stats.canceladas++;
                        stats.atualizadas++;
                        detalhes.push(`üî¥ Cancelada: ${reserva.idReserva} (${reserva.unidade})`);

                    } else if (statusAtual === 'cancelada' && statusNovo === 'ativa') {
                        // üîÑ CANCELADA ‚Üí ATIVA: reativa
                        paraAtualizar.push({
                            id: existe.id,
                            status: 'ativa',
                            receita: reserva.receita,
                            comissao_portais: reserva.comissaoPortais
                        });
                        stats.atualizadas++;
                        detalhes.push(`üîÑ Reativada: ${reserva.idReserva} (${reserva.unidade})`);

                    } else {
                        // üìã CANCELADA ‚Üí CANCELADA: n√£o faz nada
                        stats.repetidas++;
                        detalhes.push(`‚ö™ J√° cancelada: ${reserva.idReserva}`);
                    }
                }
            }

            atualizarLoading("Salvando no banco de dados...", 90);

            // üíæ Insere novas
            if (paraInserir.length > 0) {
                await salvarReservasNoSupabase(paraInserir);
            }

            // üîÑ Atualiza existentes
            if (paraAtualizar.length > 0) {
                for (const reserva of paraAtualizar) {
                    await db
                        .from("reservas")
                        .update(reserva)
                        .eq('id', reserva.id);
                }
            }

            atualizarLoading("Recarregando dados...", 95);

            // üîÑ Recarrega do Supabase
            await carregarReservasSupabase();
            await carregarDespesasSupabase();
            setupFilters();
            renderViews();

            atualizarLoading("Conclu√≠do!", 100);
            
            // üìä Mostra relat√≥rio
            setTimeout(() => {
                esconderLoading();
                mostrarRelatorio(stats, detalhes, reservasNovas.length);
            }, 500);

        } catch (err) {
            esconderLoading();
            console.error(err);
            alert("‚ùå Erro ao processar arquivo: " + err.message);
        }
    };

    reader.readAsArrayBuffer(e);
}

function setupFilters() {
    const reservas = CACHE_RESERVAS || [];
    const despesas = CACHE_DESPESAS || [];

    const dados = [
        ...reservas.map(r => ({
            mesAno: r.mesAno,
            unidade: r.unidade
        })),
        ...despesas.map(d => ({
            mesAno: d.mesAno,
            unidade: d.unidade
        }))
    ];

    if (dados.length === 0) {
        console.log("‚ö†Ô∏è Nenhum dado para filtros");
        return;
    }


    const anos = [...new Set(dados.map(e => e.mesAno.substring(0, 4)))].sort();
    const meses = [...new Set(dados.map(e => e.mesAno.substring(5, 7)))].sort();
    const unidades = [...new Set(dados.map(e => e.unidade))].sort();

    console.log("üìä Filtros:", { anos, meses, unidades });

    const selAno = document.getElementById("filtroAnos");
    const selMes = document.getElementById("filtroMeses");
    const selUn = document.getElementById("filtroUnidades");

    const nomesMeses = {
        "01": "Janeiro", "02": "Fevereiro", "03": "Mar√ßo", "04": "Abril",
        "05": "Maio", "06": "Junho", "07": "Julho", "08": "Agosto",
        "09": "Setembro", "10": "Outubro", "11": "Novembro", "12": "Dezembro"
    };

    selAno.innerHTML = anos.map(a => `<option value="${a}">${a}</option>`).join("");
    selMes.innerHTML = meses.map(m => `<option value="${m}">${nomesMeses[m]}</option>`).join("");
    selUn.innerHTML = unidades.map(u => `<option value="${u}">${u}</option>`).join("");

    const anoAtual = new Date().getFullYear().toString();
    if (anos.includes(anoAtual)) {
        $("#filtroAnos").val([anoAtual]);
    }

    $("#filtroAnos").trigger("change");
    $("#filtroMeses").trigger("change");
    $("#filtroUnidades").trigger("change");
}


        
      function setupAnaliticaFilters() {
    const dados = CACHE_RESERVAS || getDb(DB_RESERVAS);

    if (dados.length === 0) {
        console.log("‚ö†Ô∏è Nenhuma reserva para anal√≠tica");
        return;
    }

    const unidades = [...new Set(dados.map(e => e.unidade))].sort();
    const anos = [...new Set(dados.map(e => e.mesAno.substring(0, 4)))].sort();

    const meses = [
        { id: "01", text: "Janeiro" }, { id: "02", text: "Fevereiro" },
        { id: "03", text: "Mar√ßo" }, { id: "04", text: "Abril" },
        { id: "05", text: "Maio" }, { id: "06", text: "Junho" },
        { id: "07", text: "Julho" }, { id: "08", text: "Agosto" },
        { id: "09", text: "Setembro" }, { id: "10", text: "Outubro" },
        { id: "11", text: "Novembro" }, { id: "12", text: "Dezembro" }
    ];

    $("#filtroAnaliticaUnidades").empty().select2({ 
        data: unidades, 
        placeholder: "Todos os alojamentos" 
    });

    $("#filtroAnaliticaAnos").empty().select2({ 
        data: anos, 
        placeholder: "Todos os anos" 
    });

    $("#filtroAnaliticaMeses").empty().select2({ 
        data: meses, 
        placeholder: "Todos os meses" 
    });

    const anoAtual = new Date().getFullYear().toString();
    if (anos.includes(anoAtual)) {
        $("#filtroAnaliticaAnos").val([anoAtual]).trigger("change");
    }
}

        
     function renderAnalitica() {
    try {
        let anosVal = $("#filtroAnaliticaAnos").val();
        let mesesVal = $("#filtroAnaliticaMeses").val();
        let unidadesVal = $("#filtroAnaliticaUnidades").val();

        const anos = Array.isArray(anosVal) ? anosVal : (anosVal ? [anosVal] : []);
        const meses = Array.isArray(mesesVal) ? mesesVal : (mesesVal ? [mesesVal] : []);
        const unidades = Array.isArray(unidadesVal) ? unidadesVal : (unidadesVal ? [unidadesVal] : []);

        const passaNosFiltros = (registro, campoData) => {
            if (!registro || !registro[campoData]) return false;
            const ano = registro[campoData].substring(0, 4);
            const mes = registro[campoData].substring(5, 7);
            const unidade = registro.unidade;

            const passaAno = (anos.length === 0 || anos.includes(ano));
            const passaMes = (meses.length === 0 || meses.includes(mes));
            const passaUnidade = (unidades.length === 0 || unidades.includes(unidade));

            return passaAno && passaMes && passaUnidade;
        };

        const reservas = (CACHE_RESERVAS || []).filter(e => passaNosFiltros(e, "mesAno"));
        const despesas = (CACHE_DESPESAS || []).filter(e => passaNosFiltros(e, "mesAno"));
        
        // üî• Separa ativas e canceladas (CORRE√á√ÉO DO BUG)
        const reservasAtivas = reservas.filter(r => {
            const status = (r.status || '').toLowerCase();
            return status !== 'cancelada' && status !== 'canceled';
        });
        const reservasCanceladas = reservas.filter(r => {
            const status = (r.status || '').toLowerCase();
            return status === 'cancelada' || status === 'canceled';
        });

        const receita = reservasAtivas.reduce((acc, e) => acc + e.receita, 0);
        const comissaoPortais = reservasAtivas.reduce((acc, e) => acc + (e.comissaoPortais ?? e.comissao ?? 0), 0);
        const comissaoShort = reservasAtivas.reduce((acc, e) => acc + (e.comissaoShortStay ?? 0), 0);
        const comissao = comissaoPortais + comissaoShort;
        
        const despesasTotal = despesas.reduce((acc, e) => acc + e.valor, 0);
        const lucro = receita - comissao - despesasTotal;

        document.getElementById("analitica-receita").textContent = formatCurrency(receita);
        document.getElementById("analitica-reservas").textContent = reservasAtivas.length;
        document.getElementById("analitica-comissao").textContent = "-" + formatCurrency(comissao);
        document.getElementById("analitica-despesas").textContent = "-" + formatCurrency(despesasTotal);
        document.getElementById("analitica-lucro").textContent = formatCurrency(lucro);
        document.getElementById("analitica-lucro").className = lucro >= 0 ? "analitica-card-value green" : "analitica-card-value red";
        
        const ticketMedio = reservasAtivas.length > 0 ? receita / reservasAtivas.length : 0;
        document.getElementById("analitica-ticket").textContent = formatCurrency(ticketMedio);

        renderAnaliticaCharts(reservasAtivas, despesas, anos, meses, unidades);

    } catch (err) {
        console.error("Erro em renderAnalitica:", err);
    }
}

        
        function renderAnaliticaCharts(reservas,despesas,anos,meses,unidades){
            Object.values(chartsAnalitica).forEach(chart=>{
                if(chart)chart.destroy();
            });
            chartsAnalitica={};
            
           const mapaMeses = {
    "01": "Jan", "02": "Fev", "03": "Mar", "04": "Abr",
    "05": "Mai", "06": "Jun", "07": "Jul", "08": "Ago",
    "09": "Set", "10": "Out", "11": "Nov", "12": "Dez"
};

const mesesComDados = {};
reservas.forEach(r => {
    const mes = r.mesAno.substring(5,7);
    if (!mesesComDados[mes]) mesesComDados[mes] = 0;
    mesesComDados[mes] += r.receita;
});

const mesesLabels = Object.keys(mesesComDados).sort();
const receitaPorMes = mesesLabels.map(m => mesesComDados[m]);

const labelsFormatados = mesesLabels.map(m => mapaMeses[m]);

            
            const ctxReceita=document.getElementById("chart-receita").getContext("2d");
            chartsAnalitica.receita=new Chart(ctxReceita,{
                type:"line",
                data:{
labels: mesesLabels,

                    datasets:[{
                        label:"Receita",
                        data:receitaPorMes,
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxReservas=document.getElementById("chart-reservas").getContext("2d");
            chartsAnalitica.reservas=new Chart(ctxReservas,{
                type:"doughnut",
                data:{
                    labels:["Reservas","Canceladas"],
                    datasets:[{
                        data:[reservas.length,0],
                        backgroundColor:["#2d7a7a","#dc3545"],
                        borderColor:["#1a4d4d","#c82333"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
            
            const ctxComissaoCard=document.getElementById("chart-comissao-card").getContext("2d");
            chartsAnalitica.comissaoCard=new Chart(ctxComissaoCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Comiss√£o",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                        }),
                        borderColor:"#dc3545",
                        backgroundColor:"rgba(220,53,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxDespesasCard=document.getElementById("chart-despesas-card").getContext("2d");
            chartsAnalitica.despesasCard=new Chart(ctxDespesasCard,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Despesas",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            return despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                        }),
                        borderColor:"#ffc107",
                        backgroundColor:"rgba(255,193,7,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const ctxLucro=document.getElementById("chart-lucro").getContext("2d");
            chartsAnalitica.lucro=new Chart(ctxLucro,{
                type:"line",
                data:{
                    labels:mesesLabels,
                    datasets:[{
                        label:"Lucro",
                        data:mesesLabels.map((m,i)=>{
                            const mesStr=String(i+1).padStart(2,"0");
                            const rec=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.receita,0);
                            const com=reservas.filter(e=>e.mesAno.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.comissao,0);
                            const des=despesas.filter(e=>e.data.substring(5,7)===mesStr).reduce((acc,e)=>acc+e.valor,0);
                            return rec-com-des;
                        }),
                        borderColor:"#28a745",
                        backgroundColor:"rgba(40,167,69,0.1)",
                        borderWidth:2,
                        fill:true,
                        tension:0.4
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const unidadesUnicas=[...new Set(reservas.map(e=>e.unidade))];
            const receitaPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.receita,0));
            
            const ctxUnidade=document.getElementById("chart-receita-unidade").getContext("2d");
            chartsAnalitica.unidade=new Chart(ctxUnidade,{
                type:"bar",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        label:"Receita por Unidade",
                        data:receitaPorUnidade,
                        backgroundColor:"#2d7a7a",
                        borderColor:"#1a4d4d",
                        borderWidth:1
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
            });
            
            const comissaoPorUnidade=unidadesUnicas.map(u=>reservas.filter(e=>e.unidade===u).reduce((acc,e)=>acc+e.comissao,0));
            
            const ctxComissao=document.getElementById("chart-comissao").getContext("2d");
            chartsAnalitica.comissao=new Chart(ctxComissao,{
                type:"pie",
                data:{
                    labels:unidadesUnicas,
                    datasets:[{
                        data:comissaoPorUnidade,
                        backgroundColor:["#2d7a7a","#d4a574","#dc3545","#28a745","#ffc107","#17a2b8"],
                        borderColor:["#1a4d4d","#b8864f","#c82333","#1e7e34","#e0a800","#0c5460"],
                        borderWidth:2
                    }]
                },
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
            });
        }
        
      async function renderViews() {
    try {
        let anosVal = $("#filtroAnos").val();
        let mesesVal = $("#filtroMeses").val();
        let unidadesVal = $("#filtroUnidades").val();

        const anos = Array.isArray(anosVal) ? anosVal : (anosVal ? [anosVal] : []);
        const meses = Array.isArray(mesesVal) ? mesesVal : (mesesVal ? [mesesVal] : []);
        const unidades = Array.isArray(unidadesVal) ? unidadesVal : (unidadesVal ? [unidadesVal] : []);

        const passaNosFiltros = (registro, campoData) => {
            if (!registro || !registro[campoData]) return false;
            const ano = registro[campoData].substring(0, 4);
            const mes = registro[campoData].substring(5, 7);
            const unidade = registro.unidade;

            const passaAno = (anos.length === 0 || anos.includes(ano));
            const passaMes = (meses.length === 0 || meses.includes(mes));
            const passaUnidade = (unidades.length === 0 || unidades.includes(unidade));

            return passaAno && passaMes && passaUnidade;
        };

        // ===== CORRE√á√ÉO PRINCIPAL AQUI =====
        // Garante que tanto reservas quanto despesas usem o cache global atualizado
        const reservas = (CACHE_RESERVAS || []).filter(e => passaNosFiltros(e, "mesAno"));
        const despesas = (CACHE_DESPESAS || []).filter(e => passaNosFiltros(e, "mesAno"));
        // =====================================

        if (currentViewMode === "cards") {
            renderCardsView(reservas, despesas);
        } else {
            // Para a 'lista', precisamos passar os filtros originais tamb√©m
            renderListaView(reservas, despesas, unidades, anos, meses);
        }
    } catch (err) {
        console.error("Erro em renderViews:", err);
        alert("Erro ao processar filtros: " + err.message);
    }
}


  function renderCardsView(e, a) {
    // üî• Separa ativas e canceladas (CORRE√á√ÉO DO BUG)
    // 1Ô∏è‚É£ Todas as reservas ativas (inclui R$ 0 / propriet√°rios)
    const reservasTotais = e.filter(r => {
        const status = (r.status || '').toLowerCase();
        return status !== 'cancelada' && status !== 'canceled';
    });

    // 2Ô∏è‚É£ Apenas reservas com valor financeiro
    const reservasValidas = reservasTotais.filter(
        r => Number(r.receita) > 0
    );

    // Canceladas
    const reservasCanceladas = e.filter(r => {
        const status = (r.status || '').toLowerCase();
        return status === 'cancelada' || status === 'canceled';
    });
    
    const t = reservasValidas.reduce((acc, x) => acc + x.receita, 0);

    const comissaoPortais = reservasValidas.reduce(
        (acc, x) => acc + (x.comissaoPortais ?? x.comissao ?? 0), 0
    );

    const comissaoShort = reservasValidas.reduce(
        (acc, x) => acc + (x.comissaoShortStay ?? 0), 0
    );

    const r = a.reduce((acc, x) => acc + x.valor, 0);
    const o = t - comissaoPortais - comissaoShort - r;

    document.getElementById("indicadores-gerais").innerHTML = `
        <div class="indicador-card">
            <div class="indicador-label">Receita Total</div>
            <div class="indicador-valor green">${formatCurrency(t)}</div>
        </div>

        <div class="indicador-card">
            <div class="indicador-label">Reservas</div>
            <div class="indicador-valor">
                ${reservasValidas.length}
            </div>
            <div style="font-size:12px;color:#666;margin-top:4px;">
                Total: ${reservasTotais.length}
            </div>
        </div>

        <div class="indicador-card">
            <div class="indicador-label">Comiss√£o Portais</div>
            <div class="indicador-valor red">-${formatCurrency(comissaoPortais)}</div>
        </div>

        <div class="indicador-card">
            <div class="indicador-label">Comiss√£o Short Stay</div>
            <div class="indicador-valor red">-${formatCurrency(comissaoShort)}</div>
        </div>

        <div class="indicador-card">
            <div class="indicador-label">Cancelamentos</div>
            <div class="indicador-valor red">${reservasCanceladas.length}</div>
        </div>

        <div class="indicador-card clickable"
             onclick="showPage('despesas', document.querySelector('.menu-item[onclick*=\\'despesas\\']'))">
            <div class="indicador-label">Despesas</div>
            <div class="indicador-valor red">-${formatCurrency(r)}</div>
        </div>

        <div class="indicador-card">
            <div class="indicador-label">Lucro L√≠quido</div>
            <div class="indicador-valor ${o >= 0 ? 'green' : 'red'}">
                ${formatCurrency(o)}
            </div>
        </div>
    `;
}

        
 function renderListaView(e,a,t,s,r){
    const o=document.getElementById("tabela-lista-financeira");
    
    // üî• Separa ativas e canceladas (CORRE√á√ÉO DO BUG)
    const reservasAtivas = e.filter(r => {
        const status = (r.status || '').toLowerCase();
        return status !== 'cancelada' && status !== 'canceled';
    });
    const reservasCanceladas = e.filter(r => {
        const status = (r.status || '').toLowerCase();
        return status === 'cancelada' || status === 'canceled';
    });
    
    // üè¢ ORDEM PERSONALIZADA DAS UNIDADES
    const ordemDesejada = ["103", "201", "Movi", "102", "2.7", "2.5", "104"];
    const unidadesExistentes = [...new Set((CACHE_RESERVAS || getDb(DB_RESERVAS)).map(r => r.unidade))];
    
    const n = unidadesExistentes.sort((u1, u2) => {
        const idx1 = ordemDesejada.findIndex(o => u1.includes(o));
        const idx2 = ordemDesejada.findIndex(o => u2.includes(o));
        if (idx1 !== -1 && idx2 !== -1) return idx1 - idx2;
        if (idx1 !== -1) return -1;
        if (idx2 !== -1) return 1;
        return u1.localeCompare(u2);
    });

    const l=1===s.length?s[0]:(new Date).getFullYear().toString(),
          d=r.length>0?r.sort():["01","02","03","04","05","06","07","08","09","10","11","12"],
          i=["Receita Total","Comiss√£o Portais","Despesas","Lucro"];
    
    // üî• USA APENAS RESERVAS ATIVAS (SEM CANCELADAS)
    const receitaTotal=reservasAtivas.reduce((acc,item)=>acc+item.receita,0);
    const comissaoPortais = reservasAtivas.reduce((acc,item)=>acc+(item.comissaoPortais ?? item.comissao ?? 0), 0);
    const comissaoShort = reservasAtivas.reduce((acc,item)=>acc+(item.comissaoShortStay ?? 0), 0);
    const despesasTotal=a.reduce((acc,item)=>acc+item.valor,0);
    const lucroTotal=receitaTotal - comissaoPortais - comissaoShort - despesasTotal;
    
    document.getElementById("indicadores-lista").innerHTML=`
        <div class="indicador-card"><div class="indicador-label">Receita Total</div><div class="indicador-valor green">${formatCurrency(receitaTotal)}</div></div>
        <div class="indicador-card"><div class="indicador-label">Comiss√£o Portais</div><div class="indicador-valor red">-${formatCurrency(comissaoPortais)}</div></div>
        <div class="indicador-card"><div class="indicador-label">Comiss√£o Short Stay</div><div class="indicador-valor red">-${formatCurrency(comissaoShort)}</div></div>
        <div class="indicador-card"><div class="indicador-label">Despesas</div><div class="indicador-valor red">-${formatCurrency(despesasTotal)}</div></div>
        <div class="indicador-card"><div class="indicador-label">Lucro L√≠quido</div><div class="indicador-valor ${lucroTotal>=0?'green':'red'}">${formatCurrency(lucroTotal)}</div></div>
    `;
    
    let c=``;
    n.forEach(t=>{
        // üí∞ CALCULA RESUMO DA UNIDADE PARA O CABE√áALHO (SEM CANCELADAS)
        const resUnidade = reservasAtivas.filter(r => r.unidade === t);
        const despUnidade = a.filter(d => d.unidade === t);
        const recUn = resUnidade.reduce((acc, r) => acc + r.receita, 0);
        const comPUn = resUnidade.reduce((acc, r) => acc + (r.comissaoPortais ?? r.comissao ?? 0), 0);
        const comSUn = resUnidade.reduce((acc, r) => acc + (r.comissaoShortStay ?? 0), 0);
        const despUn = despUnidade.reduce((acc, d) => acc + d.valor, 0);
        const lucroUn = recUn - comPUn - comSUn - despUn;

        c+=`<div class="unidade-grupo">
            <div class="unidade-header" onclick="toggleUnidade('${t.replace(/\s+/g,'_')}')">
                <div class="unidade-nome">
                    <span class="unidade-toggle collapsed" id="toggle_${t.replace(/\s+/g,'_')}">‚ñ∂</span>
                    ${t}
                </div>
                <div style="font-size: 12px; display: flex; gap: 15px;">
                    <span>Faturamento: <b class="green">${formatCurrency(recUn)}</b></span>
                    <span>Lucro: <b class="${lucroUn>=0?'green':'red'}">${formatCurrency(lucroUn)}</b></span>
                </div>
            </div>
            <div class="unidade-conteudo collapsed" id="conteudo_${t.replace(/\s+/g,'_')}">
                <table>
                    <thead><tr><th>Tipo</th>${d.map(e=>`<th>${e}/${l.substring(2)}</th>`).join("")}</tr></thead>
                    <tbody>`;
        
        i.forEach((tipo)=>{
            if (tipo === "Despesas") {
                c += `
                    <tr style="color:#2d7a7a;font-weight:600;">
                        <td>
                            <span id="arrow_${t.replace(/\s+/g,'_')}_${l}">‚ñ∂</span>
                            Despesas
                        </td>
                `;

                d.forEach(mes => {
                    const totalMes = a
                        .filter(x => x.unidade === t && x.data.startsWith(`${l}-${mes}`))
                        .reduce((acc, x) => acc + x.valor, 0);

                    const key = `desp_${t.replace(/\s+/g,'_')}_${l}_${mes}`;

                    c += `
                        <td class="red" style="cursor:pointer"
                            onclick="toggleDespesasLinha('${key}','${t}','${l}','${mes}','arrow_${t.replace(/\s+/g,'_')}_${l}')">
                            ${formatCurrency(-totalMes)}
                        </td>
                    `;
                });

                c += `</tr>`;

                d.forEach(mes => {
                    const key = `desp_${t.replace(/\s+/g,'_')}_${l}_${mes}`;
                    c += `
                        <tr id="${key}" style="display:none;background:#f9f9f9;">
                            <td colspan="${d.length + 1}">
                                <div id="${key}_conteudo" style="padding:12px;"></div>
                            </td>
                        </tr>
                    `;
                });

                return;
            }

            // üîπ LINHAS NORMAIS (Receita, Comiss√£o, Lucro)
            c += `<tr><td>${tipo}</td>`;

            d.forEach(mes=>{
                const n = `${l}-${mes}`;
                const reservasMes = reservasAtivas.filter(x => x.unidade === t && x.mesAno === n);
                const despesasMes = a.filter(x => x.unidade === t && x.data.startsWith(n));

                let valor = 0;
                if (tipo === "Receita Total") valor = reservasMes.reduce((acc,x)=>acc+x.receita,0);
                else if (tipo === "Comiss√£o Portais") {
                    const cp = reservasMes.reduce((acc,x)=>acc+(x.comissaoPortais ?? x.comissao ?? 0),0);
                    const cs = reservasMes.reduce((acc,x)=>acc+(x.comissaoShortStay ?? 0),0);
                    valor = -(cp + cs);
                }
                else if (tipo === "Lucro") {
                    const rec = reservasMes.reduce((acc,x)=>acc+x.receita,0);
                    const cp = reservasMes.reduce((acc,x)=>acc+(x.comissaoPortais ?? x.comissao ?? 0),0);
                    const cs = reservasMes.reduce((acc,x)=>acc+(x.comissaoShortStay ?? 0),0);
                    const desp = despesasMes.reduce((acc,x)=>acc+x.valor,0);
                    valor = rec - cp - cs - desp;
                }

                c += `<td class="${valor<0?'red':''}">${formatCurrency(valor)}</td>`;
            });

            c += `</tr>`;
        });
        
        c+=`</tbody></table></div></div>`;
    });
    
    o.innerHTML=c;
}

function toggleUnidade(unidadeId){
    const conteudo=document.getElementById(`conteudo_${unidadeId}`),
          toggle=document.getElementById(`toggle_${unidadeId}`);
    conteudo.classList.toggle('collapsed'),
    toggle.classList.toggle('collapsed')
}
        
        function toggleUnidade(unidadeId){
            const conteudo=document.getElementById(`conteudo_${unidadeId}`),
                  toggle=document.getElementById(`toggle_${unidadeId}`);
            conteudo.classList.toggle('collapsed'),
            toggle.classList.toggle('collapsed')
        }
        
function renderTabelaDespesasDetalhada(){
    var tabela = document.getElementById("tabela-despesas-detalhada");
    var despesas = CACHE_DESPESAS || [];

    // l√™ filtros existentes
   var anos = $("#filtroDespesasAnos").val() || [];
var meses = $("#filtroDespesasMeses").val() || [];
var unidades = $("#filtroDespesasUnidades").val() || [];


    function passaFiltro(d){
        if(!d) return false;

if(!d.mesAno && d.data){
    d.mesAno = d.data.substring(0,7); // üî• cria na hora
}


        var ano = d.mesAno.substring(0,4);
        var mes = d.mesAno.substring(5,7);

        if(anos.length && anos.indexOf(ano)===-1) return false;
        if(meses.length && meses.indexOf(mes)===-1) return false;
        if(unidades.length && unidades.indexOf(d.unidade)===-1) return false;

        return true;
    }

    var filtradas = despesas.filter(passaFiltro);

    if(!filtradas.length){
        tabela.innerHTML = "<tr><td>Nenhuma despesa encontrada</td></tr>";
        return;
    }

tabela.innerHTML = `
    <tr>
        <th>Data</th>
        <th>Unidade</th>
        <th>Categoria</th>
        <th>Descri√ß√£o</th>
        <th>Valor</th>
        <th>A√ß√µes</th>
    </tr>
`;


filtradas.forEach(function(d){
    tabela.innerHTML += `
        <tr>
            <td>${new Date(d.data).toLocaleDateString("pt-BR")}</td>
            <td>${d.unidade}</td>
            <td>${d.categoria}</td>
            <td>${d.descricao}</td>
            <td>${formatCurrency(d.valor)}</td>
            <td style="display:flex;gap:12px;align-items:center;">
                <span 
                    style="cursor:pointer;font-size:18px;" 
                    title="Editar"
                    onclick="editarDespesa('${d.id}')">
                    ‚úèÔ∏è
                </span>

                <span 
                    style="cursor:pointer;font-size:18px;color:#dc3545;" 
                    title="Excluir"
                    onclick="excluirDespesa('${d.id}')">
                    üóëÔ∏è
                </span>
            </td>
        </tr>
    `;
});

}
        
function openDespesaModal(modoEdicao = false) {
    carregarUnidadesDespesa();
    carregarCategoriasDespesa();
    
    document.getElementById("despesaModal").classList.add("active");
    
    // Se n√£o √© modo edi√ß√£o, limpa tudo
    if (!modoEdicao) {
        // üî• Garante que n√£o est√° em modo edi√ß√£o
        despesaEmEdicao = null;
        
        document.getElementById("despesaUnidade").value = "";
        document.getElementById("despesaDescricao").value = "";
        document.getElementById("despesaCategoria").value = "";
        document.getElementById("despesaData").value = "";
        document.getElementById("despesaValor").value = "";
        
        document.querySelector("#despesaModal button.btn-primary").textContent =
            "Salvar Despesa";
    }
}


        
function closeDespesaModal(){
    document.getElementById("despesaModal").classList.remove("active");
    despesaEmEdicao = null; // üî• ADICIONE esta linha
}
        
 async function salvarDespesa() {

    const valorNumerico = parseFloat(
        $("#despesaValor").val()
            .replace("R$", "")
            .replace(/\./g, "")
            .replace(",", ".")
    );

    if (
        !$("#despesaUnidade").val() ||
        !$("#despesaDescricao").val() ||
        !$("#despesaCategoria").val() ||
        !$("#despesaData").val() ||
        isNaN(valorNumerico)
    ) {
        alert("‚ö†Ô∏è Preencha todos os campos!");
        return;
    }

    const dadosDespesa = {
        unidade: $("#despesaUnidade").val(),
        descricao: $("#despesaDescricao").val(),
        categoria: $("#despesaCategoria").val(),
        data: $("#despesaData").val(),
        valor: valorNumerico
    };

    try {
        // üî• NOVO: verifica se √© edi√ß√£o ou nova despesa
        if (despesaEmEdicao) {
            // ===== MODO EDI√á√ÉO =====
            console.log("‚úèÔ∏è Editando despesa ID:", despesaEmEdicao);
            
            // Buscar unidade_id
            const { data: unidade, error: errUn } = await db
                .from("unidades")
                .select("id")
                .eq("nome", dadosDespesa.unidade)
                .single();

            if (errUn || !unidade) {
                throw new Error("Unidade n√£o encontrada: " + dadosDespesa.unidade);
            }

            // Buscar categoria_id
            const { data: categoria, error: errCat } = await db
                .from("categorias_despesas")
                .select("id")
                .eq("nome", dadosDespesa.categoria)
                .single();

            if (errCat || !categoria) {
                throw new Error("Categoria n√£o encontrada: " + dadosDespesa.categoria);
            }

            // Atualizar no Supabase
            const { error: errUpdate } = await db
                .from("despesas")
                .update({
                    unidade_id: unidade.id,
                    categoria_id: categoria.id,
                    descricao: dadosDespesa.descricao,
                    data: dadosDespesa.data,
                    valor: dadosDespesa.valor
                })
                .eq("id", despesaEmEdicao);

            if (errUpdate) {
                throw errUpdate;
            }

            console.log("‚úÖ Despesa atualizada com sucesso");
            
        } else {
            // ===== MODO NOVA DESPESA =====
            console.log("‚ûï Criando nova despesa");
            
            const ok = await salvarDespesaSupabase(dadosDespesa);

            if (!ok) {
                throw new Error("Erro ao salvar despesa no banco");
            }
        }

        // Limpa vari√°vel de edi√ß√£o
        despesaEmEdicao = null;
        
        // Fecha modal
        closeDespesaModal();

        // Recarrega despesas e atualiza telas
        await carregarDespesasSupabase();
        renderViews();
        renderTabelaDespesasDetalhada();
        
        alert("‚úÖ Despesa salva com sucesso!");

    } catch (err) {
        console.error("‚ùå Erro ao salvar despesa:", err);
        alert("‚ùå Erro ao salvar despesa: " + err.message);
    }
}

      
async function excluirDespesa(id) {
    if (!confirm("Tem certeza que deseja excluir esta despesa?")) return;

    const { error } = await db
        .from("despesas")
        .delete()
        .eq("id", id);

    if (error) {
        console.error("Erro ao excluir despesa:", error);
        alert("Erro ao excluir despesa");
        return;
    }

    await carregarDespesasSupabase();
    renderViews();
    renderTabelaDespesasDetalhada();
}
        

        function processarReservasFuturas(e){
            if(!e)return;
            const a=new FileReader;
            a.onload=function(t){
                try{
                    const e=XLSX.read(new Uint8Array(t.target.result),{type:"array",cellDates:!0}),s=XLSX.utils.sheet_to_json(e.Sheets[e.SheetNames[0]]),r={};
                    s.forEach(e=>{const a=e.Alojamento||e.Accommodation;a&&(r[a]||(r[a]=[]),r[a].push({hospede:e.H√≥spede||e.Guest||"N/A",

chegada: formatarDataCurta(e.Chegada || e["Check-in"]),
partida: formatarDataCurta(e.Partida || e["Check-out"]),



pessoas:parseInt(e.Adultos||0)+parseInt(e.Crian√ßas||0)||1}))});


                    const o=Object.values(r)[0]?.[0];
                    if(!o)return void alert("Nenhuma reserva encontrada.");
                    const[,n]=o.chegada.split("/"),l=["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"][parseInt(n)-1];
                    let d=`üü¶ ${l} ${(new Date).getFullYear()}\n\n`;
                    Object.keys(r).sort().forEach(e=>{d+=`üè¢ ${e}\n\n`,r[e].forEach(e=>{

d+=`${e.chegada} a ${e.partida} ${e.hospede?e.hospede.split(" ")[0]:""} ${e.pessoas}p\n`}),d+="\n"

}),
                    document.getElementById("mensagemPreview").textContent=d,document.getElementById("reservasPreview").style.display="block"
                }catch(e){alert("‚ùå Erro ao processar o arquivo: "+e.message)}
            },a.readAsArrayBuffer(e)
        }
        
        function enviarWhatsApp(){
            const e=document.getElementById("whatsappLimpeza").value;
            e?window.open(`https://wa.me/${e}?text=${encodeURIComponent(document.getElementById("mensagemPreview").textContent)}`,"_blank"):alert("‚ö†Ô∏è Digite o n√∫mero do WhatsApp!")
        }
        
        function renderProprietarios(){
            const e=getDb(DB_PROPRIETARIOS),a=[...new Set(getDb(DB_RESERVAS).map(e=>e.unidade))].sort();
            let t="";
            a.forEach(a=>{const s=e.find(e=>e.unidade===a)||{};t+=`<div class="card"><div class="form-group"><label class="form-label" style="font-weight: bold;">${a}</label><input type="text" class="form-input prop-input" data-unidade="${a}" value="${s.nome||""}" placeholder="Nome do propriet√°rio"></div></div>`}),
            document.getElementById("proprietarios-list").innerHTML=t||"<p>Nenhuma unidade encontrada. Importe um arquivo de reservas primeiro.</p>"
        }
        
        function salvarProprietarios(){
            const e=document.querySelectorAll(".prop-input"),a=Array.from(e).map(e=>({unidade:e.dataset.unidade,nome:e.value.trim()})).filter(e=>e.nome);
            saveDb(DB_PROPRIETARIOS,a),alert("‚úÖ Propriet√°rios salvos com sucesso!")
        }        

       $(document).ready(async function () {
    // 1Ô∏è‚É£ Inicializa Select2
    $("#filtroAnos").select2({
        placeholder: "Filtrar por ano",
        allowClear: true
    });

    $("#filtroMeses").select2({
        placeholder: "Filtrar por m√™s",
        allowClear: true
    });

    $("#filtroUnidades").select2({
        placeholder: "Filtrar por unidade",
        allowClear: true
    });

    $("#filtroAnaliticaUnidades").select2({
        placeholder: "Todos os alojamentos",
        allowClear: true
    });

    $("#filtroAnaliticaAnos").select2({
        placeholder: "Todos os anos",
        allowClear: true
    });

    $("#filtroAnaliticaMeses").select2({
        placeholder: "Todos os meses",
        allowClear: true
    });

    // 2Ô∏è‚É£ Carrega categorias
    carregarCategoriasDespesa();

    // 3Ô∏è‚É£ Carrega dados do Supabase
    try {
        console.log("üîÑ Iniciando carregamento do Supabase...");
        await carregarReservasSupabase();
        
        // 4Ô∏è‚É£ Configura filtros
        setupFilters();
        setupAnaliticaFilters();
        
        // 5Ô∏è‚É£ Mostra p√°gina inicial
        showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
        setViewMode("cards");
        
        console.log("‚úÖ Sistema inicializado com sucesso!");
        
    } catch (err) {
        console.error("‚ùå Erro ao inicializar:", err);
        alert("Erro ao carregar dados. Verifique a conex√£o com o Supabase.");
    }
});

async function syncDespesas() {
  const despesasLocal = getDb(DB_DESPESAS);

  if (!despesasLocal.length) {
    console.log("‚ÑπÔ∏è Nenhuma despesa local encontrada");
    return;
  }

  // 1Ô∏è‚É£ unidades
  const { data: unidades, error: errUn } = await db
    .from("unidades")
    .select("id, nome");

  if (errUn) {
    console.error("Erro ao buscar unidades:", errUn);
    return;
  }

  const mapaUnidades = {};
  unidades.forEach(u => {
    mapaUnidades[u.nome] = u.id;
  });

  // 2Ô∏è‚É£ categorias
  const { data: categorias } = await db
    .from("categorias_despesas")
    .select("id, nome");

  const mapaCategorias = {};
  (categorias || []).forEach(c => {
    mapaCategorias[c.nome] = c.id;
  });

  // 3Ô∏è‚É£ monta despesas
  const novas = despesasLocal
    .map(d => ({
      unidade_id: mapaUnidades[d.unidade],
      categoria_id: mapaCategorias[d.categoria] ?? null,
      descricao: d.descricao,
      data: d.data,
      valor: d.valor
    }))
    .filter(d => d.unidade_id);

  if (!novas.length) {
    console.log("‚ÑπÔ∏è Nenhuma despesa v√°lida para migrar");
    return;
  }

  // 4Ô∏è‚É£ insere
  const { error } = await db
    .from("despesas")
    .insert(novas);

  if (error) {
    console.error("‚ùå Erro ao inserir despesas:", error);
  } else {
    console.log(`‚úî ${novas.length} despesas migradas para o Supabase`);
  }
}


async function syncReservas() {
  const reservasLocal = getDb(DB_RESERVAS);
  if (!reservasLocal.length) {
    console.log("‚ÑπÔ∏è Nenhuma reserva local encontrada");
    return;
  }

  const { data: unidades, error: errUn } = await db
    .from("unidades")
    .select("id, nome");

  if (errUn) {
    console.error("Erro ao buscar unidades:", errUn);
    return;
  }

  const mapaUnidades = {};
  unidades.forEach(u => {
    mapaUnidades[u.nome] = u.id;
  });

  const { data: existentes, error: errRes } = await db
    .from("reservas")
    .select("id_reserva");

  if (errRes) {
    console.error("Erro ao buscar reservas existentes:", errRes);
    return;
  }

  const idsExistentes = new Set(existentes.map(r => r.id_reserva));

  const novas = reservasLocal
    .filter(r => !idsExistentes.has(r.idReserva))
    .map(r => ({
      id_reserva: r.idReserva,
      unidade_id: mapaUnidades[r.unidade],
      ano: r.ano,
      mes: r.mes,
      mes_ano: r.mesAno,
      receita: r.receita,
      comissao_portais: r.comissao ?? 0,
      comissao_short_stay: r.comissaoShortStay ?? 0
    }))
    .filter(r => r.unidade_id);

  if (!novas.length) {
    console.log("‚úî Nenhuma reserva nova para inserir");
    return;
  }

  const { error: insertErr } = await db
    .from("reservas")
    .insert(novas);

  if (insertErr) {
    console.error("‚ùå Erro ao inserir reservas:", insertErr);
  } else {
    console.log(`‚úî ${novas.length} reservas migradas para o Supabase`);
  }
}


    // üîß inicializa filtros UMA √öNICA VEZ
carregarReservasSupabase().then(() => {

    showPage(
        "financeiro",
        document.querySelector('.menu-item[onclick*="financeiro"]')
    );

    setViewMode("cards");

});


function getSmoobuExcelUrl() {
    return (
        "https://login.smoobu.com/api/v2/users/670124/bookings/exports/xlsx" +
        "?sort=arrivalDate" +
        "&filter[arrivalDate][from]=2026-01-01" +
        "&filter[arrivalDate][to]=2027-12-31" +
        "&filter[departureDate][from]=2026-01-01" +
        "&filter[departureDate][to]=2027-12-31" +
        "&filter[includeIntersections]=true" +
        "&filter[excludeMockedBookings]=true" +
        "&filter[statuses][0]=1" +
        "&filter[statuses][1]=2"
    );
}

function jaAtualizouHoje() {
    const hoje = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    return localStorage.getItem("smoobuAtualizadoEm") === hoje;
}

function marcarAtualizadoHoje() {
    const hoje = new Date().toISOString().slice(0, 10);
    localStorage.setItem("smoobuAtualizadoEm", hoje);
}

function verificarAtualizacaoAutomatica() {
    // Verifica se j√° atualizou hoje
    if (!jaAtualizouHoje()) {
        // Aguarda 2 segundos para o sistema carregar completamente
        setTimeout(() => {
            // üî• ABRE AUTOMATICAMENTE o Smoobu (sem perguntar)
            console.log("üì• Primeira entrada do dia - abrindo Smoobu...");
            
            // Abre o link do Smoobu em nova aba
            window.open(getSmoobuExcelUrl(), "_blank");
            
            // Marca como atualizado
            marcarAtualizadoHoje();
            
            // Vai pra tela de Upload
            showPage("upload", document.querySelector('.menu-item[onclick*="upload"]'));
            
            // Mostra notifica√ß√£o na tela
            const notificacao = document.createElement('div');
            notificacao.innerHTML = `
                <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2d7a7a 0%, #1a4d4d 100%); color: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 10000; text-align: center; min-width: 400px; animation: slideDown 0.5s;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì•</div>
                    <h3 style="margin: 0 0 10px 0; font-size: 18px;">Atualiza√ß√£o Di√°ria</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">O Smoobu foi aberto em nova aba.<br>Salve o arquivo e fa√ßa o upload abaixo! ‚¨áÔ∏è</p>
                </div>
            `;
            document.body.appendChild(notificacao);
            
            // Remove notifica√ß√£o ap√≥s 8 segundos
            setTimeout(() => {
                notificacao.style.animation = 'slideUp 0.5s';
                setTimeout(() => notificacao.remove(), 500);
            }, 8000);
            
            // Destaca a √°rea de upload ap√≥s 1 segundo
            setTimeout(() => {
                const input = document.getElementById("fileInput");
                if (input) {
                    input.scrollIntoView({ behavior: "smooth", block: "center" });
                    
                    // Adiciona efeito de pulso no card de upload
                    const uploadCard = input.closest('.card');
                    if (uploadCard) {
                        uploadCard.style.animation = 'pulse 2s infinite';
                    }
                }
            }, 1000);
            
        }, 2000); // Aguarda 2 segundos ap√≥s login
    }
}


function atualizarDoSmoobuViaDownload(motivo = "manual") {

    // 1Ô∏è‚É£ Abre o Smoobu
    window.open(getSmoobuExcelUrl(), "_blank");


    // 2Ô∏è‚É£ Se foi autom√°tico (primeira vez do dia), marca no sistema
    if (motivo === "auto") {
        marcarAtualizadoHoje();
    }

    // 3Ô∏è‚É£ Leva para a tela de Upload
    showPage("upload", document.querySelector('.menu-item[onclick*="upload"]'));

    // 4Ô∏è‚É£ Apenas destaca onde subir o arquivo
    setTimeout(() => {
        const input = document.getElementById("fileInput");
        if (input) {
            input.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }, 500);
}


function openCategoriaModal() {
    document.getElementById("categoriaModal").classList.add("active");
    renderCategorias();
}

function closeCategoriaModal() {
    document.getElementById("categoriaModal").classList.remove("active");
}

async function addCategoria() {
    const nome = document.getElementById("novaCategoria").value.trim();
    if (!nome) return alert("Informe o nome da categoria");

    const { error } = await db
        .from("categorias_despesas")
        .insert({ nome });

    if (error) {
        alert("Erro ao salvar categoria");
        console.error(error);
        return;
    }

    document.getElementById("novaCategoria").value = "";
    await carregarCategoriasDespesa();
}


function renderCategorias() {
    const lista = document.getElementById("listaCategorias");
    const categorias = getDb(DB_CATEGORIAS);

    lista.innerHTML = categorias.map(c =>
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
            <span>${c}</span>
            <button class="btn btn-link" style="color:red;" onclick="removeCategoria('${c}')">Excluir</button>
        </div>`
    ).join("");
}

function removeCategoria(nome) {
    saveDb(DB_CATEGORIAS, getDb(DB_CATEGORIAS).filter(c => c !== nome));
    renderCategorias();
}

function formatarValorBR(input) {
    let valor = input.value.replace(/\D/g, "");

    if (!valor) {
        input.value = "";
        return;
    }

    valor = (parseInt(valor, 10) / 100).toFixed(2);

    input.value = valor
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    input.value = "R$ " + input.value;
}

function abrirDespesasDetalhe(unidade, ano, mes) {

    const despesas = getDb(DB_DESPESAS).filter(d =>
        d.unidade === unidade &&
        d.data.startsWith(`${ano}-${mes}`)
    );

    let html = `
        <thead>
            <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody>
    `;

    if (despesas.length === 0) {
        html += `
            <tr>
                <td colspan="4" style="text-align:center;padding:20px;">
                    Nenhuma despesa encontrada.
                </td>
            </tr>
        `;
    } else {
        despesas.forEach(d => {
            html += `
                <tr>
                    <td>${new Date(d.data).toLocaleDateString("pt-BR")}</td>
                    <td>${d.descricao}</td>
                    <td>${d.categoria}</td>
                    <td>${formatCurrency(d.valor)}</td>
                </tr>
            `;
        });
    }

    html += "</tbody>";

    // reutiliza a tabela de despesas (sem criar modal novo ainda)
    showPage("despesas", document.querySelector('.menu-item[onclick*="despesas"]'));
    document.getElementById("tabela-despesas-detalhada").innerHTML = html;
}

function toggleDespesasLinha(key, unidade, ano, mes, arrowId) {
    const linha = document.getElementById(key);
    const conteudo = document.getElementById(key + "_conteudo");
    const arrow = document.getElementById(arrowId);

    const aberta = linha.style.display === "table-row";

    // Fecha todas as outras linhas de detalhe abertas
    document.querySelectorAll("tr[id^='desp_']").forEach(l => {
        l.style.display = "none";
    });
    document.querySelectorAll("[id^='arrow_']").forEach(a => {
        a.textContent = "‚ñ∂";
    });

    // Se a linha j√° estava aberta, apenas a fecha e para a execu√ß√£o
    if (aberta) {
        arrow.textContent = "‚ñ∂";
        return;
    }

    const prefixo = `${ano}-${mes}`;

    // ===== CORRE√á√ÉO PRINCIPAL AQUI =====
    // Busca as despesas do CACHE (mem√≥ria) em vez do localStorage (getDb)
    const despesas = (CACHE_DESPESAS || []).filter(d =>
        d.unidade === unidade &&
        d.mesAno === prefixo
    );
    // =====================================

    let html = `
        <table style="width:100%;border-collapse:collapse;background-color:#fafafa;">
            <thead style="font-size:12px;">
                <tr>
                    <th style="padding:8px 12px;">Data</th>
                    <th style="padding:8px 12px;">Descri√ß√£o</th>
                    <th style="padding:8px 12px;">Categoria</th>
                    <th style="padding:8px 12px;text-align:right;">Valor</th>
                </tr>
            </thead>
            <tbody>
    `;

    if (despesas.length === 0) {
        html += `
            <tr>
                <td colspan="4" style="text-align:center;padding:16px;font-style:italic;color:#888;">
                    Nenhuma despesa cadastrada neste m√™s.
                </td>
            </tr>
        `;
    } else {
        despesas.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(d => {
            html += `
                <tr style="font-size:13px;">
                    <td style="padding:8px 12px;">${new Date(d.data).toLocaleDateString("pt-BR", {timeZone: 'UTC'})}</td>
                    <td style="padding:8px 12px;">${d.descricao}</td>
                    <td style="padding:8px 12px;">${d.categoria}</td>
                    <td style="padding:8px 12px;text-align:right;color:#dc3545;">${formatCurrency(d.valor)}</td>
                </tr>
            `;
        });
    }

    html += "</tbody></table>";

    conteudo.innerHTML = html;
    linha.style.display = "table-row";
    arrow.textContent = "‚ñº"; // Muda a seta para indicar que est√° aberto
}

async function editarDespesa(id) {
    console.log("‚úèÔ∏è Editando despesa ID:", id);
    
    const despesas = CACHE_DESPESAS || [];
    const d = despesas.find(desp => desp.id === id);
    
    if (!d) {
        console.error("‚ùå Despesa n√£o encontrada:", id);
        alert("Despesa n√£o encontrada!");
        return;
    }
    
    // Guarda o ID
    despesaEmEdicao = id;
    
    // üî• Passa TRUE para indicar modo edi√ß√£o
    openDespesaModal(true);
    
    document.getElementById("despesaUnidade").value = d.unidade;
    document.getElementById("despesaDescricao").value = d.descricao;
    document.getElementById("despesaCategoria").value = d.categoria;
    document.getElementById("despesaData").value = d.data;
    
    const inputValor = document.getElementById("despesaValor");
    inputValor.value = "R$ " + d.valor
        .toFixed(2)
        .replace(".", ",")
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    document.querySelector("#despesaModal button.btn-primary").textContent =
        "Salvar Altera√ß√µes";
}

function carregarUnidadesDespesa() {
    const select = document.getElementById("despesaUnidade");
    if (!select) return;
    
    const dados = CACHE_RESERVAS || [];
    const unidades = [...new Set(dados.map(r => r.unidade))].sort();
    
    console.log("üè¢ Unidades para despesa:", unidades);
    
    select.innerHTML = '<option value="">Selecione a unidade</option>';
    
    unidades.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
    });
}



function toggleMenu() {
    document.querySelector(".sidebar").classList.toggle("open");
}


function closeUploadManualModal() {
    document.getElementById("uploadManualModal").classList.remove("active");
}


function parseMesAno(texto) {
    const mapa = {
        jan: "01", fev: "02", mar: "03", abr: "04",
        mai: "05", jun: "06", jul: "07", ago: "08",
        set: "09", out: "10", nov: "11", dez: "12"
    };

    const match = texto.match(/(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)\/(\d{2})/);
    if (!match) return {};

    return {
        mes: mapa[match[1]],
        ano: "20" + match[2]
    };
}


async function processarUploadManual(file) {
    if (!file) return;
    
    const anoAtual = new Date().getFullYear().toString(); // "2026"
    
    console.log(`üîµ Upload Movi - Ano atual: ${anoAtual}`);
    
    mostrarLoading(`Limpando dados de ${anoAtual}...`);
    
    try {
        // 1Ô∏è‚É£ APAGA TODAS AS RESERVAS DO ANO ATUAL
        const { data: unidadeMovi } = await db
            .from("unidades")
            .select("id")
            .ilike("nome", "%Movi%")
            .single();
        
        if (unidadeMovi) {
            const { data: deletadas } = await db
                .from("reservas")
                .delete()
                .eq("unidade_id", unidadeMovi.id)
                .eq("ano", anoAtual)
                .select();
            
            console.log(`üóëÔ∏è ${deletadas?.length || 0} reservas de ${anoAtual} apagadas`);
        }
        
        mostrarLoading("Processando arquivo...");
        
        // 2Ô∏è‚É£ PROCESSA O ARQUIVO
        const reader = new FileReader();
        reader.onload = async function(evt) {
            try {
                const workbook = XLSX.read(new Uint8Array(evt.target.result), {type: "array", cellDates: true});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const linhas = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: true});
                
                const reservas = [];
                let mesAtual = null, anoProcessado = null;
                
                for (let i = 1; i < linhas.length; i++) {
                    const [periodo, valor, taxaApp] = linhas[i];
                    
                    if (periodo instanceof Date) {
                        anoProcessado = periodo.getFullYear().toString();
                        mesAtual = String(periodo.getMonth() + 1).padStart(2, '0');
                        continue;
                    }
                    
                    if (typeof valor !== 'number' || valor <= 0 || !anoProcessado) continue;
                    
                    const dias = String(periodo).match(/(\d{1,2})\s*a\s*(\d{1,2})/);
                    const id = `MOVI_${anoProcessado}${mesAtual}_${dias?.[1] || '01'}-${dias?.[2] || '01'}_${valor.toFixed(2)}`;
                    
                    reservas.push({
                        idReserva: id,
                        unidade: "Movi 505",
                        ano: anoProcessado,
                        mes: mesAtual,
                        mesAno: `${anoProcessado}-${mesAtual}`,
                        receita: valor,
                        comissao: typeof taxaApp === 'number' ? taxaApp : 0,
                        comissaoPortais: typeof taxaApp === 'number' ? taxaApp : 0,
                        comissaoShortStay: 0,
                        status: 'ativa'
                    });
                }
                
                console.log(`‚úÖ ${reservas.length} reservas processadas`);
                
                mostrarLoading("Salvando novas reservas...");
                
                // 3Ô∏è‚É£ SALVA AS NOVAS
                await salvarReservasNoSupabase(reservas);
                
                // 4Ô∏è‚É£ RECARREGA
                await carregarReservasSupabase();
                closeUploadManualModal();
                setupFilters();
                renderViews();
                esconderLoading();
                
                alert(`‚úÖ ${reservas.length} reservas do Movi importadas!\n\nüìÖ Dados de ${anoAtual} atualizados com sucesso!`);
                
            } catch (err) {
                console.error("‚ùå Erro:", err);
                esconderLoading();
                alert("‚ùå Erro: " + err.message);
            }
        };
        
        reader.readAsArrayBuffer(file);
        
    } catch (err) {
        console.error("‚ùå Erro:", err);
        esconderLoading();
        alert("‚ùå Erro: " + err.message);
    }
}async function syncUnidades() {
  // unidades vindas do sistema atual (localStorage)
  const reservas = await getReservas();

  if (!reservas.length) return;

  const unidadesUnicas = [...new Set(reservas.map(r => r.unidade))];

  // busca unidades j√° existentes no Supabase
  const { data: existentes, error } = await db
    .from("unidades")
    .select("id, nome");

  if (error) {
    console.error("Erro ao buscar unidades:", error);
    return;
  }

  const nomesExistentes = new Set(existentes.map(u => u.nome));

  // filtra s√≥ as novas
  const novas = unidadesUnicas
    .filter(nome => !nomesExistentes.has(nome))
    .map(nome => ({ nome }));

  if (!novas.length) {
    console.log("‚úî Nenhuma unidade nova para criar");
    return;
  }

  const { error: insertError } = await db
    .from("unidades")
    .insert(novas);

  if (insertError) {
    console.error("Erro ao inserir unidades:", insertError);
  } else {
    console.log(`‚úî ${novas.length} unidades criadas no Supabase`);
  }
}

async function syncReservas() {
  const reservasLocal = getDb(DB_RESERVAS);
  if (!reservasLocal.length) {
    console.log("‚ÑπÔ∏è Nenhuma reserva local encontrada");
    return;
  }

  // 1Ô∏è‚É£ Carrega unidades do Supabase
  const { data: unidades, error: errUn } = await db
    .from("unidades")
    .select("id, nome");

  if (errUn) {
    console.error("Erro ao buscar unidades:", errUn);
    return;
  }

  const mapaUnidades = {};
  unidades.forEach(u => {
    mapaUnidades[u.nome] = u.id;
  });

  // 2Ô∏è‚É£ Busca IDs de reservas j√° existentes
  const { data: existentes, error: errRes } = await db
    .from("reservas")
    .select("id_reserva");

  if (errRes) {
    console.error("Erro ao buscar reservas existentes:", errRes);
    return;
  }

  const idsExistentes = new Set(existentes.map(r => r.id_reserva));

  // 3Ô∏è‚É£ Prepara reservas novas
  const novas = reservasLocal
    .filter(r => !idsExistentes.has(r.idReserva))
    .map(r => ({
      id_reserva: r.idReserva,
      unidade_id: mapaUnidades[r.unidade],
      ano: r.ano,
      mes: r.mes,
      mes_ano: r.mesAno,
      receita: r.receita,
      comissao_portais: r.comissao ?? 0,
      comissao_short_stay: r.comissaoShortStay ?? 0
    }))
    .filter(r => r.unidade_id); // seguran√ßa extra

  if (!novas.length) {
    console.log("‚úî Nenhuma reserva nova para inserir");
    return;
  }

  // 4Ô∏è‚É£ Insere no Supabase
  const { error: insertErr } = await db
    .from("reservas")
    .insert(novas);

  if (insertErr) {
    console.error("‚ùå Erro ao inserir reservas:", insertErr);
  } else {
    console.log(`‚úî ${novas.length} reservas migradas para o Supabase`);
  }
}


async function syncCategorias() {
  const categoriasLocal = getDb(DB_CATEGORIAS);

  if (!categoriasLocal.length) {
    console.log("‚ÑπÔ∏è Nenhuma categoria local encontrada");
    return;
  }

  // busca categorias existentes
  const { data: existentes, error } = await db
    .from("categorias_despesas")
    .select("nome");

  if (error) {
    console.error("Erro ao buscar categorias:", error);
    return;
  }

  const nomesExistentes = new Set(existentes.map(c => c.nome));

  const novas = categoriasLocal
    .filter(nome => !nomesExistentes.has(nome))
    .map(nome => ({ nome }));

  if (!novas.length) {
    console.log("‚úî Nenhuma categoria nova para inserir");
    return;
  }

  const { error: insertErr } = await db
    .from("categorias_despesas")
    .insert(novas);

  if (insertErr) {
    console.error("‚ùå Erro ao inserir categorias:", insertErr);
  } else {
    console.log(`‚úî ${novas.length} categorias migradas para o Supabase`);
  }
}

async function syncProprietarios() {
  const proprietariosLocal = getDb(DB_PROPRIETARIOS);

  if (!proprietariosLocal.length) {
    console.log("‚ÑπÔ∏è Nenhum propriet√°rio local encontrado");
    return;
  }

  const { data: unidades, error } = await db
    .from("unidades")
    .select("id, nome");

  if (error) {
    console.error("Erro ao buscar unidades:", error);
    return;
  }

  const mapaUnidades = {};
  unidades.forEach(u => {
    mapaUnidades[u.nome] = u.id;
  });

  const novos = proprietariosLocal
    .map(p => ({
      unidade_id: mapaUnidades[p.unidade],
      nome: p.nome
    }))
    .filter(p => p.unidade_id && p.nome);

  if (!novos.length) {
    console.log("‚ÑπÔ∏è Nenhum propriet√°rio v√°lido para migrar");
    return;
  }

  const { error: insertErr } = await db
    .from("proprietarios")
    .insert(novos, { ignoreDuplicates: true });

  if (insertErr) {
    console.error("‚ùå Erro ao inserir propriet√°rios:", insertErr);
  } else {
    console.log(`‚úî ${novos.length} propriet√°rios migrados para o Supabase`);
  }
}

async function syncProprietarios() {
  const proprietariosLocal = getDb(DB_PROPRIETARIOS);

  if (!proprietariosLocal.length) {
    console.log("‚ÑπÔ∏è Nenhum propriet√°rio local encontrado");
    return;
  }

  const { data: unidades, error } = await db
    .from("unidades")
    .select("id, nome");

  if (error) {
    console.error("Erro ao buscar unidades:", error);
    return;
  }

  const mapaUnidades = {};
  unidades.forEach(u => {
    mapaUnidades[u.nome] = u.id;
  });

  const novos = proprietariosLocal
    .map(p => ({
      unidade_id: mapaUnidades[p.unidade],
      nome: p.nome
    }))
    .filter(p => p.unidade_id && p.nome);

  if (!novos.length) {
    console.log("‚ÑπÔ∏è Nenhum propriet√°rio v√°lido para migrar");
    return;
  }

  const { error: insertErr } = await db
    .from("proprietarios")
    .insert(novos, { ignoreDuplicates: true });

  if (insertErr) {
    console.error("‚ùå Erro ao inserir propriet√°rios:", insertErr);
  } else {
    console.log(`‚úî ${novos.length} propriet√°rios migrados para o Supabase`);
  }
}

async function getReservas() {
  const { data, error } = await db
    .from("reservas")
    .select(`
      id,
      id_reserva,
      ano,
      mes,
      mes_ano,
      receita,
      comissao_portais,
      comissao_short_stay,
      unidades ( nome )
    `);

  if (!error && data && data.length) {
    // adapta para o formato antigo do sistema
    return data.map(r => ({
      idReserva: r.id_reserva,
      unidade: r.unidades.nome,
      ano: r.ano,
      mes: r.mes,
      mesAno: r.mes_ano,
      receita: r.receita,
      comissao: r.comissao_portais,
      comissaoShortStay: r.comissao_short_stay
    }));
  }

  // fallback total
  return getDb(DB_RESERVAS);
}


async function getReservasFonte() {
  const { data, error } = await db
    .from("reservas")
    .select(`
      id_reserva,
      ano,
      mes,
      mes_ano,
      receita,
      comissao_portais,
      comissao_short_stay,
      unidades ( nome )
    `);

  if (!error && data && data.length) {
    console.log("üì° Dados vindos do Supabase");
    return data.map(r => ({
      idReserva: r.id_reserva,
      unidade: r.unidades.nome,
      ano: r.ano,
      mes: r.mes,
      mesAno: r.mes_ano,
      receita: r.receita,
      comissao: r.comissao_portais,
      comissaoShortStay: r.comissao_short_stay
    }));
  }

  console.log("üíæ Fallback localStorage");
  return getDb(DB_RESERVAS);
}

async function getReservasFonte() {
  const { data, error } = await db
    .from("reservas")
    .select(`
      id_reserva,
      ano,
      mes,
      mes_ano,
      receita,
      comissao_portais,
      comissao_short_stay,
      unidades ( nome )
    `);

  if (!error && data && data.length) {
    console.log("üåê Reservas vindas do Supabase");
    return data.map(r => ({
      idReserva: r.id_reserva,
      unidade: r.unidades.nome,
      ano: r.ano,
      mes: r.mes,
      mesAno: r.mes_ano,
      receita: r.receita,
      comissao: r.comissao_portais,
      comissaoShortStay: r.comissao_short_stay
    }));
  }

  console.log("üíæ Reservas vindas do localStorage");
  return getDb(DB_RESERVAS);
}

async function migrarParaSupabase() {
  if (!confirm("Migrar dados do localStorage para o Supabase?")) return;

  try {
    // 1Ô∏è‚É£ Migra unidades
    const reservasLocal = getDb(DB_RESERVAS);
    const unidadesUnicas = [...new Set(reservasLocal.map(r => r.unidade))];
    
    console.log("üì¶ Migrando unidades...");
    for (const nome of unidadesUnicas) {
      await db.from("unidades").upsert({ nome }, { onConflict: 'nome' });
    }

    // 2Ô∏è‚É£ Busca IDs das unidades
    const { data: unidades } = await db.from("unidades").select("id, nome");
    const mapaUnidades = {};
    unidades.forEach(u => { mapaUnidades[u.nome] = u.id; });

    // 3Ô∏è‚É£ Migra reservas
    console.log("üí∞ Migrando reservas...");
    const reservasParaInserir = reservasLocal.map(r => ({
      id_reserva: r.idReserva,
      unidade_id: mapaUnidades[r.unidade],
      ano: r.ano,
      mes: r.mes,
      mes_ano: r.mesAno,
      receita: r.receita,
      comissao_portais: r.comissao ?? 0,
      comissao_short_stay: r.comissaoShortStay ?? 0
    })).filter(r => r.unidade_id);

    const { error: errReservas } = await db
      .from("reservas")
      .upsert(reservasParaInserir, { onConflict: 'id_reserva' });

    if (errReservas) {
      console.error("Erro ao migrar reservas:", errReservas);
      alert("‚ùå Erro ao migrar reservas: " + errReservas.message);
      return;
    }

    // 4Ô∏è‚É£ Migra despesas
    const despesasLocal = getDb(DB_DESPESAS);
    if (despesasLocal.length > 0) {
      console.log("üí∏ Migrando despesas...");
      
      const { data: categorias } = await db
        .from("categorias_despesas")
        .select("id, nome");
      
      const mapaCategorias = {};
      (categorias || []).forEach(c => { mapaCategorias[c.nome] = c.id; });

      const despesasParaInserir = despesasLocal.map(d => ({
        unidade_id: mapaUnidades[d.unidade],
        categoria_id: mapaCategorias[d.categoria] ?? null,
        descricao: d.descricao,
        data: d.data,
        valor: d.valor
      })).filter(d => d.unidade_id);

      await db.from("despesas").insert(despesasParaInserir);
    }

    alert("‚úÖ Migra√ß√£o conclu√≠da com sucesso!");
    
    // Recarrega os dados
    await carregarReservasSupabase();
await carregarDespesasSupabase(); // üëà ESSENCIAL

    setupFilters();
    renderViews();

  } catch (err) {
    console.error("Erro na migra√ß√£o:", err);
    alert("‚ùå Erro: " + err.message);
  }
}



// ===== INICIALIZA√á√ÉO DO SISTEMA =====
document.addEventListener("DOMContentLoaded", async () => {
    console.log("üöÄ Sistema iniciando...");

    // 1. Configura os seletores (filtros)
    $("#filtroAnos, #filtroMeses, #filtroUnidades").select2({ 
        placeholder: "Filtrar", 
        allowClear: true 
    });
    $("#filtroAnaliticaUnidades, #filtroAnaliticaAnos, #filtroAnaliticaMeses").select2({ 
        placeholder: "Todos", 
        allowClear: true 
    });

    try {
        // 2. Carrega todos os dados essenciais do Supabase
        await carregarReservasSupabase();
        await carregarDespesasSupabase(); // ESSENCIAL CARREGAR AQUI
        await carregarCategoriasDespesa();

        // 3. Configura os filtros com os dados carregados
        setupFilters();
        setupAnaliticaFilters();
        
        // 4. Mostra a p√°gina inicial e renderiza as visualiza√ß√µes
        showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
        setViewMode("cards"); // Come√ßa na vis√£o de cards
        
        console.log("‚úÖ Sistema inicializado com sucesso!");
        
    } catch (err) {
        console.error("‚ùå Erro grave ao inicializar o sistema:", err);
        alert("N√£o foi poss√≠vel carregar os dados do sistema. Verifique a conex√£o com a internet e tente recarregar a p√°gina.");
    }
});

function carregarCategoriasDespesa() {
    const select = document.getElementById("despesaCategoria");
    if (!select) return;
    
    const categorias = getDb(DB_CATEGORIAS);
    select.innerHTML = '<option value="">Selecione a categoria</option>';
    
    categorias.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });
}

$(document).ready(async function () {
    $("#filtroAnos, #filtroMeses, #filtroUnidades").select2({ 
        placeholder: "Filtrar", 
        allowClear: true 
    });
    
    carregarCategoriasDespesa();
    
    try {
        await carregarReservasSupabase();

        setupFilters();
        setupAnaliticaFilters();
        showPage("financeiro", document.querySelector('.menu-item[onclick*="financeiro"]'));
        setViewMode("lista");

    } catch (err) {
        console.error("Erro:", err);
    }
});

async function carregarCategoriasDespesa() {
    const select = document.getElementById("despesaCategoria");
    if (!select) return;
    
    try {
        // üî• BUSCA DO SUPABASE ao inv√©s do localStorage
        const { data, error } = await db
            .from("categorias_despesas")
            .select("nome")
            .order("nome");
        
        if (error) throw error;
        
        select.innerHTML = '<option value="">Selecione a categoria</option>';
        
        data.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.nome;
            opt.textContent = c.nome;
            select.appendChild(opt);
        });
    } catch (err) {
        console.error("Erro ao carregar categorias:", err);
    }
}



// ADICIONE estas fun√ß√µes no seu <script>

async function fazerBackupExcel() {
    try {
        const reservas = CACHE_RESERVAS || getDb(DB_RESERVAS);
        const despesas = getDb(DB_DESPESAS);
        const proprietarios = getDb(DB_PROPRIETARIOS);
        const categorias = getDb(DB_CATEGORIAS);

        const wb = XLSX.utils.book_new();

        const reservasExport = reservas.map(r => ({
            'ID Reserva': r.idReserva,
            'Unidade': r.unidade,
            'Ano': r.ano,
            'M√™s': r.mes,
            'M√™s/Ano': r.mesAno,
            'Receita': r.receita,
            'Comiss√£o Portais': r.comissao || 0,
            'Comiss√£o Short Stay': r.comissaoShortStay || 0
        }));

        const despesasExport = despesas.map(d => ({
            'ID': d.id,
            'Unidade': d.unidade,
            'Descri√ß√£o': d.descricao,
            'Categoria': d.categoria,
            'Data': d.data,
            'Valor': d.valor
        }));

        const proprietariosExport = proprietarios.map(p => ({
            'Unidade': p.unidade,
            'Nome': p.nome
        }));

        const categoriasExport = categorias.map(c => ({ 'Categoria': c }));

        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(reservasExport), "Reservas");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(despesasExport), "Despesas");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(proprietariosExport), "Propriet√°rios");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(categoriasExport), "Categorias");

        const hoje = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `Backup_Bandeira_${hoje}.xlsx`);

        alert("‚úÖ Backup realizado com sucesso!");

    } catch (err) {
        console.error(err);
        alert("‚ùå Erro ao fazer backup: " + err.message);
    }
}

function restaurarBackupExcel(file) {
    if (!file) return;

    if (!confirm("‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ir√° SUBSTITUIR todos os dados atuais.\n\nDeseja continuar?")) {
        return;
    }

    const reader = new FileReader();

    reader.onload = function(evt) {
        try {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });

            if (workbook.SheetNames.includes("Reservas")) {
                const reservasSheet = XLSX.utils.sheet_to_json(workbook.Sheets["Reservas"]);
                const reservas = reservasSheet.map(r => ({
                    idReserva: r['ID Reserva'],
                    unidade: r['Unidade'],
                    ano: r['Ano'],
                    mes: r['M√™s'],
                    mesAno: r['M√™s/Ano'],
                    receita: r['Receita'],
                    comissao: r['Comiss√£o Portais'] || 0,
                    comissaoShortStay: r['Comiss√£o Short Stay'] || 0
                }));
                saveDb(DB_RESERVAS, reservas);
            }

            if (workbook.SheetNames.includes("Despesas")) {
                const despesasSheet = XLSX.utils.sheet_to_json(workbook.Sheets["Despesas"]);
                const despesas = despesasSheet.map(d => ({
                    id: d['ID'],
                    unidade: d['Unidade'],
                    descricao: d['Descri√ß√£o'],
                    categoria: d['Categoria'],
                    data: d['Data'],
                    valor: d['Valor']
                }));
                saveDb(DB_DESPESAS, despesas);
            }

            if (workbook.SheetNames.includes("Propriet√°rios")) {
                const propsSheet = XLSX.utils.sheet_to_json(workbook.Sheets["Propriet√°rios"]);
                const props = propsSheet.map(p => ({
                    unidade: p['Unidade'],
                    nome: p['Nome']
                }));
                saveDb(DB_PROPRIETARIOS, props);
            }

            if (workbook.SheetNames.includes("Categorias")) {
                const catsSheet = XLSX.utils.sheet_to_json(workbook.Sheets["Categorias"]);
                const cats = catsSheet.map(c => c['Categoria']);
                saveDb(DB_CATEGORIAS, cats);
            }

            alert("‚úÖ Backup restaurado com sucesso!");
            
            location.reload();

        } catch (err) {
            console.error(err);
            alert("‚ùå Erro ao restaurar backup: " + err.message);
        }
    };

    reader.readAsArrayBuffer(file);
}

function mostrarLoading(texto) {
    const tela = document.getElementById('telaLoading');
    const textoEl = document.getElementById('loadingTexto');
    const barra = document.getElementById('loadingBarra');
    
    textoEl.textContent = texto;
    barra.style.width = '0%';
    tela.style.display = 'flex';
}

function atualizarLoading(texto, progresso) {
    const textoEl = document.getElementById('loadingTexto');
    const barra = document.getElementById('loadingBarra');
    
    textoEl.textContent = texto;
    barra.style.width = progresso + '%';
}

function esconderLoading() {
    document.getElementById('telaLoading').style.display = 'none';
}

function mostrarRelatorio(stats, detalhes, total) {
    const html = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #2d7a7a; margin-bottom: 15px;">üìà Resumo da Importa√ß√£o</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">NOVAS RESERVAS</div>
                    <div style="font-size: 28px; font-weight: 700; color: #28a745;">${stats.novas}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">REPETIDAS</div>
                    <div style="font-size: 28px; font-weight: 700; color: #ffc107;">${stats.repetidas}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">CANCELADAS</div>
                    <div style="font-size: 28px; font-weight: 700; color: #dc3545;">${stats.canceladas}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ATUALIZADAS</div>
                    <div style="font-size: 28px; font-weight: 700; color: #17a2b8;">${stats.atualizadas}</div>
                </div>
            </div>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h4 style="color: #333; margin-bottom: 10px;">üìã Detalhes (${detalhes.length} registros)</h4>
            <div style="max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px; font-size: 13px; line-height: 1.8;">
                ${detalhes.join('<br>')}
            </div>
        </div>
    `;
    
    document.getElementById('relatorioConteudo').innerHTML = html;
    document.getElementById('modalRelatorio').classList.add('active');
}

function fecharRelatorio() {
    document.getElementById('modalRelatorio').classList.remove('active');
}

async function carregarDespesasSupabase() {
    try {
        const { data, error } = await db
            .from("despesas")
            .select(`
                id,
                descricao,
                data,
                valor,
                unidades ( nome ),
                categorias_despesas ( nome )
            `)
            .order("data", { ascending: false });

        if (error) throw error;

       CACHE_DESPESAS = data.map(d => {
            const ano = d.data.substring(0,4);
            const mes = d.data.substring(5,7);

            return {
                id: d.id,
                descricao: d.descricao,
                unidade: d.unidades.nome,
                categoria: d.categorias_despesas.nome,
                data: d.data,
                ano: ano,
                mes: mes,
                mesAno: `${ano}-${mes}`,
                valor: Number(d.valor)
            };
        });

        return CACHE_DESPESAS;

    } catch (err) {
        console.error("Erro ao carregar despesas:", err);
        CACHE_DESPESAS = [];
        return [];
    }
}

async function alterarSenha() {
    const senhaAtual = document.getElementById('senhaAtual').value;
    const senhaNova = document.getElementById('senhaNova').value;
    const senhaConfirma = document.getElementById('senhaConfirma').value;
    
    // Valida√ß√µes
    if (!senhaAtual || !senhaNova || !senhaConfirma) {
        alert('‚ùå Preencha todos os campos!');
        return;
    }
    
    if (senhaNova !== senhaConfirma) {
        alert('‚ùå A nova senha e a confirma√ß√£o n√£o coincidem!');
        return;
    }
    
    if (senhaNova.length < 6) {
        alert('‚ùå A nova senha deve ter pelo menos 6 caracteres!');
        return;
    }
    
    try {
        // 1Ô∏è‚É£ Verifica senha atual
        const { data, error } = await db
            .from('configuracao')
            .select('senha_hash')
            .eq('id', 1)
            .single();
        
        if (error) {
            alert('‚ùå Erro ao verificar senha atual');
            console.error(error);
            return;
        }
        
        if (senhaAtual !== data.senha_hash) {
            alert('‚ùå Senha atual incorreta!');
            document.getElementById('senhaAtual').value = '';
            document.getElementById('senhaAtual').focus();
            return;
        }
        
        // 2Ô∏è‚É£ Atualiza para nova senha
        const { error: updateError } = await db
            .from('configuracao')
            .update({ senha_hash: senhaNova })
            .eq('id', 1);
        
        if (updateError) {
            alert('‚ùå Erro ao salvar nova senha');
            console.error(updateError);
            return;
        }
        
        // 3Ô∏è‚É£ Sucesso!
        alert('‚úÖ Senha alterada com sucesso!');
        
        // Limpa campos
        document.getElementById('senhaAtual').value = '';
        document.getElementById('senhaNova').value = '';
        document.getElementById('senhaConfirma').value = '';
        
    } catch (err) {
        console.error('Erro:', err);
        alert('‚ùå Erro ao alterar senha: ' + err.message);
    }
}

// ================================
// üìÖ FORMATAR DATA SEGURA (dd/mm)
// ================================
function formatarDataSegura(valor) {
    if (!valor) return "--/--";

    let data;

    // Se j√° for Date v√°lida
    if (valor instanceof Date && !isNaN(valor)) {
        data = valor;
    }
    // Se vier string
    else if (typeof valor === "string") {
        // aceita dd/mm ou dd/mm/yyyy
        const partes = valor.split("/");
        if (partes.length >= 2) {
            const dia = partes[0].padStart(2, "0");
            const mes = partes[1].padStart(2, "0");
            return `${dia}/${mes}`;
        }
        return "--/--";
    }
    // Se vier n√∫mero (Excel)
    else if (typeof valor === "number") {
        data = XLSX.SSF.parse_date_code(valor);
        if (!data) return "--/--";
        return `${String(data.d).padStart(2, "0")}/${String(data.m).padStart(2, "0")}`;
    } else {
        return "--/--";
    }

    if (isNaN(data)) return "--/--";

    return `${String(data.getDate()).padStart(2, "0")}/${String(data.getMonth() + 1).padStart(2, "0")}`;
}

function formatarReservaPadrao(reserva) {
    const inicio = formatarDataSegura(reserva.checkin || reserva.inicio);
    const fim = formatarDataSegura(reserva.checkout || reserva.fim);

    const nomeCompleto = (reserva.nome || "").trim();
    const primeiroNome = nomeCompleto.split(" ")[0] || "";

    const pessoas = Number(reserva.pessoas) || 0;

    return `${inicio} a ${fim} ${primeiroNome} ${pessoas}p`;
}

function formatarDataCurta(valor) {
    if (!valor) return "--/--";

    // Excel (n√∫mero)
    if (typeof valor === "number") {
        const d = XLSX.SSF.parse_date_code(valor);
        if (!d) return "--/--";
        return `${String(d.d).padStart(2, "0")}/${String(d.m).padStart(2, "0")}`;
    }

    // String dd/mm ou dd/mm/yyyy
    if (typeof valor === "string") {
        const p = valor.split("/");
        if (p.length >= 2) {
            return `${p[0].padStart(2, "0")}/${p[1].padStart(2, "0")}`;
        }
    }

    // Date
    if (valor instanceof Date && !isNaN(valor)) {
        return `${String(valor.getDate()).padStart(2, "0")}/${String(valor.getMonth() + 1).padStart(2, "0")}`;
    }

    return "--/--";
}

function primeiroNome(nome) {
    return (nome || "").trim().split(" ")[0] || "";
}


function normalizarDataTexto(valor) {
    if (!valor) return "--/--";

    if (typeof valor === "string") {
        // remove "Invalid Date"
        if (valor.toLowerCase().includes("invalid")) return "--/--";

        const p = valor.split("/");
        if (p.length >= 2) {
            return `${p[0].padStart(2, "0")}/${p[1].padStart(2, "0")}`;
        }
    }

    return "--/--";
}

function nomePrimeiro(nome) {
    return (nome || "").trim().split(" ")[0] || "";
}

function setupFiltrosDespesas() {
    const despesas = CACHE_DESPESAS || [];

    const anos = [...new Set(despesas.map(d => d.mesAno?.substring(0,4)).filter(Boolean))].sort();
    const meses = [...new Set(despesas.map(d => d.mesAno?.substring(5,7)).filter(Boolean))].sort();
    const unidades = [...new Set(despesas.map(d => d.unidade))].sort();

    const nomesMeses = {
        "01":"Janeiro","02":"Fevereiro","03":"Mar√ßo","04":"Abril",
        "05":"Maio","06":"Junho","07":"Julho","08":"Agosto",
        "09":"Setembro","10":"Outubro","11":"Novembro","12":"Dezembro"
    };

    $("#filtroDespesasAnos").html(
        anos.map(a => `<option value="${a}">${a}</option>`).join("")
    );

    $("#filtroDespesasMeses").html(
        meses.map(m => `<option value="${m}">${nomesMeses[m]}</option>`).join("")
    );

    $("#filtroDespesasUnidades").html(
        unidades.map(u => `<option value="${u}">${u}</option>`).join("")
    );

    $("#filtroDespesasAnos, #filtroDespesasMeses, #filtroDespesasUnidades").select2({
        placeholder: "Filtrar",
        allowClear: true
    });
}

function openUploadManualModal() {
    const anoAtual = new Date().getFullYear();
    document.getElementById('anoAtualMovi').textContent = anoAtual;
    document.getElementById("uploadManualModal").classList.add("active");
}

    </script>

<!-- üîÑ TELA DE LOADING -->
<div id="telaLoading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 500px;">
        <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
        <h2 style="color: #2d7a7a; margin-bottom: 10px;">Processando Reservas...</h2>
        <p id="loadingTexto" style="color: #666; font-size: 14px;">Analisando arquivo do Smoobu</p>
        <div style="margin-top: 20px; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div id="loadingBarra" style="background: #2d7a7a; height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
    </div>
</div>

<!-- üìä MODAL DE RELAT√ìRIO -->
<div id="modalRelatorio" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <div class="page-header">
            <h2>üìä Relat√≥rio de Importa√ß√£o</h2>
            <button style="background:none;border:none;font-size:24px;cursor:pointer;" onclick="fecharRelatorio()">√ó</button>
        </div>
        
        <div id="relatorioConteudo" style="font-size: 15px; line-height: 1.8;"></div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="fecharRelatorio()">
            Fechar
        </button>
    </div>
</div>
</body>
</html>
