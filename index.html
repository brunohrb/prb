<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<title>PRB ‚Ä¢ Pr√≥-Labore</title>
<style>
:root{ --azul:#1f3c88; --bg:#f3f5f9; --card:#ffffff; --texto:#333; --borda:#ddd; }
.dark{ --bg:#0f172a; --card:#020617; --texto:#e5e7eb; --borda:#334155; }
*{box-sizing:border-box}
body{ margin:0; background:var(--bg); color:var(--texto); font-family: Inter, Segoe UI, system-ui, -apple-system, Arial, sans-serif; }
.hidden{display:none!important}
.container{ max-width:1200px; margin:24px auto; background:var(--card); padding:28px; border-radius:22px; box-shadow:0 12px 30px rgba(0,0,0,.08); }
header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; padding-bottom:10px; border-bottom:1px solid rgba(0,0,0,0.05); }
.brand{display:flex;align-items:center;gap:14px}
.logo{ width:56px;height:56px;border-radius:14px; background:linear-gradient(135deg,var(--azul),#4f6bdc); color:#fff; display:flex;align-items:center;justify-content:center; font-weight:700;font-size:22px; box-shadow:0 6px 16px rgba(0,0,0,0.25); }
.grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:22px; }
@media(max-width:900px){ .grid{grid-template-columns:1fr} }
.card{ background:var(--card); border:none; border-radius:20px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,0.08); transition:transform 0.2s ease, box-shadow 0.2s ease; }
.card:hover{ transform:translateY(-3px); box-shadow:0 16px 40px rgba(0,0,0,0.12); }
.socio{text-align:center;font-weight:700;margin-bottom:12px}
.socio span{ border:2px solid var(--azul); border-radius:50px; padding:6px 18px; }
input,select,button{ padding:10px; font-size:14px; border-radius:12px; border:none; width:100%; background:rgba(0,0,0,0.02); color:var(--texto); margin-top: 8px; }
input:focus,select:focus{ outline:none; box-shadow:0 0 0 2px rgba(31,60,136,0.25); background:#fff; }
button{border:none;cursor:pointer; font-weight:600;}
.primary{background:var(--azul);color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.secondary{background:#64748b;color:#fff}
.danger{background:#c0392b;color:#fff}
.linha{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed var(--borda); font-size:14px; }
.acoes span{cursor:pointer;margin-left:10px}
.pos{color:#16a34a}
.neg{color:#dc2626}
.small{font-size:13px;color:#94a3b8}
.tabs{ display:flex; gap:6px; background:rgba(0,0,0,0.03); padding:6px; border-radius:14px; }
.tabs button{ padding:8px 14px; border-radius:10px; background:transparent; color:#64748b; margin-top:0; }
.tabs .active{ background:var(--azul); color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
.modal{ position:fixed;inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:1000; }
.modal-box{ background:var(--card); width:340px; padding:24px; border-radius:20px; }
.toggle{cursor:pointer;font-size:18px}
#loginScreen{ position: fixed; inset: 0; background: linear-gradient(135deg, #0056b3, #00bfff); z-index: 9999; display: flex; justify-content: center; align-items: center; }
.login-box{ background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 350px; }
.login-box h1{ color: #0056b3; margin-bottom: 10px; font-size: 26px; }
.login-box p{ color: #666; margin-bottom: 25px; font-size: 15px; }
.login-box input{ padding: 16px; border: 2px solid #eee; border-radius: 10px; width: 100%; margin-bottom: 18px; text-align: center; font-size: 18px; background: #fff; }
.login-box button{ background: #0056b3; color: white; border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; }
</style>
</head>
<body>
<div id="loginScreen">
  <div class="login-box">
    <h1>PRB Participa√ß√£o</h1>
    <p>Pr√≥-Labore</p>
    <input id="user" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha">
    <button onclick="login()">Entrar Agora</button>
  </div>
</div>
<div class="container hidden" id="app">
<header>
 <div class="brand">
  <div class="logo">PRB</div>
  <select id="mes" style="width:auto"></select>
  <select id="ano" style="width:auto"></select>
 </div>
 <div class="tabs">
  <button id="tabLanc" class="active" onclick="abrirAba('lanc')">Lan√ßamentos</button>
  <button id="tabInd" onclick="abrirAba('ind')">Indicadores</button>
  <button id="tabConf" onclick="abrirAba('conf')">Configura√ß√µes</button>
  <span class="toggle" onclick="toggleTema()" style="padding:8px">üåô</span>
  <button id="tabLog" onclick="abrirAba('log')">Logs</button>
 </div>
</header>
<div id="abaLanc">
 <div id="statusMes" class="small" style="margin-bottom:10px"></div>
 <div class="grid" id="cards"></div>
 <button class="secondary" onclick="alternarFechamento()" style="margin-top:20px">Fechar / Reabrir m√™s</button>
</div>
<div id="abaInd" class="hidden">
 <h3>Indicadores por ano</h3>
 <select id="anoIndicador" style="width:200px; margin-bottom:20px"></select>
 <div class="grid" id="indicadores"></div>
</div>
<div id="abaLog" class="hidden">
 <h3>Log de atividades</h3>
 <div class="card"><div id="listaLogs"></div></div>
</div>
<div id="abaConf" class="hidden">
 <h3>Configura√ß√µes</h3>
 <label class="small">Sal√°rio padr√£o (compet√™ncia atual)</label>
 <input id="salPadrao" oninput="mask(this)" placeholder="R$ 0,00">
 <div class="grid" style="margin-top:10px">
  <div><label class="small">Paulo</label><input id="sal_paulo" placeholder="Opcional" oninput="mask(this)"></div>
  <div><label class="small">Rafael</label><input id="sal_rafael" placeholder="Opcional" oninput="mask(this)"></div>
  <div><label class="small">Bruno</label><input id="sal_bruno" placeholder="Opcional" oninput="mask(this)"></div>
 </div>
 <button class="primary" onclick="salvarSalarios()" style="margin-top:20px">Salvar sal√°rios</button>
 <hr style="margin:30px 0; opacity:0.1">
 <h4>Alterar minha senha</h4>
 <input id="novaSenha" type="password" placeholder="Nova senha">
 <button class="primary" onclick="alterarSenha()">Alterar senha</button>
 <div style="margin-top:20px; display:flex; gap:10px">
  <button class="secondary" onclick="gerarBackupExcel()">üì§ Exportar Excel</button>
  <button class="danger" onclick="document.getElementById('inputRestoreExcel').click()">‚ôªÔ∏è Restaurar Excel</button>
 </div>
 <input type="file" id="inputRestoreExcel" accept=".xlsx" style="display:none" onchange="processarRestoreExcel(event)">
</div>
</div>
<div class="modal hidden" id="modal">
 <div class="modal-box">
  <h3>Editar lan√ßamento</h3>
  <input id="mdDesc" placeholder="Descri√ß√£o">
  <input id="mdValor" oninput="mask(this)" placeholder="R$ 0,00">
  <div style="display:flex; gap:10px; margin-top:20px">
    <button class="primary" onclick="salvarEdicao()">Salvar</button>
    <button class="secondary" onclick="fecharModal()">Cancelar</button>
  </div>
 </div>
</div>
<script>
const SUPABASE_URL = "https://xuwwgprchhfshrqdhuqn.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_HnqNNHIYrLbexVdrr-9DVA_gmprLLqe";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const cards = document.getElementById("cards");
const statusMes = document.getElementById("statusMes");
const mes = document.getElementById("mes");
const ano = document.getElementById("ano");
const indicadores = document.getElementById("indicadores");
const anoIndicador = document.getElementById("anoIndicador");
const modal = document.getElementById("modal");
const mdDesc = document.getElementById("mdDesc");
const mdValor = document.getElementById("mdValor");

const socios=["paulo","rafael","bruno"];
const gruposExtras = ["obras","familia"];
const entidades = [...socios, ...gruposExtras];
const meses=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const baseInicial={mes:11,ano:2025};
let edicao=null;
let lancamentosSupabase = {};
let estadoFechamento = {};

async function login() {
  const email = document.getElementById("user").value;
  const password = document.getElementById("pass").value;
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { alert("Erro: " + error.message); return; }
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").classList.remove("hidden");
  init();
}

async function init(){
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return;
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").classList.remove("hidden");
  mes.innerHTML = meses.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  let y = new Date().getFullYear();
  let anosHtml = "";
  for(let a = 2025; a <= y + 3; a++) anosHtml += `<option>${a}</option>`;
  ano.innerHTML = anosHtml;
  anoIndicador.innerHTML = anosHtml;
  mes.value = new Date().getMonth();
  ano.value = y;
  anoIndicador.value = y;
  mes.onchange = ano.onchange = async () => { await carregarLancamentos(); render(); };
  anoIndicador.onchange = renderIndicadores;
  aplicarTema();
  await carregarLancamentos();
  render();
}

async function carregarLancamentos() {
  const m = +mes.value, a = +ano.value;
  const { data, error } = await supabaseClient.from("lancamentos").select("*").eq("ano", a).eq("mes", m);
  if (error) return;
  lancamentosSupabase = {};
  entidades.forEach(e => lancamentosSupabase[e] = []);
  data.forEach(l => { if(lancamentosSupabase[l.socio]) lancamentosSupabase[l.socio].push(l); });
}

async function mesFechado() {
    const m = +mes.value, a = +ano.value;
    const { data } = await supabaseClient.from('fechamentos').select('fechado').eq('ano', a).eq('mes', m).single();
    estadoFechamento[`${a}-${m}`] = data ? data.fechado : false;
    return estadoFechamento[`${a}-${m}`];
}

async function alternarFechamento() {
    const m = +mes.value, a = +ano.value;
    const fechadoAtual = await mesFechado();
    const { error } = await supabaseClient.from('fechamentos').upsert({ ano: a, mes: m, fechado: !fechadoAtual }, { onConflict: 'ano, mes, user_id' });
    if (error) alert("Erro ao alterar status.");
    else { await registrarLog("FECHAMENTO", `M√™s ${m+1}/${a} ${!fechadoAtual ? 'FECHADO' : 'REABERTO'}`); render(); }
}

async function salarioBase(s, m, a) {
    let curM = m, curA = a;
    while (curA >= baseInicial.ano) {
        const { data: ind } = await supabaseClient.from('salarios').select('valor').eq('ano', curA).eq('mes', curM).eq('tipo', 'individual').eq('socio', s).single();
        if (ind) return ind.valor;
        const { data: pad } = await supabaseClient.from('salarios').select('valor').eq('ano', curA).eq('mes', curM).eq('tipo', 'padrao').single();
        if (pad) return pad.valor;
        curM--; if (curM < 0) { curM = 11; curA--; }
    }
    return 0;
}

async function calcularSaldoAnterior(s, m, a) {
    let pm = m - 1, pa = a;
    if (pm < 0) { pm = 11; pa--; }
    if (pa < baseInicial.ano || (pa === baseInicial.ano && pm < baseInicial.mes)) return 0;
    const base = await salarioBase(s, pm, pa);
    const { data } = await supabaseClient.from("lancamentos").select("valor").eq("socio", s).eq("ano", pa).eq("mes", pm);
    const gastos = data ? data.reduce((acc, l) => acc + l.valor, 0) : 0;
    const saldoAnteriorValor = await calcularSaldoAnterior(s, pm, pa);
    return base + saldoAnteriorValor - gastos;
}

async function render(){
  cards.innerHTML = "Carregando...";
  const m = +mes.value, a = +ano.value;
  const isFechado = await mesFechado();
  statusMes.innerHTML = isFechado ? "üîí M√™s fechado" : "üîì M√™s aberto";
  let html = "";
  for (const s of socios) {
    const arr = lancamentosSupabase[s] || [];
    const total = arr.reduce((x, y) => x + y.valor, 0);
    const base = await salarioBase(s, m, a);
    const prev = await calcularSaldoAnterior(s, m, a);
    const saldo = base + prev - total;
    html += `<div class="card"><div class="socio"><span>${s.toUpperCase()}</span></div>
      <div class="small">Sal√°rio: ${fmt(base)} | Saldo ant: <b class="${prev>=0?'pos':'neg'}">${fmt(prev)}</b></div>
      ${!isFechado ? `<input id="d_${s}" placeholder="Descri√ß√£o"><input id="v_${s}" placeholder="R$ 0,00" oninput="mask(this)"><button class="primary" onclick="add('${s}')">Adicionar</button>` : ""}
      <div style="margin-top:15px">${arr.map((r,i)=>`<div class="linha"><div>${r.desc}</div><div class="neg">${fmt(r.valor)}</div>
      ${!isFechado ? `<div class="acoes"><span onclick="excluir('${r.id}')">üóëÔ∏è</span></div>` : ""}</div>`).join("")}</div>
      <div class="small" style="margin-top:10px">Total: ${fmt(total)} | Saldo: <b class="${saldo>=0?'pos':'neg'}">${fmt(saldo)}</b></div></div>`;
  }
  for (const g of gruposExtras) {
    const arr = lancamentosSupabase[g] || [];
    const total = arr.reduce((x,y)=>x+y.valor,0);
    html += `<div class="card"><div class="socio"><span>${g.toUpperCase()}</span></div>
      ${!isFechado ? `<input id="d_${g}" placeholder="Descri√ß√£o"><input id="v_${g}" placeholder="R$ 0,00" oninput="mask(this)"><button class="primary" onclick="add('${g}')">Adicionar</button>` : ""}
      <div style="margin-top:15px">${arr.map((r,i)=>`<div class="linha"><div>${r.desc}</div><div class="neg">${fmt(r.valor)}</div>
      ${!isFechado ? `<div class="acoes"><span onclick="excluir('${r.id}')">üóëÔ∏è</span></div>` : ""}</div>`).join("")}</div>
      <div class="small" style="margin-top:10px">Total: <b class="neg">${fmt(total)}</b></div></div>`;
  }
  cards.innerHTML = html;
}

async function add(s) {
  const desc = document.getElementById("d_"+s).value;
  const valor = parseMoeda(document.getElementById("v_"+s).value);
  if(!desc || !valor) return;
  const { error } = await supabaseClient.from("lancamentos").insert({ socio: s, desc, valor, ano: +ano.value, mes: +mes.value, data: new Date().toISOString().split('T')[0] });
  if(error) alert("Erro ao salvar"); else { await registrarLog("ADD", `${s}: ${desc} - ${fmt(valor)}`); await carregarLancamentos(); render(); }
}

async function excluir(id) {
  if(!confirm("Excluir?")) return;
  await supabaseClient.from("lancamentos").delete().eq("id", id);
  await carregarLancamentos(); render();
}

async function salvarSalarios() {
  const m = +mes.value, a = +ano.value;
  const p = parseMoeda(document.getElementById("salPadrao").value);
  if(p > 0) await supabaseClient.from('salarios').upsert({ ano: a, mes: m, tipo: 'padrao', valor: p }, { onConflict: 'ano, mes, socio, tipo' });
  for(const s of socios) {
    const v = parseMoeda(document.getElementById("sal_"+s).value);
    if(v > 0) await supabaseClient.from('salarios').upsert({ ano: a, mes: m, tipo: 'individual', socio: s, valor: v }, { onConflict: 'ano, mes, socio, tipo' });
  }
  alert("Sal√°rios salvos!");
}

async function registrarLog(tipo, msg) {
  await supabaseClient.from("logs").insert({ tipo, mensagem: msg, usuario: (await supabaseClient.auth.getUser()).data.user.email });
}

async function renderLogs() {
  const { data } = await supabaseClient.from("logs").select("*").order("created_at", { ascending: false }).limit(50);
  document.getElementById("listaLogs").innerHTML = data ? data.map(l => `<div class="small"><b>${new Date(l.created_at).toLocaleString()}</b>: ${l.mensagem}</div>`).join("") : "Sem logs";
}

async function renderIndicadores() {
  const a = +anoIndicador.value;
  let html = "";
  for(const s of entidades) {
    const { data } = await supabaseClient.from("lancamentos").select("valor").eq("socio", s).eq("ano", a);
    const total = data ? data.reduce((acc, l) => acc + l.valor, 0) : 0;
    html += `<div class="card"><div class="socio"><span>${s.toUpperCase()}</span></div><b>Total: ${fmt(total)}</b></div>`;
  }
  indicadores.innerHTML = html;
}

function fmt(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); }
function parseMoeda(v){ return Number(v.replace(/\D/g,''))/100; }
function mask(i){
  let v = i.value.replace(/\D/g,'');
  v = (Number(v)/100).toLocaleString('pt-BR',{minimumFractionDigits:2});
  i.value = "R$ " + v;
}
function toggleTema(){ document.body.classList.toggle("dark"); localStorage.setItem("tema", document.body.classList.contains("dark")?"dark":"light"); }
function aplicarTema(){ if(localStorage.getItem("tema")==="dark") document.body.classList.add("dark"); }
function abrirAba(a){
  ["abaLanc","abaInd","abaConf","abaLog"].forEach(id => document.getElementById(id).classList.add("hidden"));
  ["tabLanc","tabInd","tabConf","tabLog"].forEach(id => document.getElementById(id).classList.remove("active"));
  document.getElementById("aba"+a.charAt(0).toUpperCase()+a.slice(1)).classList.remove("hidden");
  document.getElementById("tab"+a.charAt(0).toUpperCase()+a.slice(1)).classList.add("active");
  if(a==='log') renderLogs();
  if(a==='ind') renderIndicadores();
}
function fecharModal(){ modal.classList.add("hidden"); }

init();
</script>
</body>
</html>

