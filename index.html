<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<title>PRB ‚Ä¢ Pr√≥-Labore</title>
<style>
:root{ --azul:#1f3c88; --bg:#f3f5f9; --card:#ffffff; --texto:#333; --borda:#ddd; }
.dark{ --bg:#0f172a; --card:#020617; --texto:#e5e7eb; --borda:#334155; }
*{box-sizing:border-box}
body{ margin:0; background:var(--bg); color:var(--texto); font-family: Inter, Segoe UI, system-ui, -apple-system, Arial, sans-serif; }
.hidden{display:none!important}
.container{ max-width:1200px; margin:24px auto; background:var(--card); padding:28px; border-radius:22px; box-shadow:0 12px 30px rgba(0,0,0,.08); }
header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; padding-bottom:10px; border-bottom:1px solid rgba(0,0,0,0.05); }
.brand{display:flex;align-items:center;gap:14px}
.logo{ width:56px;height:56px;border-radius:14px; background:linear-gradient(135deg,var(--azul),#4f6bdc); color:#fff; display:flex;align-items:center;justify-content:center; font-weight:700;font-size:22px; box-shadow:0 6px 16px rgba(0,0,0,0.25); }
.grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:22px; }
@media(max-width:900px){ .grid{grid-template-columns:1fr} }
.card{ background:var(--card); border:none; border-radius:20px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,0.08); transition:transform 0.2s ease, box-shadow 0.2s ease; }
.card:hover{ transform:translateY(-3px); box-shadow:0 16px 40px rgba(0,0,0,0.12); }
.socio{text-align:center;font-weight:700;margin-bottom:12px}
.socio span{ border:2px solid var(--azul); border-radius:50px; padding:6px 18px; }
input,select,button{ padding:10px; font-size:14px; border-radius:12px; border:none; width:100%; background:rgba(0,0,0,0.02); color:var(--texto); margin-top: 8px; }
input:focus,select:focus{ outline:none; box-shadow:0 0 0 2px rgba(31,60,136,0.25); background:#fff; }
button{border:none;cursor:pointer; font-weight:600;}
.primary{background:var(--azul);color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.secondary{background:#64748b;color:#fff}
.danger{background:#c0392b;color:#fff}
.linha{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed var(--borda); font-size:14px; }
.acoes span{cursor:pointer;margin-left:10px}
.pos{color:#16a34a}
.neg{color:#dc2626}
.small{font-size:13px;color:#94a3b8}
.tabs{ display:flex; gap:6px; background:rgba(0,0,0,0.03); padding:6px; border-radius:14px; }
.tabs button{ padding:8px 14px; border-radius:10px; background:transparent; color:#64748b; margin-top:0; }
.tabs .active{ background:var(--azul); color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
.modal{ position:fixed;inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:1000; }
.modal-box{ background:var(--card); width:340px; padding:24px; border-radius:20px; }
.toggle{cursor:pointer;font-size:18px}
.div-area{background:rgba(31,60,136,0.05);padding:10px;border-radius:8px;margin:8px 0;display:none}
.div-area.show{display:block}
#loginScreen{ position: fixed; inset: 0; background: linear-gradient(135deg, #0056b3, #00bfff); z-index: 9999; display: flex; justify-content: center; align-items: center; }
.login-box{ background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 350px; }
.login-box h1{ color: #0056b3; margin-bottom: 10px; font-size: 26px; }
.login-box p{ color: #666; margin-bottom: 25px; font-size: 15px; }
.login-box input{ padding: 16px; border: 2px solid #eee; border-radius: 10px; width: 100%; margin-bottom: 18px; text-align: center; font-size: 18px; background: #fff; }
.login-box button{ background: #0056b3; color: white; border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; }

/* Estilos para filtros */
.filtros-container {
  background: rgba(31,60,136,0.05);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.filtro-grupo label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 13px;
  color: var(--azul);
}

.filtro-grupo select {
  width: 100%;
  margin-top: 4px;
}

.btn-filtro {
  align-self: flex-end;
  margin-bottom: 0;
}

/* Estilos para cards de resumo */
.cards-resumo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.card-resumo {
  background: linear-gradient(135deg, rgba(31,60,136,0.1), rgba(79,107,220,0.1));
  padding: 15px;
  border-radius: 12px;
  border-left: 4px solid var(--azul);
}

.card-resumo-titulo {
  font-size: 12px;
  color: #94a3b8;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 8px;
}

.card-resumo-valor {
  font-size: 22px;
  font-weight: 700;
  color: var(--azul);
}

.card-resumo-valor.pos {
  color: #16a34a;
}

.card-resumo-valor.neg {
  color: #dc2626;
}

/* Estilos para tabela em lista */
.historico-lista {
  background: var(--card);
  border-radius: 12px;
  overflow: hidden;
}

.unidade-grupo {
  border-bottom: 3px solid var(--borda);
  margin-bottom: 0;
}

.unidade-grupo:last-child {
  border-bottom: none;
}

.unidade-header {
  background: rgba(31,60,136,0.08);
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}

.unidade-header:hover {
  background: rgba(31,60,136,0.12);
}

.unidade-nome {
  font-weight: 700;
  color: var(--azul);
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.unidade-toggle {
  font-size: 18px;
  transition: transform 0.2s;
}

.unidade-toggle.collapsed {
  transform: rotate(-90deg);
}

.unidade-conteudo {
  display: table;
  width: 100%;
  border-collapse: collapse;
}

.unidade-conteudo.collapsed {
  display: none;
}

.linha-historico {
  display: table-row;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.linha-historico:hover {
  background: rgba(31,60,136,0.03);
}

.celula-historico {
  display: table-cell;
  padding: 12px 16px;
  font-size: 13px;
  border-right: 1px solid rgba(0,0,0,0.02);
}

.celula-historico:last-child {
  border-right: none;
}

.celula-tipo {
  font-weight: 600;
  color: #64748b;
  min-width: 120px;
}

.celula-valor {
  text-align: right;
  min-width: 100px;
  font-weight: 600;
}

.celula-valor.pos {
  color: #16a34a;
}

.celula-valor.neg {
  color: #dc2626;
}

/* Multi-select customizado */
.multi-select {
  position: relative;
  width: 100%;
}

.multi-select-input {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  padding: 6px 8px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  min-height: 36px;
}

.multi-select-tag {
  background: var(--azul);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.multi-select-tag button {
  background: none;
  border: none;
  color: #fff;
  cursor: pointer;
  padding: 0;
  margin: 0;
  font-size: 14px;
  width: auto;
}

.multi-select-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}

.multi-select-dropdown.show {
  display: block;
}

.multi-select-option {
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.multi-select-option:hover {
  background: rgba(31,60,136,0.08);
}

.multi-select-option input[type="checkbox"] {
  width: auto;
  margin: 0;
  cursor: pointer;
}
</style>
</head>
<body>
<div id="loginScreen">
  <div class="login-box">
    <h1>PRB Participa√ß√£o</h1>
    <p>Pr√≥-Labore</p>
    <input id="user" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha">
    <button onclick="login()">Entrar Agora</button>
  </div>
</div>
<div class="container hidden" id="app">
<header>
 <div class="brand">
  <div class="logo">PRB</div>
  <select id="mes" style="width:auto"></select>
  <select id="ano" style="width:auto"></select>
 </div>
 <div class="tabs">
  <button id="tabLanc" class="active" onclick="abrirAba('lanc')">Lan√ßamentos</button>
  <button id="tabHist" onclick="abrirAba('hist')">Hist√≥rico</button>
  <button id="tabInd" onclick="abrirAba('ind')">Indicadores</button>
  <button id="tabConf" onclick="abrirAba('conf')">Configura√ß√µes</button>
  <span class="toggle" onclick="toggleTema()" style="padding:8px">üåô</span>
  <button id="tabLog" onclick="abrirAba('log')">Logs</button>
   <button class="secondary" onclick="logout()">Sair</button>

 </div>
</header>
<div id="abaLanc">
 <div id="statusMes" class="small" style="margin-bottom:10px"></div>
 <div class="grid" id="cards"></div>
 <button class="secondary" onclick="alternarFechamento()" style="margin-top:20px">Fechar / Reabrir m√™s</button>
</div>
<div id="abaHist" class="hidden">
 <h3>Hist√≥rico em Lista</h3>
 <div class="filtros-container">
  <div class="filtro-grupo">
    <label>Unidades</label>
    <div id="filtroUnidades" class="multi-select"></div>
  </div>
  <div class="filtro-grupo">
    <label>M√™s</label>
    <select id="filtroMes" multiple style="height: 100px;"></select>
  </div>
  <div class="filtro-grupo">
    <label>Ano</label>
    <select id="filtroAno" multiple style="height: 100px;"></select>
  </div>
  <button class="primary btn-filtro" onclick="aplicarFiltros()">Filtrar</button>
 </div>
 
 <div class="cards-resumo" id="resumoFiltrado"></div>
 
 <div class="historico-lista" id="historicoLista"></div>
</div>
<div id="abaInd" class="hidden">
 <h3>Indicadores por ano</h3>
 <select id="anoIndicador" style="width:200px; margin-bottom:20px"></select>
 <div class="grid" id="indicadores"></div>
</div>
<div id="abaLog" class="hidden">
 <h3>Log de atividades</h3>
 <div class="card"><div id="listaLogs"></div></div>
</div>
<div id="abaConf" class="hidden">
 <h3>Configura√ß√µes</h3>
 <label class="small">Sal√°rio padr√£o (compet√™ncia atual)</label>
 <input id="salPadrao" oninput="mask(this)" placeholder="R$ 0,00">
 <div class="grid" style="margin-top:10px">
  <div><label class="small">Paulo</label><input id="sal_paulo" placeholder="Opcional" oninput="mask(this)"></div>
  <div><label class="small">Rafael</label><input
  id="v_${s}"
  placeholder="R$ 0,00 (valor TOTAL se parcelado)"
  inputmode="decimal"
  autocomplete="off"
  oninput="mask(this)">
</div>
  <div><label class="small">Bruno</label><input id="sal_bruno" placeholder="Opcional" oninput="mask(this)"></div>
 </div>
 <button class="primary" onclick="salvarSalarios()" style="margin-top:20px">Salvar sal√°rios</button>
 <hr style="margin:30px 0; opacity:0.1">
 <h4>Alterar minha senha</h4>
 <input id="novaSenha" type="password" placeholder="Nova senha">
 <button class="primary" onclick="alterarSenha()">Alterar senha</button>
 <div style="margin-top:20px; display:flex; gap:10px">
  <button class="secondary" onclick="gerarBackupExcel()">üì§ Exportar Excel</button>
  <button class="danger" onclick="document.getElementById('inputRestoreExcel').click()">‚ôªÔ∏è Restaurar Excel</button>
  <button class="secondary" onclick="document.getElementById('inputSmobuExcel').click()">üì• Importar SMOBU</button>
 </div>
 <input type="file" id="inputRestoreExcel" accept=".xlsx" style="display:none" onchange="processarRestoreExcel(event)">
 <input type="file" id="inputSmobuExcel" accept=".xlsx" style="display:none" onchange="processarSmobuExcel(event)">
</div>
</div>
<div class="modal hidden" id="modal">
 <div class="modal-box">
  <h3>Editar lan√ßamento</h3>
  <input id="mdDesc" placeholder="Descri√ß√£o">
  <input id="mdValor" oninput="mask(this)" placeholder="R$ 0,00">
  <div style="display:flex; gap:10px; margin-top:20px">
    <button class="primary" onclick="salvarEdicao()">Salvar</button>
    <button class="secondary" onclick="fecharModal()">Cancelar</button>
  </div>
 </div>
</div>
<script>
// ==========================================
// CONFIGURA√á√ÉO DO SUPABASE (COLE SUAS CHAVES AQUI)
// ==========================================
const SUPABASE_URL = "https://xuwwgprchhfshrqdhuqn.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_HnqNNHIYrLbexVdrr-9DVA_gmprLLqe";
// ==========================================

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  supabaseClient.auth.onAuthStateChange((event, session) => {
  console.log("Auth event:", event);

  if (event === "SIGNED_OUT") {
    document.getElementById("app").classList.add("hidden");
    document.getElementById("loginScreen").style.display = "flex";
    dadosCache = { lancamentos: [], salarios: [], fechamentos: [], smobu: [] };
  }

  if (event === "SIGNED_IN") {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("app").classList.remove("hidden");
    init();
  }
});


const cards = document.getElementById("cards");
const statusMes = document.getElementById("statusMes");
const mes = document.getElementById("mes");
const ano = document.getElementById("ano");
const indicadores = document.getElementById("indicadores");
const anoIndicador = document.getElementById("anoIndicador");
const modal = document.getElementById("modal");
const mdDesc = document.getElementById("mdDesc");
const mdValor = document.getElementById("mdValor");

const socios=["paulo","rafael","bruno"];
const gruposExtras = ["obras","familia"];
const entidades = [...socios, ...gruposExtras];
const meses=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const baseInicial={mes:11,ano:2025};

let dadosCache = {
  lancamentos: [],
  salarios: [],
  fechamentos: [],
  smobu: []
};

let filtrosAtivos = {
  unidades: [],
  meses: [],
  anos: []
};

async function login() {
  const email = document.getElementById("user").value.trim();
  const password = document.getElementById("pass").value.trim();
  if (!email || !password) { alert("Preencha e-mail e senha."); return; }
  await supabaseClient.auth.signOut();
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { alert("Erro ao entrar: " + error.message); return; }
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").classList.remove("hidden");
  init();
}

async function init(){
  const { data: { session } } = await supabaseClient.auth.getSession();

  if (!session) {
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("app").classList.add("hidden");
    return;
  }

  // for√ßa valida√ß√£o no banco
  const { data: usuarioSistema, error } = await supabaseClient
    .from("usuarios")
    .select("*")
    .eq("id", session.user.id)
    .single();

  if (error || !usuarioSistema) {
    alert("Usu√°rio n√£o autorizado.");
    await supabaseClient.auth.signOut();
    localStorage.clear();
    location.reload();
    return;
  }

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").classList.remove("hidden");
  mes.innerHTML = meses.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  let y = new Date().getFullYear();
  let anosHtml = "";
  for(let a = 2025; a <= y + 3; a++) anosHtml += `<option>${a}</option>`;
  ano.innerHTML = anosHtml;
  anoIndicador.innerHTML = anosHtml;
  
  // Preencher filtros de hist√≥rico
  document.getElementById("filtroMes").innerHTML = meses.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  document.getElementById("filtroAno").innerHTML = anosHtml;
  
  mes.value = new Date().getMonth();
  ano.value = y;
  anoIndicador.value = y;
  mes.onchange = ano.onchange = async () => { await carregarTudo(); render(); };
  anoIndicador.onchange = renderIndicadores;
  aplicarTema();
  await carregarTudo();
  render();
  inicializarFiltroUnidades();
}

async function carregarTudo() {
  const { data: lancs } = await supabaseClient.from("movimentacoes").select("*");
  const { data: sals } = await supabaseClient.from("salarios").select("*");
  const { data: fechs } = await supabaseClient.from("fechamentos").select("*");
  dadosCache.lancamentos = lancs || [];
  dadosCache.salarios = sals || [];
  dadosCache.fechamentos = fechs || [];
}

function obterSalarioBase(s, m, a) {
    let curM = m, curA = a;
    while (curA >= baseInicial.ano) {
        const ind = dadosCache.salarios.find(x => x.ano == curA && x.mes == curM && x.tipo == 'individual' && x.socio == s);
        if (ind) return ind.valor;
        const pad = dadosCache.salarios.find(x => x.ano == curA && x.mes == curM && x.tipo == 'padrao');
        if (pad) return pad.valor;
        curM--; if (curM < 0) { curM = 11; curA--; }
    }
    return 0;
}

function calcularSaldoAte(s, mesAlvo, anoAlvo) {
    let saldoAcumulado = 0;
    let curM = baseInicial.mes;
    let curA = baseInicial.ano;
    while (curA < anoAlvo || (curA == anoAlvo && curM < mesAlvo)) {
        const base = obterSalarioBase(s, curM, curA);
        const gastos = dadosCache.lancamentos.filter(l => l.socio === s && l.ano == curA && l.mes == curM).reduce((acc, l) => acc + l.valor, 0);
        saldoAcumulado += (base - gastos);
        curM++; if (curM > 11) { curM = 0; curA++; }
    }
    return saldoAcumulado;
}

async function render(){
  cards.innerHTML = "Processando...";
  const m = +mes.value, a = +ano.value;
  const fechadoObj = dadosCache.fechamentos.find(x => x.ano == a && x.mes == m);
  const isFechado = fechadoObj ? fechadoObj.fechado : false;
  statusMes.innerHTML = isFechado ? "üîí M√™s fechado" : "üîì M√™s aberto";
  let html = "";
  for (const s of socios) {
    const arr = dadosCache.lancamentos.filter(l => l.socio === s && l.ano == a && l.mes == m);
    const total = arr.reduce((x, y) => x + y.valor, 0);
    const base = obterSalarioBase(s, m, a);
    const prev = calcularSaldoAte(s, m, a);
    const saldo = base + prev - total;
    html += `<div class="card"><div class="socio"><span>${s.toUpperCase()}</span></div>
      <div class="small">Sal√°rio: ${fmt(base)} | Saldo ant: <b class="${prev>=0?'pos':'neg'}">${fmt(prev)}</b></div>
     ${!isFechado ? `
  <input id="d_${s}" placeholder="Descri√ß√£o">
  <input id="v_${s}" placeholder="R$ 0,00 (valor TOTAL se parcelado)" oninput="mask(this)">

  <label class="small">
<input type="checkbox" id="p_${s}" onclick="toggleParcelado('${s}')">
    Parcelado
  </label>

<div id="parc_${s}" class="small hidden">
    <input
      id="n_${s}"
      type="number"
      min="2"
      value="2"
      placeholder="N¬∫ parcelas"
    >
    <input id="m_${s}" type="month">
  </div>

  <label class="small">
<input type="checkbox" id="div_${s}" onclick="toggleDivisao('${s}')">
    Dividir despesa
  </label>

<div id="divarea_${s}" class="div-area">
    <select id="divpara_${s}">
      <option value="">Dividir com...</option>
      ${entidades.filter(e => e !== s).map(e => `<option value="${e}">${e.toUpperCase()}</option>`).join('')}
    </select>
    <input id="divval_${s}" placeholder="Valor a dividir" oninput="mask(this)">
    <input id="divdesc_${s}" placeholder="Descri√ß√£o da divis√£o">
  </div>

  <button class="primary" onclick="add('${s}')">OK</button>
` : ""}

      <div style="margin-top:15px">${arr.map(r=>`<div class="linha"><div>${r.desc}</div><div class="${r.valor < 0 ? 'pos' : 'neg'}">
  ${fmt(r.valor)}
</div>

      ${!isFechado ? `<div class="acoes"> <span onclick="abrirEditar('${r.id}')">‚úèÔ∏è</span>
  <span onclick="excluir('${r.id}')">üóëÔ∏è</span></div>` : ""}</div>`).join("")}</div>
      <div class="small" style="margin-top:10px">Total: ${fmt(total)} | Saldo: <b class="${saldo>=0?'pos':'neg'}">${fmt(saldo)}</b></div></div>`;
  }
  for (const g of gruposExtras) {
    const arr = dadosCache.lancamentos.filter(l => l.socio === g && l.ano == a && l.mes == m);
    const total = arr.reduce((x,y)=>x+y.valor,0);
    html += `<div class="card"><div class="socio"><span>${g.toUpperCase()}</span></div>
      ${!isFechado ? `<input id="d_${g}" placeholder="Descri√ß√£o"><input id="v_${g}" placeholder="R$ 0,00" oninput="mask(this)"><button class="primary" onclick="add('${g}')">Adicionar</button>` : ""}
      <div style="margin-top:15px">${arr.map(r=>`<div class="linha"><div>${r.desc}</div><div class="${r.valor < 0 ? 'pos' : 'neg'}">
  ${fmt(r.valor)}
</div>

      ${!isFechado ? `<div class="acoes"> <span onclick="abrirEditar('${r.id}')">‚úèÔ∏è</span>
  <span onclick="excluir('${r.id}')">üóëÔ∏è</span></div>` : ""}</div>`).join("")}</div>
      <div class="small" style="margin-top:10px">Total: <b class="neg">${fmt(total)}</b></div></div>`;
  }
  cards.innerHTML = html;
}

async function add(s) {
  const desc = document.getElementById("d_" + s).value;
  const valorTotal = parseMoeda(document.getElementById("v_" + s).value);
  const parcelado = document.getElementById("p_" + s)?.checked;

if (!desc) {
  alert("Preencha a descri√ß√£o");
  return;
}


  // VERIFICA SE TEM DIVIS√ÉO
  const temDivisao = document.getElementById("div_" + s)?.checked;
  const divPara = temDivisao ? document.getElementById("divpara_" + s).value : "";
  const divValor = temDivisao ? parseMoeda(document.getElementById("divval_" + s).value) : 0;
  const divDesc = temDivisao ? document.getElementById("divdesc_" + s).value.trim() : "";

  if (temDivisao && (!divPara || !divValor || !divDesc)) {
    alert("Preencha todos os campos da divis√£o");
    return;
  }

  // N√ÉO PARCELADO
  if (!parcelado) {
    // 1. LAN√áAMENTO PRINCIPAL (sa√≠da total)
    const { error } = await supabaseClient
      .from("movimentacoes")
      .insert([{
        socio: s,
        desc: desc,
        valor: valorTotal,
        ano: +ano.value,
        mes: +mes.value
      }]);

    if (error) {
      alert("Erro ao salvar lan√ßamento");
      console.error(error);
      return;
    }

    // 2. SE TEM DIVIS√ÉO, CRIA OS LAN√áAMENTOS
    if (temDivisao) {
      // 2a. ENTRADA para o s√≥cio que pagou (reembolso)
      await supabaseClient.from("movimentacoes").insert([{
        socio: s,
        desc: `Reembolso: ${divDesc}`,
        valor: -divValor,
        ano: +ano.value,
        mes: +mes.value
      }]);

      // 2b. SA√çDA para quem dividiu
      await supabaseClient.from("movimentacoes").insert([{
        socio: divPara,
        desc: divDesc,
        valor: divValor,
        ano: +ano.value,
        mes: +mes.value
      }]);
    }
  }

  // PARCELADO
  else {
    const parcelas = Number(document.getElementById("n_" + s).value);
    const mesIni = document.getElementById("m_" + s).value;

    if (!parcelas || parcelas < 2 || !mesIni) {
      alert("Informe parcelas e m√™s inicial");
      return;
    }

    const [anoIni, mesIniNum] = mesIni.split("-").map(Number);
    const valorParcela = +(valorTotal / parcelas).toFixed(2);

    for (let i = 0; i < parcelas; i++) {
      const dataObj = new Date(anoIni, (mesIniNum - 1) + i, 1);

      const y = dataObj.getFullYear();
      const m = dataObj.getMonth(); // 0 a 11

      const { error } = await supabaseClient
        .from("movimentacoes")
        .insert([{
          socio: s,
          desc: `${desc} (${i + 1}/${parcelas})`,
          valor: valorParcela,
          ano: y,
          mes: m
        }]);

      if (error) {
        alert("Erro ao salvar parcela");
        console.error(error);
        return;
      }
    }
  }

  // LIMPA CAMPOS
  document.getElementById("d_" + s).value = "";
  document.getElementById("v_" + s).value = "";
  if (document.getElementById("p_" + s)) document.getElementById("p_" + s).checked = false;
  if (document.getElementById("parc_" + s)) document.getElementById("parc_" + s).classList.add("hidden");
  if (document.getElementById("div_" + s)) document.getElementById("div_" + s).checked = false;
  if (document.getElementById("divarea_" + s)) document.getElementById("divarea_" + s).classList.remove("show");
const { data: { user } } = await supabaseClient.auth.getUser();

await registrarLog(
  "ADD",
  `${user.email} ‚Üí ${s.toUpperCase()} | ${desc} | ${fmt(valorTotal)}`
);


  await carregarTudo();
  render();
}

async function excluir(id) {
  const { data: { user } } = await supabaseClient.auth.getUser();
const usuarioEmail = user ? user.email : 'desconhecido';
  const lanc = dadosCache.lancamentos.find(l => l.id === id);
  if (!lanc) {
    alert("Lan√ßamento n√£o encontrado");
    return;
  }

  // verifica se parece parcelado pelo texto (1/3)
  const match = lanc.desc.match(/\((\d+)\/(\d+)\)$/);

  // N√ÉO PARCELADO
  if (!match) {
    if (!confirm("Excluir este lan√ßamento?")) return;

    await supabaseClient
      .from("movimentacoes")
      .delete()
      .eq("id", id);

 await registrarLog(
  "EXCLUIU",
  `${usuarioEmail} ‚Üí ${lanc.socio.toUpperCase()} | ${lanc.desc} | ${fmt(lanc.valor)}`
);

  
    
    await carregarTudo();
    render();
    return;
  }

  // PARCELADO
  const totalParcelas = Number(match[2]);

  const excluirTudo = confirm(
    `Este lan√ßamento faz parte de um parcelamento (${totalParcelas} parcelas).\n\n` +
    `OK = excluir TODAS as parcelas\n` +
    `Cancelar = excluir somente esta parcela`
  );

  if (excluirTudo) {
    // remove "(x/y)" do final
    const baseDesc = lanc.desc.replace(/\s*\(\d+\/\d+\)$/, "");

    await supabaseClient
      .from("movimentacoes")
      .delete()
      .ilike("desc", `${baseDesc}%`)
      .eq("socio", lanc.socio);

 await registrarLog(
  "EXCLUIU PARCELAMENTO",
  `${usuarioEmail} ‚Üí ${lanc.socio.toUpperCase()} | ${baseDesc}`
);
    
  } else {
    await supabaseClient
      .from("movimentacoes")
      .delete()
      .eq("id", id);
  }

  await carregarTudo();
  render();
}


async function alternarFechamento() {
    const m = +mes.value, a = +ano.value;
    const fechadoObj = dadosCache.fechamentos.find(x => x.ano == a && x.mes == m);
    const fechadoAtual = fechadoObj ? fechadoObj.fechado : false;
    const { error } = await supabaseClient.from('fechamentos').upsert({ ano: a, mes: m, fechado: !fechadoAtual }, { onConflict: 'ano, mes, user_id' });
    if (error) alert("Erro ao alterar status.");
    else { await registrarLog("FECHAMENTO", `M√™s ${m+1}/${a} ${!fechadoAtual ? 'FECHADO' : 'REABERTO'}`); await carregarTudo(); render(); }
}

async function salvarSalarios() {
  const m = +mes.value, a = +ano.value;
  const p = parseMoeda(document.getElementById("salPadrao").value);
  if(p > 0) await supabaseClient.from('salarios').upsert(
  { ano: a, mes: m, tipo: 'padrao', valor: p },
  { onConflict: 'ano, mes, tipo' }
);

  for(const s of socios) {
    const v = parseMoeda(document.getElementById("sal_"+s).value);
    if(v > 0) await supabaseClient.from('salarios').upsert({ ano: a, mes: m, tipo: 'individual', socio: s, valor: v }, { onConflict: 'ano, mes, socio, tipo' });
  }
  alert("Sal√°rios salvos!"); await carregarTudo();
}

async function registrarLog(acao, detalhes) {
  const { data: { user } } = await supabaseClient.auth.getUser();

  await supabaseClient
    .from("logs")
    .insert({
      acao: acao,
      detalhes: detalhes,
      usuario: user.id,
      usuario_nome: user.email
    });
}


async function renderLogs() {
  const { data } = await supabaseClient
    .from("logs")
    .select("*")
    .order("criado_em", { ascending: false })
    .limit(50);

  document.getElementById("listaLogs").innerHTML =
    data && data.length
      ? data.map(l => `
          <div class="small">
            <b>${new Date(l.criado_em).toLocaleString()}</b>
            ‚Äî <strong>${l.acao}</strong><br>
            ${l.detalhes}
          </div>
        `).join("")
      : "Sem logs";
}


async function renderIndicadores() {
  const a = +anoIndicador.value;
  let html = "";
  for(const s of entidades) {
    const total = dadosCache.lancamentos.filter(l => l.socio === s && l.ano == a).reduce((acc, l) => acc + l.valor, 0);
    html += `<div class="card"><div class="socio"><span>${s.toUpperCase()}</span></div><b>Total: ${fmt(total)}</b></div>`;
  }
  indicadores.innerHTML = html;
}

function inicializarFiltroUnidades() {
  const unidadesUnicas = [...new Set(dadosCache.smobu.map(s => s.unidade))].sort();
  const container = document.getElementById("filtroUnidades");
  
  let html = '<div class="multi-select-input" onclick="toggleDropdownUnidades(event)">';
  html += '<input type="text" placeholder="Selecione unidades..." readonly style="flex:1; border:none; background:none; cursor:pointer; margin:0; padding:0;">';
  html += '<div class="multi-select-dropdown">';
  
  unidadesUnicas.forEach(u => {
    html += `<label class="multi-select-option">
      <input type="checkbox" value="${u}" onchange="atualizarTagsUnidades()">
      <span>${u}</span>
    </label>`;
  });
  
  html += '</div></div>';
  container.innerHTML = html;
}

function toggleDropdownUnidades(e) {
  const dropdown = e.currentTarget.querySelector('.multi-select-dropdown');
  dropdown.classList.toggle('show');
}

function atualizarTagsUnidades() {
  const container = document.getElementById("filtroUnidades");
  const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
  const selecionadas = Array.from(checkboxes).map(c => c.value);
  
  let html = '<div class="multi-select-input" onclick="toggleDropdownUnidades(event)">';
  
  selecionadas.forEach(u => {
    html += `<div class="multi-select-tag">${u}<button onclick="removerUnidade('${u}')">√ó</button></div>`;
  });
  
  html += '<input type="text" placeholder="Selecione unidades..." readonly style="flex:1; border:none; background:none; cursor:pointer; margin:0; padding:0;">';
  html += '<div class="multi-select-dropdown">';
  
  const unidadesUnicas = [...new Set(dadosCache.smobu.map(s => s.unidade))].sort();
  unidadesUnicas.forEach(u => {
    const checked = selecionadas.includes(u) ? 'checked' : '';
    html += `<label class="multi-select-option">
      <input type="checkbox" value="${u}" ${checked} onchange="atualizarTagsUnidades()">
      <span>${u}</span>
    </label>`;
  });
  
  html += '</div></div>';
  container.innerHTML = html;
}

function removerUnidade(unidade) {
  const container = document.getElementById("filtroUnidades");
  const checkbox = container.querySelector(`input[value="${unidade}"]`);
  if (checkbox) {
    checkbox.checked = false;
    atualizarTagsUnidades();
  }
}

function aplicarFiltros() {
  const container = document.getElementById("filtroUnidades");
  const unidadesSelecionadas = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.value);
  const mesesSelecionados = Array.from(document.getElementById("filtroMes").selectedOptions).map(o => +o.value);
  const anosSelecionados = Array.from(document.getElementById("filtroAno").selectedOptions).map(o => +o.value);
  
  filtrosAtivos = {
    unidades: unidadesSelecionadas,
    meses: mesesSelecionados,
    anos: anosSelecionados
  };
  
  renderHistoricoFiltrado();
}

function renderHistoricoFiltrado() {
  let dadosFiltrados = dadosCache.smobu;
  
  if (filtrosAtivos.unidades.length > 0) {
    dadosFiltrados = dadosFiltrados.filter(d => filtrosAtivos.unidades.includes(d.unidade));
  }
  
  if (filtrosAtivos.meses.length > 0) {
    dadosFiltrados = dadosFiltrados.filter(d => filtrosAtivos.meses.includes(d.mes));
  }
  
  if (filtrosAtivos.anos.length > 0) {
    dadosFiltrados = dadosFiltrados.filter(d => filtrosAtivos.anos.includes(d.ano));
  }
  
  // Calcular resumo
  const resumo = {
    receitaTotal: 0,
    comissaoPais: 0,
    despesas: 0,
    lucro: 0
  };
  
  dadosFiltrados.forEach(d => {
    resumo.receitaTotal += d.receita_total || 0;
    resumo.comissaoPais += d.comissao_portais || 0;
    resumo.despesas += d.despesas || 0;
  });
  
  resumo.lucro = resumo.receitaTotal - resumo.comissaoPais - resumo.despesas;
  
  // Renderizar cards de resumo
  let htmlResumo = `
    <div class="card-resumo">
      <div class="card-resumo-titulo">Receita Total</div>
      <div class="card-resumo-valor">${fmt(resumo.receitaTotal)}</div>
    </div>
    <div class="card-resumo">
      <div class="card-resumo-titulo">Comiss√£o Portais</div>
      <div class="card-resumo-valor neg">${fmt(resumo.comissaoPais)}</div>
    </div>
    <div class="card-resumo">
      <div class="card-resumo-titulo">Despesas</div>
      <div class="card-resumo-valor neg">${fmt(resumo.despesas)}</div>
    </div>
    <div class="card-resumo">
      <div class="card-resumo-titulo">Lucro L√≠quido</div>
      <div class="card-resumo-valor ${resumo.lucro >= 0 ? 'pos' : 'neg'}">${fmt(resumo.lucro)}</div>
    </div>
  `;
  
  document.getElementById("resumoFiltrado").innerHTML = htmlResumo;
  
  // Agrupar por unidade
  const unidadesAgrupadas = {};
  dadosFiltrados.forEach(d => {
    if (!unidadesAgrupadas[d.unidade]) {
      unidadesAgrupadas[d.unidade] = [];
    }
    unidadesAgrupadas[d.unidade].push(d);
  });
  
  // Renderizar tabela
  let htmlTabela = '';
  Object.keys(unidadesAgrupadas).sort().forEach(unidade => {
    const dados = unidadesAgrupadas[unidade];
    const unidadeId = unidade.replace(/\s+/g, '_');
    
    htmlTabela += `
      <div class="unidade-grupo">
        <div class="unidade-header" onclick="toggleUnidade('${unidadeId}')">
          <div class="unidade-nome">
            <span class="unidade-toggle" id="toggle_${unidadeId}">‚ñº</span>
            ${unidade}
          </div>
        </div>
        <div class="unidade-conteudo" id="conteudo_${unidadeId}">
          <div class="linha-historico" style="font-weight:600; background:rgba(31,60,136,0.05);">
            <div class="celula-historico" style="min-width:120px;">Tipo</div>
            <div class="celula-historico" style="min-width:100px;">M√™s/Ano</div>
            <div class="celula-historico" style="min-width:100px; text-align:right;">Receita</div>
            <div class="celula-historico" style="min-width:100px; text-align:right;">Comiss√£o</div>
            <div class="celula-historico" style="min-width:100px; text-align:right;">Despesas</div>
            <div class="celula-historico" style="min-width:100px; text-align:right;">Lucro</div>
          </div>
    `;
    
    dados.forEach(d => {
      const lucro = (d.receita_total || 0) - (d.comissao_portais || 0) - (d.despesas || 0);
      htmlTabela += `
        <div class="linha-historico">
          <div class="celula-historico celula-tipo">Resumo</div>
          <div class="celula-historico">${meses[d.mes]}/${d.ano}</div>
          <div class="celula-historico celula-valor pos">${fmt(d.receita_total)}</div>
          <div class="celula-historico celula-valor neg">${fmt(d.comissao_portais)}</div>
          <div class="celula-historico celula-valor neg">${fmt(d.despesas)}</div>
          <div class="celula-historico celula-valor ${lucro >= 0 ? 'pos' : 'neg'}">${fmt(lucro)}</div>
        </div>
      `;
    });
    
    htmlTabela += `</div></div>`;
  });
  
  document.getElementById("historicoLista").innerHTML = htmlTabela || '<p style="padding:20px; text-align:center; color:#94a3b8;">Nenhum dado encontrado</p>';
}

function toggleUnidade(unidadeId) {
  const conteudo = document.getElementById(`conteudo_${unidadeId}`);
  const toggle = document.getElementById(`toggle_${unidadeId}`);
  
  conteudo.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
}

async function processarSmobuExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const dados = XLSX.utils.sheet_to_json(sheet);
      
      // Mapear colunas do Excel para o formato esperado
      const smobuDados = dados.map(row => ({
        unidade: row['UNIDADE'] || row['Unidade'] || '',
        mes: parseInt(row['MES'] || row['M√™s'] || '0') - 1, // Converter para 0-11
        ano: parseInt(row['ANO'] || row['Ano'] || new Date().getFullYear()),
        receita_total: parseFloat(row['RECEITA_TOTAL'] || row['Receita Total'] || '0'),
        comissao_portais: parseFloat(row['COMISSAO_PORTAIS'] || row['Comiss√£o Portais'] || '0'),
        despesas: parseFloat(row['DESPESAS'] || row['Despesas'] || '0')
      }));
      
      // Armazenar dados
      dadosCache.smobu = smobuDados;
      
      // Reinicializar filtros
      inicializarFiltroUnidades();
      
      alert(`${smobuDados.length} registros importados com sucesso!`);
    } catch (error) {
      alert('Erro ao processar arquivo: ' + error.message);
      console.error(error);
    }
  };
  reader.readAsArrayBuffer(file);
}

function fmt(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); }
function parseMoeda(v){
  if (!v) return 0;

  // detecta se √© negativo
  const negativo = v.includes('-');

  // remove tudo que n√£o for n√∫mero
  const num = Number(v.replace(/\D/g,'')) / 100;

  return negativo ? -num : num;
}

function mask(i){
  let v = i.value.replace(/[^\d-]/g,'');

  // garante s√≥ um sinal negativo no in√≠cio
  if (v.indexOf('-') > 0) {
    v = v.replace(/-/g,'');
  }

  const negativo = v.startsWith('-');
  v = v.replace('-','');

  let num = Number(v) / 100;
  if (negativo) num = -num;

  i.value = "R$ " + num.toLocaleString('pt-BR',{minimumFractionDigits:2});
}

function toggleTema(){ document.body.classList.toggle("dark"); localStorage.setItem("tema", document.body.classList.contains("dark")?"dark":"light"); }
function aplicarTema(){ if(localStorage.getItem("tema")==="dark") document.body.classList.add("dark"); }
function abrirAba(a){
  ["abaLanc","abaHist","abaInd","abaConf","abaLog"].forEach(id => document.getElementById(id).classList.add("hidden"));
  ["tabLanc","tabHist","tabInd","tabConf","tabLog"].forEach(id => document.getElementById(id).classList.remove("active"));
  document.getElementById("aba"+a.charAt(0).toUpperCase()+a.slice(1)).classList.remove("hidden");
  document.getElementById("tab"+a.charAt(0).toUpperCase()+a.slice(1)).classList.add("active");
  if(a==='log') renderLogs(); 
  if(a==='ind') renderIndicadores();
  if(a==='hist') renderHistoricoFiltrado();
}
function fecharModal(){ modal.classList.add("hidden"); }

  function abrirEditar(id){
  const lanc = dadosCache.lancamentos.find(l => l.id === id);
  if(!lanc) return alert("Lan√ßamento n√£o encontrado");

  mdDesc.value = lanc.desc;
  mdValor.value = fmt(lanc.valor);
  modal.classList.remove("hidden");

  modal.dataset.editId = id;
}

async function salvarEdicao(){
  const id = modal.dataset.editId;
  const desc = mdDesc.value;
  const valor = parseMoeda(mdValor.value);

  if(!desc || !valor) return alert("Preencha tudo");

  await supabaseClient
    .from("movimentacoes")
    .update({ desc, valor })
    .eq("id", id);

  modal.classList.add("hidden");
  await carregarTudo();
  render();
}

function toggleParcelado(s) {
  const chk = document.getElementById("p_" + s);
  const box = document.getElementById("parc_" + s);
  if (!chk || !box) return;

  if (chk.checked) {
    box.classList.remove("hidden");
  } else {
    box.classList.add("hidden");
  }
}

function toggleDivisao(s) {
  const chk = document.getElementById("div_" + s);
  const box = document.getElementById("divarea_" + s);
  if (!chk || !box) return;

  if (chk.checked) {
    box.classList.add("show");
  } else {
    box.classList.remove("show");
  }
}

 async function logout() {
  await supabaseClient.auth.signOut();
  location.reload();
}

document.addEventListener("DOMContentLoaded", async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();

  if (session) {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("app").classList.remove("hidden");
    init();
  } else {
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("app").classList.add("hidden");
  }
});

  async function gerarBackupExcel() {
  const wb = XLSX.utils.book_new();

  const wsLanc = XLSX.utils.json_to_sheet(
    dadosCache.lancamentos.map(l => ({
      ID: l.id,
      Socio: l.socio,
      Descricao: l.desc,
      Valor: l.valor,
      Mes: l.mes + 1,
      Ano: l.ano
    }))
  );
  XLSX.utils.book_append_sheet(wb, wsLanc, "Movimentacoes");

  const wsSal = XLSX.utils.json_to_sheet(
    dadosCache.salarios.map(s => ({
      Tipo: s.tipo,
      Socio: s.socio || "PADRAO",
      Valor: s.valor,
      Mes: s.mes + 1,
      Ano: s.ano
    }))
  );
  XLSX.utils.book_append_sheet(wb, wsSal, "Salarios");

  const wsFec = XLSX.utils.json_to_sheet(
    dadosCache.fechamentos.map(f => ({
      Mes: f.mes + 1,
      Ano: f.ano,
      Fechado: f.fechado ? "SIM" : "NAO"
    }))
  );
  XLSX.utils.book_append_sheet(wb, wsFec, "Fechamentos");

  const wsInfo = XLSX.utils.aoa_to_sheet([
    ["Backup do Pro-Labore"],
    ["Gerado em:", new Date().toLocaleString()],
    [""],
    ["Nao alterar nomes das abas"],
    ["Nao alterar nomes das colunas"],
    ["Arquivo usado para restauracao"]
  ]);
  XLSX.utils.book_append_sheet(wb, wsInfo, "LEIA-ME");

  XLSX.writeFile(wb, "backup_pro_labore.xlsx");
}

async function processarRestoreExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'array' });
      
      // Processar abas
      const wsMovimentacoes = workbook.Sheets['Movimentacoes'];
      const wsSalarios = workbook.Sheets['Salarios'];
      
      if (wsMovimentacoes) {
        const movimentacoes = XLSX.utils.sheet_to_json(wsMovimentacoes);
        for (const m of movimentacoes) {
          await supabaseClient.from('movimentacoes').insert({
            socio: m.Socio,
            desc: m.Descricao,
            valor: m.Valor,
            mes: m.Mes - 1,
            ano: m.Ano
          });
        }
      }
      
      if (wsSalarios) {
        const salarios = XLSX.utils.sheet_to_json(wsSalarios);
        for (const s of salarios) {
          const tipo = s.Tipo;
          const socio = s.Socio !== 'PADRAO' ? s.Socio : null;
          
          await supabaseClient.from('salarios').insert({
            tipo: tipo,
            socio: socio,
            valor: s.Valor,
            mes: s.Mes - 1,
            ano: s.Ano
          });
        }
      }
      
      alert('Dados restaurados com sucesso!');
      await carregarTudo();
      render();
    } catch (error) {
      alert('Erro ao restaurar: ' + error.message);
      console.error(error);
    }
  };
  reader.readAsArrayBuffer(file);
}
  
</script>
</body>
</html>
